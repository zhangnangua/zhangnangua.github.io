<!doctype html>
<html>

<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width initial-scale=1'>
    <title>Android 窗口机制</title>
    <link href='https://fonts.loli.net/css?family=Open+Sans:400italic,700italic,700,400&subset=latin,latin-ext'
        rel='stylesheet' type='text/css' />
    <style type='text/css'>
        html {
            overflow-x: initial !important;
        }

        :root {
            --bg-color: #ffffff;
            --text-color: #333333;
            --select-text-bg-color: #B5D6FC;
            --select-text-font-color: auto;
            --monospace: "Lucida Console", Consolas, "Courier", monospace;
            --title-bar-height: 20px;
        }

        .mac-os-11 {
            --title-bar-height: 28px;
        }

        html {
            font-size: 14px;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        body {
            margin: 0px;
            padding: 0px;
            height: auto;
            inset: 0px;
            font-size: 1rem;
            line-height: 1.42857143;
            overflow-x: hidden;
            background-image: inherit;
            background-size: inherit;
            background-attachment: inherit;
            background-origin: inherit;
            background-clip: inherit;
            background-color: inherit;
            tab-size: 4;
            background-position: inherit;
            background-repeat: inherit;
        }

        iframe {
            margin: auto;
        }

        a.url {
            word-break: break-all;
        }

        a:active,
        a:hover {
            outline: 0px;
        }

        .in-text-selection,
        ::selection {
            text-shadow: none;
            background: var(--select-text-bg-color);
            color: var(--select-text-font-color);
        }

        #write {
            margin: 0px auto;
            height: auto;
            width: inherit;
            word-break: normal;
            word-wrap: break-word;
            position: relative;
            white-space: normal;
            overflow-x: visible;
            padding-top: 36px;
        }

        #write.first-line-indent p {
            text-indent: 2em;
        }

        #write.first-line-indent li p,
        #write.first-line-indent p * {
            text-indent: 0px;
        }

        #write.first-line-indent li {
            margin-left: 2em;
        }

        .for-image #write {
            padding-left: 8px;
            padding-right: 8px;
        }

        body.typora-export {
            padding-left: 30px;
            padding-right: 30px;
        }

        .typora-export .footnote-line,
        .typora-export li,
        .typora-export p {
            white-space: pre-wrap;
        }

        .typora-export .task-list-item input {
            pointer-events: none;
        }

        @media screen and (max-width: 500px) {
            body.typora-export {
                padding-left: 0px;
                padding-right: 0px;
            }

            #write {
                padding-left: 20px;
                padding-right: 20px;
            }

            .CodeMirror-sizer {
                margin-left: 0px !important;
            }

            .CodeMirror-gutters {
                display: none !important;
            }
        }

        #write li>figure:last-child {
            margin-bottom: 0.5rem;
        }

        #write ol,
        #write ul {
            position: relative;
        }

        img {
            max-width: 100%;
            vertical-align: middle;
            image-orientation: from-image;
        }

        button,
        input,
        select,
        textarea {
            color: inherit;
            font-family: inherit;
            font-size: inherit;
            font-style: inherit;
            font-variant-caps: inherit;
            font-weight: inherit;
            font-stretch: inherit;
            line-height: inherit;
        }

        input[type="checkbox"],
        input[type="radio"] {
            line-height: normal;
            padding: 0px;
        }

        *,
        ::after,
        ::before {
            box-sizing: border-box;
        }

        #write h1,
        #write h2,
        #write h3,
        #write h4,
        #write h5,
        #write h6,
        #write p,
        #write pre {
            width: inherit;
        }

        #write h1,
        #write h2,
        #write h3,
        #write h4,
        #write h5,
        #write h6,
        #write p {
            position: relative;
        }

        p {
            line-height: inherit;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            break-after: avoid-page;
            break-inside: avoid;
            orphans: 4;
        }

        p {
            orphans: 4;
        }

        h1 {
            font-size: 2rem;
        }

        h2 {
            font-size: 1.8rem;
        }

        h3 {
            font-size: 1.6rem;
        }

        h4 {
            font-size: 1.4rem;
        }

        h5 {
            font-size: 1.2rem;
        }

        h6 {
            font-size: 1rem;
        }

        .md-math-block,
        .md-rawblock,
        h1,
        h2,
        h3,
        h4,
        h5,
        h6,
        p {
            margin-top: 1rem;
            margin-bottom: 1rem;
        }

        .hidden {
            display: none;
        }

        .md-blockmeta {
            color: rgb(204, 204, 204);
            font-weight: 700;
            font-style: italic;
        }

        a {
            cursor: pointer;
        }

        sup.md-footnote {
            padding: 2px 4px;
            background-color: rgba(238, 238, 238, 0.7);
            color: rgb(85, 85, 85);
            border-radius: 4px;
            cursor: pointer;
        }

        sup.md-footnote a,
        sup.md-footnote a:hover {
            color: inherit;
            text-transform: inherit;
            text-decoration: inherit;
        }

        #write input[type="checkbox"] {
            cursor: pointer;
            width: inherit;
            height: inherit;
        }

        figure {
            overflow-x: auto;
            margin: 1.2em 0px;
            max-width: calc(100% + 16px);
            padding: 0px;
        }

        figure>table {
            margin: 0px;
        }

        tr {
            break-inside: avoid;
            break-after: auto;
        }

        thead {
            display: table-header-group;
        }

        table {
            border-collapse: collapse;
            border-spacing: 0px;
            width: 100%;
            overflow: auto;
            break-inside: auto;
            text-align: left;
        }

        table.md-table td {
            min-width: 32px;
        }

        .CodeMirror-gutters {
            border-right-width: 0px;
            background-color: inherit;
        }

        .CodeMirror-linenumber {}

        .CodeMirror {
            text-align: left;
        }

        .CodeMirror-placeholder {
            opacity: 0.3;
        }

        .CodeMirror pre {
            padding: 0px 4px;
        }

        .CodeMirror-lines {
            padding: 0px;
        }

        div.hr:focus {
            cursor: none;
        }

        #write pre {
            white-space: pre-wrap;
        }

        #write.fences-no-line-wrapping pre {
            white-space: pre;
        }

        #write pre.ty-contain-cm {
            white-space: normal;
        }

        .CodeMirror-gutters {
            margin-right: 4px;
        }

        .md-fences {
            font-size: 0.9rem;
            display: block;
            break-inside: avoid;
            text-align: left;
            overflow: visible;
            white-space: pre;
            background-image: inherit;
            background-size: inherit;
            background-attachment: inherit;
            background-origin: inherit;
            background-clip: inherit;
            background-color: inherit;
            position: relative !important;
            background-position: inherit;
            background-repeat: inherit;
        }

        .md-diagram-panel {
            width: 100%;
            margin-top: 10px;
            text-align: center;
            padding-top: 0px;
            padding-bottom: 8px;
            overflow-x: auto;
        }

        #write .md-fences.mock-cm {
            white-space: pre-wrap;
        }

        .md-fences.md-fences-with-lineno {
            padding-left: 0px;
        }

        #write.fences-no-line-wrapping .md-fences.mock-cm {
            white-space: pre;
            overflow-x: auto;
        }

        .md-fences.mock-cm.md-fences-with-lineno {
            padding-left: 8px;
        }

        .CodeMirror-line,
        twitterwidget {
            break-inside: avoid;
        }

        .footnotes {
            opacity: 0.8;
            font-size: 0.9rem;
            margin-top: 1em;
            margin-bottom: 1em;
        }

        .footnotes+.footnotes {
            margin-top: 0px;
        }

        .md-reset {
            margin: 0px;
            padding: 0px;
            border: 0px;
            outline: 0px;
            vertical-align: top;
            text-decoration: none;
            text-shadow: none;
            float: none;
            position: static;
            width: auto;
            height: auto;
            white-space: nowrap;
            cursor: inherit;
            line-height: normal;
            font-weight: 400;
            text-align: left;
            box-sizing: content-box;
            direction: ltr;
            background-position: 0px 0px;
        }

        li div {
            padding-top: 0px;
        }

        blockquote {
            margin: 1rem 0px;
        }

        li .mathjax-block,
        li p {
            margin: 0.5rem 0px;
        }

        li blockquote {
            margin: 1rem 0px;
        }

        li {
            margin: 0px;
            position: relative;
        }

        blockquote> :last-child {
            margin-bottom: 0px;
        }

        blockquote> :first-child,
        li> :first-child {
            margin-top: 0px;
        }

        .footnotes-area {
            color: rgb(136, 136, 136);
            margin-top: 0.714rem;
            padding-bottom: 0.143rem;
            white-space: normal;
        }

        #write .footnote-line {
            white-space: pre-wrap;
        }

        @media print {

            body,
            html {
                border: 1px solid transparent;
                height: 99%;
                break-after: avoid;
                break-before: avoid;
                font-variant-ligatures: no-common-ligatures;
            }

            #write {
                margin-top: 0px;
                padding-top: 0px;
                border-color: transparent !important;
            }

            .typora-export * {
                print-color-adjust: exact;
            }

            .typora-export #write {
                break-after: avoid;
            }

            .typora-export #write::after {
                height: 0px;
            }

            .is-mac table {
                break-inside: avoid;
            }
        }

        .footnote-line {
            margin-top: 0.714em;
            font-size: 0.7em;
        }

        a img,
        img a {
            cursor: pointer;
        }

        pre.md-meta-block {
            font-size: 0.8rem;
            min-height: 0.8rem;
            white-space: pre-wrap;
            background-color: rgb(204, 204, 204);
            display: block;
            overflow-x: hidden;
        }

        p>.md-image:only-child:not(.md-img-error) img,
        p>img:only-child {
            display: block;
            margin: auto;
        }

        #write.first-line-indent p>.md-image:only-child:not(.md-img-error) img {
            left: -2em;
            position: relative;
        }

        p>.md-image:only-child {
            display: inline-block;
            width: 100%;
        }

        #write .MathJax_Display {
            margin: 0.8em 0px 0px;
        }

        .md-math-block {
            width: 100%;
        }

        .md-math-block:not(:empty)::after {
            display: none;
        }

        .MathJax_ref {
            fill: currentcolor;
        }

        [contenteditable="true"]:active,
        [contenteditable="true"]:focus,
        [contenteditable="false"]:active,
        [contenteditable="false"]:focus {
            outline: 0px;
            box-shadow: none;
        }

        .md-task-list-item {
            position: relative;
            list-style-type: none;
        }

        .task-list-item.md-task-list-item {
            padding-left: 0px;
        }

        .md-task-list-item>input {
            position: absolute;
            top: 0px;
            left: 0px;
            margin-left: -1.2em;
            margin-top: calc(1em - 10px);
            border: none;
        }

        .math {
            font-size: 1rem;
        }

        .md-toc {
            min-height: 3.58rem;
            position: relative;
            font-size: 0.9rem;
            border-radius: 10px;
        }

        .md-toc-content {
            position: relative;
            margin-left: 0px;
        }

        .md-toc-content::after,
        .md-toc::after {
            display: none;
        }

        .md-toc-item {
            display: block;
            color: rgb(65, 131, 196);
        }

        .md-toc-item a {
            text-decoration: none;
        }

        .md-toc-inner:hover {
            text-decoration: underline;
        }

        .md-toc-inner {
            display: inline-block;
            cursor: pointer;
        }

        .md-toc-h1 .md-toc-inner {
            margin-left: 0px;
            font-weight: 700;
        }

        .md-toc-h2 .md-toc-inner {
            margin-left: 2em;
        }

        .md-toc-h3 .md-toc-inner {
            margin-left: 4em;
        }

        .md-toc-h4 .md-toc-inner {
            margin-left: 6em;
        }

        .md-toc-h5 .md-toc-inner {
            margin-left: 8em;
        }

        .md-toc-h6 .md-toc-inner {
            margin-left: 10em;
        }

        @media screen and (max-width: 48em) {
            .md-toc-h3 .md-toc-inner {
                margin-left: 3.5em;
            }

            .md-toc-h4 .md-toc-inner {
                margin-left: 5em;
            }

            .md-toc-h5 .md-toc-inner {
                margin-left: 6.5em;
            }

            .md-toc-h6 .md-toc-inner {
                margin-left: 8em;
            }
        }

        a.md-toc-inner {
            font-size: inherit;
            font-style: inherit;
            font-weight: inherit;
            line-height: inherit;
        }

        .footnote-line a:not(.reversefootnote) {
            color: inherit;
        }

        .md-attr {
            display: none;
        }

        .md-fn-count::after {
            content: ".";
        }

        code,
        pre,
        samp,
        tt {
            font-family: var(--monospace);
        }

        kbd {
            margin: 0px 0.1em;
            padding: 0.1em 0.6em;
            font-size: 0.8em;
            color: rgb(36, 39, 41);
            background-color: rgb(255, 255, 255);
            border: 1px solid rgb(173, 179, 185);
            border-radius: 3px;
            box-shadow: rgba(12, 13, 14, 0.2) 0px 1px 0px, rgb(255, 255, 255) 0px 0px 0px 2px inset;
            white-space: nowrap;
            vertical-align: middle;
        }

        .md-comment {
            color: rgb(162, 127, 3);
            opacity: 0.8;
            font-family: var(--monospace);
        }

        code {
            text-align: left;
        }

        a.md-print-anchor {
            white-space: pre !important;
            border: none !important;
            display: inline-block !important;
            position: absolute !important;
            width: 1px !important;
            right: 0px !important;
            outline: 0px !important;
            text-shadow: initial !important;
            background-position: 0px 0px !important;
        }

        .md-inline-math .MathJax_SVG .noError {
            display: none !important;
        }

        .html-for-mac .inline-math-svg .MathJax_SVG {
            vertical-align: 0.2px;
        }

        .md-math-block .MathJax_SVG_Display {
            text-align: center;
            margin: 0px;
            position: relative;
            text-indent: 0px;
            max-width: none;
            max-height: none;
            min-height: 0px;
            min-width: 100%;
            width: auto;
            overflow-y: hidden;
            display: block !important;
        }

        .MathJax_SVG_Display,
        .md-inline-math .MathJax_SVG_Display {
            width: auto;
            margin: inherit;
            display: inline-block !important;
        }

        .MathJax_SVG .MJX-monospace {
            font-family: var(--monospace);
        }

        .MathJax_SVG .MJX-sans-serif {
            font-family: sans-serif;
        }

        .MathJax_SVG {
            display: inline;
            font-style: normal;
            font-weight: 400;
            line-height: normal;
            zoom: 90%;
            text-indent: 0px;
            text-align: left;
            text-transform: none;
            letter-spacing: normal;
            word-spacing: normal;
            word-wrap: normal;
            white-space: nowrap;
            float: none;
            direction: ltr;
            max-width: none;
            max-height: none;
            min-width: 0px;
            min-height: 0px;
            border: 0px;
            padding: 0px;
            margin: 0px;
        }

        .MathJax_SVG * {
            transition: none 0s ease 0s;
        }

        .MathJax_SVG_Display svg {
            vertical-align: middle !important;
            margin-bottom: 0px !important;
            margin-top: 0px !important;
        }

        .os-windows.monocolor-emoji .md-emoji {
            font-family: "Segoe UI Symbol", sans-serif;
        }

        .md-diagram-panel>svg {
            max-width: 100%;
        }

        [lang="flow"] svg,
        [lang="mermaid"] svg {
            max-width: 100%;
            height: auto;
        }

        [lang="mermaid"] .node text {
            font-size: 1rem;
        }

        table tr th {
            border-bottom-width: 0px;
        }

        video {
            max-width: 100%;
            display: block;
            margin: 0px auto;
        }

        iframe {
            max-width: 100%;
            width: 100%;
            border: none;
        }

        .highlight td,
        .highlight tr {
            border: 0px;
        }

        mark {
            background-color: rgb(255, 255, 0);
            color: rgb(0, 0, 0);
        }

        .md-html-inline .md-plain,
        .md-html-inline strong,
        mark .md-inline-math,
        mark strong {
            color: inherit;
        }

        mark .md-meta {
            color: rgb(0, 0, 0);
            opacity: 0.3 !important;
        }

        @media print {

            .typora-export h1,
            .typora-export h2,
            .typora-export h3,
            .typora-export h4,
            .typora-export h5,
            .typora-export h6 {
                break-inside: avoid;
            }
        }

        .md-diagram-panel .messageText {
            stroke: none !important;
        }

        .md-diagram-panel .start-state {
            fill: var(--node-fill);
        }

        .md-diagram-panel .edgeLabel rect {
            opacity: 1 !important;
        }

        .md-require-zoom-fix foreignObject {
            font-size: var(--mermaid-font-zoom);
        }


        .CodeMirror {
            height: auto;
        }

        .CodeMirror.cm-s-inner {
            background-image: inherit;
            background-size: inherit;
            background-attachment: inherit;
            background-origin: inherit;
            background-clip: inherit;
            background-color: inherit;
            background-position: inherit;
            background-repeat: inherit;
        }

        .CodeMirror-scroll {
            overflow: auto hidden;
            z-index: 3;
        }

        .CodeMirror-gutter-filler,
        .CodeMirror-scrollbar-filler {
            background-color: rgb(255, 255, 255);
        }

        .CodeMirror-gutters {
            border-right-width: 1px;
            border-right-style: solid;
            border-right-color: rgb(221, 221, 221);
            background-image: inherit;
            background-size: inherit;
            background-attachment: inherit;
            background-origin: inherit;
            background-clip: inherit;
            background-color: inherit;
            white-space: nowrap;
            background-position: inherit;
            background-repeat: inherit;
        }

        .CodeMirror-linenumber {
            padding: 0px 3px 0px 5px;
            text-align: right;
            color: rgb(153, 153, 153);
        }

        .cm-s-inner .cm-keyword {
            color: rgb(119, 0, 136);
        }

        .cm-s-inner .cm-atom,
        .cm-s-inner.cm-atom {
            color: rgb(34, 17, 153);
        }

        .cm-s-inner .cm-number {
            color: rgb(17, 102, 68);
        }

        .cm-s-inner .cm-def {
            color: rgb(0, 0, 255);
        }

        .cm-s-inner .cm-variable {
            color: rgb(0, 0, 0);
        }

        .cm-s-inner .cm-variable-2 {
            color: rgb(0, 85, 170);
        }

        .cm-s-inner .cm-variable-3 {
            color: rgb(0, 136, 85);
        }

        .cm-s-inner .cm-string {
            color: rgb(170, 17, 17);
        }

        .cm-s-inner .cm-property {
            color: rgb(0, 0, 0);
        }

        .cm-s-inner .cm-operator {
            color: rgb(152, 26, 26);
        }

        .cm-s-inner .cm-comment,
        .cm-s-inner.cm-comment {
            color: rgb(170, 85, 0);
        }

        .cm-s-inner .cm-string-2 {
            color: rgb(255, 85, 0);
        }

        .cm-s-inner .cm-meta {
            color: rgb(85, 85, 85);
        }

        .cm-s-inner .cm-qualifier {
            color: rgb(85, 85, 85);
        }

        .cm-s-inner .cm-builtin {
            color: rgb(51, 0, 170);
        }

        .cm-s-inner .cm-bracket {
            color: rgb(153, 153, 119);
        }

        .cm-s-inner .cm-tag {
            color: rgb(17, 119, 0);
        }

        .cm-s-inner .cm-attribute {
            color: rgb(0, 0, 204);
        }

        .cm-s-inner .cm-header,
        .cm-s-inner.cm-header {
            color: rgb(0, 0, 255);
        }

        .cm-s-inner .cm-quote,
        .cm-s-inner.cm-quote {
            color: rgb(0, 153, 0);
        }

        .cm-s-inner .cm-hr,
        .cm-s-inner.cm-hr {
            color: rgb(153, 153, 153);
        }

        .cm-s-inner .cm-link,
        .cm-s-inner.cm-link {
            color: rgb(0, 0, 204);
        }

        .cm-negative {
            color: rgb(221, 68, 68);
        }

        .cm-positive {
            color: rgb(34, 153, 34);
        }

        .cm-header,
        .cm-strong {
            font-weight: 700;
        }

        .cm-del {
            text-decoration: line-through;
        }

        .cm-em {
            font-style: italic;
        }

        .cm-link {
            text-decoration: underline;
        }

        .cm-error {
            color: red;
        }

        .cm-invalidchar {
            color: red;
        }

        .cm-constant {
            color: rgb(38, 139, 210);
        }

        .cm-defined {
            color: rgb(181, 137, 0);
        }

        div.CodeMirror span.CodeMirror-matchingbracket {
            color: rgb(0, 255, 0);
        }

        div.CodeMirror span.CodeMirror-nonmatchingbracket {
            color: rgb(255, 34, 34);
        }

        .cm-s-inner .CodeMirror-activeline-background {
            background-image: inherit;
            background-size: inherit;
            background-attachment: inherit;
            background-origin: inherit;
            background-clip: inherit;
            background-color: inherit;
            background-position: inherit;
            background-repeat: inherit;
        }

        .CodeMirror {
            position: relative;
            overflow: hidden;
        }

        .CodeMirror-scroll {
            height: 100%;
            outline: 0px;
            position: relative;
            box-sizing: content-box;
            background-image: inherit;
            background-size: inherit;
            background-attachment: inherit;
            background-origin: inherit;
            background-clip: inherit;
            background-color: inherit;
            background-position: inherit;
            background-repeat: inherit;
        }

        .CodeMirror-sizer {
            position: relative;
        }

        .CodeMirror-gutter-filler,
        .CodeMirror-hscrollbar,
        .CodeMirror-scrollbar-filler,
        .CodeMirror-vscrollbar {
            position: absolute;
            z-index: 6;
            display: none;
        }

        .CodeMirror-vscrollbar {
            right: 0px;
            top: 0px;
            overflow: hidden;
        }

        .CodeMirror-hscrollbar {
            bottom: 0px;
            left: 0px;
            overflow: hidden;
        }

        .CodeMirror-scrollbar-filler {
            right: 0px;
            bottom: 0px;
        }

        .CodeMirror-gutter-filler {
            left: 0px;
            bottom: 0px;
        }

        .CodeMirror-gutters {
            position: absolute;
            left: 0px;
            top: 0px;
            padding-bottom: 30px;
            z-index: 3;
        }

        .CodeMirror-gutter {
            white-space: normal;
            height: 100%;
            box-sizing: content-box;
            padding-bottom: 30px;
            margin-bottom: -32px;
            display: inline-block;
        }

        .CodeMirror-gutter-wrapper {
            position: absolute;
            z-index: 4;
            border: none !important;
            background-position: 0px 0px !important;
        }

        .CodeMirror-gutter-background {
            position: absolute;
            top: 0px;
            bottom: 0px;
            z-index: 4;
        }

        .CodeMirror-gutter-elt {
            position: absolute;
            cursor: default;
            z-index: 4;
        }

        .CodeMirror-lines {
            cursor: text;
        }

        .CodeMirror pre {
            border-radius: 0px;
            border-width: 0px;
            font-family: inherit;
            font-size: inherit;
            margin: 0px;
            white-space: pre;
            word-wrap: normal;
            color: inherit;
            z-index: 2;
            position: relative;
            overflow: visible;
            background-position: 0px 0px;
        }

        .CodeMirror-wrap pre {
            word-wrap: break-word;
            white-space: pre-wrap;
            word-break: normal;
        }

        .CodeMirror-code pre {
            border-right-width: 30px;
            border-right-style: solid;
            border-right-color: transparent;
            width: fit-content;
        }

        .CodeMirror-wrap .CodeMirror-code pre {
            border-right-style: none;
            width: auto;
        }

        .CodeMirror-linebackground {
            position: absolute;
            inset: 0px;
            z-index: 0;
        }

        .CodeMirror-linewidget {
            position: relative;
            z-index: 2;
            overflow: auto;
        }

        .CodeMirror-wrap .CodeMirror-scroll {
            overflow-x: hidden;
        }

        .CodeMirror-measure {
            position: absolute;
            width: 100%;
            height: 0px;
            overflow: hidden;
            visibility: hidden;
        }

        .CodeMirror-measure pre {
            position: static;
        }

        .CodeMirror div.CodeMirror-cursor {
            position: absolute;
            visibility: hidden;
            border-right-style: none;
            width: 0px;
        }

        .CodeMirror div.CodeMirror-cursor {
            visibility: hidden;
        }

        .CodeMirror-focused div.CodeMirror-cursor {
            visibility: inherit;
        }

        .cm-searching {
            background-color: rgba(255, 255, 0, 0.4);
        }

        @media print {
            .CodeMirror div.CodeMirror-cursor {
                visibility: hidden;
            }
        }


        :root {
            --side-bar-bg-color: #fafafa;
            --control-text-color: #777;
        }

        @include-when-export url(https://fonts.loli.net/css?family=Open+Sans:400italic,700italic,700,400&subset=latin,latin-ext);

        /* open-sans-regular - latin-ext_latin */
        /* open-sans-italic - latin-ext_latin */
        /* open-sans-700 - latin-ext_latin */
        /* open-sans-700italic - latin-ext_latin */
        html {
            font-size: 16px;
        }

        body {
            font-family: "Open Sans", "Clear Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
            color: rgb(51, 51, 51);
            line-height: 1.6;
        }

        #write {
            max-width: 860px;
            margin: 0 auto;
            padding: 30px;
            padding-bottom: 100px;
        }

        @media only screen and (min-width: 1400px) {
            #write {
                max-width: 1024px;
            }
        }

        @media only screen and (min-width: 1800px) {
            #write {
                max-width: 1200px;
            }
        }

        #write>ul:first-child,
        #write>ol:first-child {
            margin-top: 30px;
        }

        a {
            color: #4183C4;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            position: relative;
            margin-top: 1rem;
            margin-bottom: 1rem;
            font-weight: bold;
            line-height: 1.4;
            cursor: text;
        }

        h1:hover a.anchor,
        h2:hover a.anchor,
        h3:hover a.anchor,
        h4:hover a.anchor,
        h5:hover a.anchor,
        h6:hover a.anchor {
            text-decoration: none;
        }

        h1 tt,
        h1 code {
            font-size: inherit;
        }

        h2 tt,
        h2 code {
            font-size: inherit;
        }

        h3 tt,
        h3 code {
            font-size: inherit;
        }

        h4 tt,
        h4 code {
            font-size: inherit;
        }

        h5 tt,
        h5 code {
            font-size: inherit;
        }

        h6 tt,
        h6 code {
            font-size: inherit;
        }

        h1 {
            font-size: 2.25em;
            line-height: 1.2;
            border-bottom: 1px solid #eee;
        }

        h2 {
            font-size: 1.75em;
            line-height: 1.225;
            border-bottom: 1px solid #eee;
        }

        /*@media print {
    .typora-export h1,
    .typora-export h2 {
        border-bottom: none;
        padding-bottom: initial;
    }

    .typora-export h1::after,
    .typora-export h2::after {
        content: "";
        display: block;
        height: 100px;
        margin-top: -96px;
        border-top: 1px solid #eee;
    }
}*/

        h3 {
            font-size: 1.5em;
            line-height: 1.43;
        }

        h4 {
            font-size: 1.25em;
        }

        h5 {
            font-size: 1em;
        }

        h6 {
            font-size: 1em;
            color: #777;
        }

        p,
        blockquote,
        ul,
        ol,
        dl,
        table {
            margin: 0.8em 0;
        }

        li>ol,
        li>ul {
            margin: 0 0;
        }

        hr {
            height: 2px;
            padding: 0;
            margin: 16px 0;
            background-color: #e7e7e7;
            border: 0 none;
            overflow: hidden;
            box-sizing: content-box;
        }

        li p.first {
            display: inline-block;
        }

        ul,
        ol {
            padding-left: 30px;
        }

        ul:first-child,
        ol:first-child {
            margin-top: 0;
        }

        ul:last-child,
        ol:last-child {
            margin-bottom: 0;
        }

        blockquote {
            border-left: 4px solid #dfe2e5;
            padding: 0 15px;
            color: #777777;
        }

        blockquote blockquote {
            padding-right: 0;
        }

        table {
            padding: 0;
            word-break: initial;
        }

        table tr {
            border-top: 1px solid #dfe2e5;
            margin: 0;
            padding: 0;
        }

        table tr:nth-child(2n),
        thead {
            background-color: #f8f8f8;
        }

        table th {
            font-weight: bold;
            border: 1px solid #dfe2e5;
            border-bottom: 0;
            margin: 0;
            padding: 6px 13px;
        }

        table td {
            border: 1px solid #dfe2e5;
            margin: 0;
            padding: 6px 13px;
        }

        table th:first-child,
        table td:first-child {
            margin-top: 0;
        }

        table th:last-child,
        table td:last-child {
            margin-bottom: 0;
        }

        .CodeMirror-lines {
            padding-left: 4px;
        }

        .code-tooltip {
            box-shadow: 0 1px 1px 0 rgba(0, 28, 36, .3);
            border-top: 1px solid #eef2f2;
        }

        .md-fences,
        code,
        tt {
            border: 1px solid #e7eaed;
            background-color: #f8f8f8;
            border-radius: 3px;
            padding: 0;
            padding: 2px 4px 0px 4px;
            font-size: 0.9em;
        }

        code {
            background-color: #f3f4f4;
            padding: 0 2px 0 2px;
        }

        .md-fences {
            margin-bottom: 15px;
            margin-top: 15px;
            padding-top: 8px;
            padding-bottom: 6px;
        }


        .md-task-list-item>input {
            margin-left: -1.3em;
        }

        @media print {
            html {
                font-size: 13px;
            }

            table,
            pre {
                page-break-inside: avoid;
            }

            pre {
                word-wrap: break-word;
            }
        }

        .md-fences {
            background-color: #f8f8f8;
        }

        #write pre.md-meta-block {
            padding: 1rem;
            font-size: 85%;
            line-height: 1.45;
            background-color: #f7f7f7;
            border: 0;
            border-radius: 3px;
            color: #777777;
            margin-top: 0 !important;
        }

        .mathjax-block>.code-tooltip {
            bottom: .375rem;
        }

        .md-mathjax-midline {
            background: #fafafa;
        }

        #write>h3.md-focus:before {
            left: -1.5625rem;
            top: .375rem;
        }

        #write>h4.md-focus:before {
            left: -1.5625rem;
            top: .285714286rem;
        }

        #write>h5.md-focus:before {
            left: -1.5625rem;
            top: .285714286rem;
        }

        #write>h6.md-focus:before {
            left: -1.5625rem;
            top: .285714286rem;
        }

        .md-image>.md-meta {
            /*border: 1px solid #ddd;*/
            border-radius: 3px;
            padding: 2px 0px 0px 4px;
            font-size: 0.9em;
            color: inherit;
        }

        .md-tag {
            color: #a7a7a7;
            opacity: 1;
        }

        .md-toc {
            margin-top: 20px;
            padding-bottom: 20px;
        }

        .sidebar-tabs {
            border-bottom: none;
        }

        #typora-quick-open {
            border: 1px solid #ddd;
            background-color: #f8f8f8;
        }

        #typora-quick-open-item {
            background-color: #FAFAFA;
            border-color: #FEFEFE #e5e5e5 #e5e5e5 #eee;
            border-style: solid;
            border-width: 1px;
        }

        /** focus mode */
        .on-focus-mode blockquote {
            border-left-color: rgba(85, 85, 85, 0.12);
        }

        header,
        .context-menu,
        .megamenu-content,
        footer {
            font-family: "Segoe UI", "Arial", sans-serif;
        }

        .file-node-content:hover .file-node-icon,
        .file-node-content:hover .file-node-open-state {
            visibility: visible;
        }

        .mac-seamless-mode #typora-sidebar {
            background-color: #fafafa;
            background-color: var(--side-bar-bg-color);
        }

        .md-lang {
            color: #b4654d;
        }

        .html-for-mac .context-menu {
            --item-hover-bg-color: #E6F0FE;
        }

        #md-notification .btn {
            border: 0;
        }

        .dropdown-menu .divider {
            border-color: #e5e5e5;
        }

        .ty-preferences .window-content {
            background-color: #fafafa;
        }

        .ty-preferences .nav-group-item.active {
            color: white;
            background: #999;
        }

        :root {
            --mermaid-font-zoom: 1em;
        }
    </style>
</head>

<body class='typora-export'>
    <div id='write' class=''>
        <h1><a name="android-窗口机制-sdk31源码分析" class="md-header-anchor"></a><span>Android 窗口机制 SDK31源码分析</span></h1>
        <h2><a name="初识" class="md-header-anchor"></a><span>初识</span></h2>
        <blockquote>
            <p><span>接下来的几篇文章会详细的介绍窗口加载过程，本篇文章整体介绍Android 窗口类整体结构关系图。</span></p>
        </blockquote>
        <p><strong><span>窗口结构图</span></strong></p>
        <p><img src="E:\Documentation\My_Learn_Documentation_Git\android\pic_android\window_structure_diagram.png"
                style="zoom:50%;" /></p>
        <p><span>好像和大家平时看到的窗口架构图不一太一样是吧，因为我看到sdk31的源码里，</span><code>setContentView</code><span>会委托给</span><code>AppCompatDelegateImpl</code><span>的</span><code>setContentView</code><span>进行处理。而在</span><code>AppCompatDelegateImpl</code><span>的</span><code>setContentView</code><span>方法里面，额外添加了一层</span><code>SubDecor</code><span>。这一块大家可以先看看，之后都会进行详细的源码分析。</span>
        </p>
        <p><strong><span>概念说明介绍</span></strong></p>
        <blockquote>
            <p><span>这里大概介绍一下后续进行源码分析时涉及到的相关类以及作用</span></p>
        </blockquote>
        <ul>
            <li>
                <p><strong><span>PhoneWindow</span></strong></p>
                <p><span>每个Activity都会持有一个Window的实例，而这个实例具体的实现类就是PhoneWindow；</span></p>
                <p><span>PhoneWindow内部持有WindowManager以及DecorView</span></p>
            </li>
            <li>
                <p><strong><span>DecorView</span></strong></p>
                <p><span>DecorView继承自FramLayout，是当前Activity视图树的最顶层，它的作用是加载布局，被PhoneWindow持有。</span></p>
            </li>
            <li>
                <p><strong><span>ViewManager</span></strong></p>
                <p><span>ViewManager是activity中用来添加和移除View的接口，提供</span><code>addView</code><span>、</span><code>updateViewLayout</code><span>、</span><code>removeView</code><span>几个方法。</span>
                </p>
            </li>
            <li>
                <p><strong><span>WindowManager</span></strong></p>
                <p><span>它继承自ViewManager，也是一个接口。所以它具备添加、删除和更新View。</span></p>
                <p><span>WindowManagerImpl继承自WindowManager，但是具体却委托给了WindowsManagerGlobal来进行实现。</span></p>
                <p><span>所以具体的窗口管理功能是由WindowsManagerGlobal来进行的。</span></p>
            </li>
            <li>
                <p><strong><span>WindowManagerImpl</span></strong></p>
                <p><img src="E:\Documentation\My_Learn_Documentation_Git\android\pic_android\WindowManagerImpl.png"
                        referrerpolicy="no-referrer"></p>
                <p><span>WindowManager的具体实现，内部持有了</span><code>mGlobal</code><span>成员变量。它是WindowManagerGlobal类型的单例对象，具体的窗口管理功能是由WindowManagerGlobal来进行。</span>
                </p>
            </li>
            <li>
                <p><strong><span>WindowManagerGlobal</span></strong></p>
                <p><span>WindowManager具体的实现。内部包含重要的对象ViewRootImpl，ViewRootImpl作为</span></p>
            </li>
            <li>
                <p><strong><span>ViewRootImpl</span></strong></p>
                <p><span>ViewRootImpl 在 WindowManagerGlobal 调用 addView() 方法后初始化 ViewRootImpl。 </span></p>
                <p><span>ViewRootImpl除了执行我们熟知的performMeasure、performLayout、performDraw，另外它还执行事件分发，将事件首先分发到Activity。</span>
                </p>
            </li>
        </ul>
        <p><span>上面对窗口机制相关做了概述，下面进行详细的源码分析。</span></p>
        <h2><a name="decorview与subdecor的创建加载" class="md-header-anchor"></a><span>DecorView与SubDecor的创建加载</span></h2>
        <blockquote>
            <p><span>本篇文章介绍一下DecorView与SubDecor的创建初始化流程。</span></p>
            <p><span>了解一组概念，Window、PhoneWindow、DecorView、SubDecor.</span></p>
        </blockquote>
        <p><strong><span>Window</span></strong></p>
        <p><span>从前面的介绍中我们知道，每个Activity都会持有一个Window实例，那么Window究竟是什么呢？我们看一下源码以及介绍：</span></p>
        <pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"
            style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><span><span>​</span>x</span></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre>
    </div>
    <pre class=" CodeMirror-line "
        role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Abstract</span> <span class="cm-variable">base</span> <span class="cm-keyword">class</span> <span class="cm-keyword">for</span> <span class="cm-variable">a</span> <span class="cm-variable">top</span><span class="cm-operator">-</span><span class="cm-variable">level</span> <span class="cm-variable">window</span> <span class="cm-variable">look</span> <span class="cm-variable">and</span> <span class="cm-variable">behavior</span> <span class="cm-variable">policy</span>. <span class="cm-variable">An</span> <span class="cm-variable">instance</span> <span class="cm-variable">of</span> <span class="cm-keyword">this</span> <span class="cm-keyword">class</span> <span class="cm-def">should</span> <span class="cm-def">be</span> <span class="cm-def">used</span> <span class="cm-def">as</span> <span class="cm-def">the</span> <span class="cm-def">top</span><span class="cm-operator">-</span><span class="cm-variable">level</span> <span class="cm-variable">view</span> <span class="cm-variable">added</span> <span class="cm-variable">to</span> <span class="cm-variable">the</span> <span class="cm-variable">window</span> <span class="cm-variable">manager</span>. <span class="cm-variable">It</span> <span class="cm-variable">provides</span> <span class="cm-variable">standard</span> <span class="cm-variable">UI</span> <span class="cm-variable">policies</span> <span class="cm-variable">such</span> <span class="cm-variable">as</span> <span class="cm-variable">a</span> <span class="cm-variable">background</span>, <span class="cm-variable">title</span> <span class="cm-variable">area</span>, <span class="cm-keyword">default</span> <span class="cm-variable">key</span> <span class="cm-variable">processing</span>, <span class="cm-variable">etc</span>.</span></pre>
    <pre class=" CodeMirror-line "
        role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">The</span> <span class="cm-variable">only</span> <span class="cm-variable">existing</span> <span class="cm-variable">implementation</span> <span class="cm-variable">of</span> <span class="cm-keyword">this</span> <span class="cm-keyword">abstract</span> <span class="cm-keyword">class</span> <span class="cm-def">is</span> <span class="cm-def">android</span>.<span class="cm-variable">view</span>.<span class="cm-variable">PhoneWindow</span>, <span class="cm-variable">which</span> <span class="cm-variable">you</span> <span class="cm-variable">should</span> <span class="cm-variable">instantiate</span> <span class="cm-variable">when</span> <span class="cm-variable">needing</span> <span class="cm-variable">a</span> <span class="cm-variable">Window</span>.</span></pre>
    <pre class=" CodeMirror-line "
        role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">abstract</span> <span class="cm-keyword">class</span> <span class="cm-def">Window</span> {</span></pre>
    <pre class=" CodeMirror-line "
        role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  ...</span></pre>
    <pre class=" CodeMirror-line "
        role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">private</span> <span class="cm-variable">WindowManager</span> <span class="cm-variable">mWindowManager</span>;</span></pre>
    <pre class=" CodeMirror-line "
        role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  ...</span></pre>
    <pre class=" CodeMirror-line "
        role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;</span></pre>
    <pre class=" CodeMirror-line "
        role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">Convenience</span> <span class="cm-keyword">for</span> <span class="cm-variable">setContentView</span>(<span class="cm-variable">View</span>, <span class="cm-variable">ViewGroup</span>.<span class="cm-variable">LayoutParams</span>) <span class="cm-variable">to</span> <span class="cm-variable">set</span> <span class="cm-variable">the</span> <span class="cm-variable">screen</span> <span class="cm-variable">content</span> <span class="cm-variable">from</span> <span class="cm-variable">a</span> <span class="cm-variable">layout</span> <span class="cm-variable">resource</span>. <span class="cm-variable">The</span> <span class="cm-tab" role="presentation" cm-text="	"> </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">resource</span> <span class="cm-variable">will</span> <span class="cm-variable">be</span> <span class="cm-variable">inflated</span>, <span class="cm-variable">adding</span> <span class="cm-variable">all</span> <span class="cm-variable">top</span><span class="cm-operator">-</span><span class="cm-variable">level</span> <span class="cm-variable">views</span> <span class="cm-variable">to</span> <span class="cm-variable">the</span> <span class="cm-variable">screen</span>.</span></pre>
    <pre class=" CodeMirror-line "
        role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">Params</span>:</span></pre>
    <pre class=" CodeMirror-line "
        role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">layoutResID</span> <span class="cm-variable">–</span> <span class="cm-variable">Resource</span> <span class="cm-variable">ID</span> <span class="cm-variable">to</span> <span class="cm-variable">be</span> <span class="cm-variable">inflated</span>.</span></pre>
    <pre class=" CodeMirror-line "
        role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">See</span> <span class="cm-variable">Also</span>:</span></pre>
    <pre class=" CodeMirror-line "
        role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">setContentView</span>(<span class="cm-variable">View</span>, <span class="cm-variable">ViewGroup</span>.<span class="cm-variable">LayoutParams</span>)</span></pre>
    <pre class=" CodeMirror-line "
        role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">abstract</span> <span class="cm-variable-3">void</span> <span class="cm-variable">setContentView</span>(<span class="cm-meta">@LayoutRes</span> <span class="cm-variable-3">int</span> <span class="cm-variable">layoutResID</span>);</span></pre>
    <pre class=" CodeMirror-line "
        role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  ...</span></pre>
    <pre class=" CodeMirror-line "
        role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></pre>
    <pre class=" CodeMirror-line "
        role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre>
    </div>
    </div>
    </div>
    </div>
    </div>
    <div
        style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 462px;">
    </div>
    <div class="CodeMirror-gutters" style="display: none; height: 462px;"></div>
    </div>
    </div>
    </pre>
    <blockquote>
        <p><span>顶级窗口外观和行为策略的抽象基类，这个类的实例应该作为顶级视图被添加到窗口管理器，它提供了标准的 UI 策略，例如背景、标题区域、默认键处理等。</span></p>
        <p><span>此抽象类的唯一现有实现是 PhoneWindow，你应该在需要 Window 时对其进行实例化。</span></p>
    </blockquote>
    <p><span>显而易见，Window是一个抽象基类，它提供一系列窗口的方法，比如设置布局、背景、标题等等，它唯一的子类即为PhoneWindow。</span></p>
    <p><span>可以看到Window内部会持有WindowManager类型的全局变量</span><code>mWindowManager</code><span>。</span></p>
    <p><strong><span>PhoneWindow</span></strong></p>
    <pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded"
        lang="java"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre>
    </div>
    <div class="CodeMirror-measure"></div>
    <div style="position: relative; z-index: 1;"></div>
    <div class="CodeMirror-code" role="presentation" style="">
        <div class="CodeMirror-activeline" style="position: relative;">
            <div class="CodeMirror-activeline-background CodeMirror-linebackground"></div>
            <div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div>
            <pre class=" CodeMirror-line "
                role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">PhoneWindow</span> <span class="cm-keyword">extends</span> <span class="cm-variable">Window</span> <span class="cm-keyword">implements</span> <span class="cm-variable">MenuBuilder</span>.<span class="cm-variable">Callback</span> {</span></pre>
        </div>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// This is the top-level view of the window, containing the window decor.</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span class="cm-variable">DecorView</span> <span class="cm-variable">mDecor</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre>
    </div>
    </div>
    </div>
    </div>
    </div>
    <div
        style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 132px;">
    </div>
    <div class="CodeMirror-gutters" style="display: none; height: 132px;"></div>
    </div>
    </div>
    </pre>
    <p><span>PhoneWindow作为Window的唯一实现类，内部持有了DecorView。</span></p>
    <p><span>我们在Activity中，通过</span><code>getWindow()</code><span>方法获取到的就是PhoneWindow的实例。</span></p>
    <p><strong><span>DecorView</span></strong></p>
    <pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded"
        lang="java"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre>
    </div>
    <div class="CodeMirror-measure"></div>
    <div style="position: relative; z-index: 1;"></div>
    <div class="CodeMirror-code" role="presentation" style="">
        <div class="CodeMirror-activeline" style="position: relative;">
            <div class="CodeMirror-activeline-background CodeMirror-linebackground"></div>
            <div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div>
            <pre class=" CodeMirror-line "
                role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">DecorView</span> <span class="cm-keyword">extends</span> <span class="cm-variable">FrameLayout</span> <span class="cm-keyword">implements</span> <span class="cm-variable">RootViewSurfaceTaker</span>, <span class="cm-variable">WindowCallbacks</span> {</span></pre>
        </div>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span class="cm-keyword">final</span> <span class="cm-variable-3">int</span> <span class="cm-variable">mFeatureId</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span class="cm-keyword">final</span> <span class="cm-variable">Rect</span> <span class="cm-variable">mDrawingBounds</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">Rect</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span class="cm-keyword">final</span> <span class="cm-variable">Rect</span> <span class="cm-variable">mBackgroundPadding</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">Rect</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span>...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre>
    </div>
    </div>
    </div>
    </div>
    </div>
    <div
        style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 198px;">
    </div>
    <div class="CodeMirror-gutters" style="display: none; height: 198px;"></div>
    </div>
    </div>
    </pre>
    <p><span>显然DecorView是一个FrameLayout，它将作为最顶级的View，由PhoneWindow负责添加。</span></p>
    <p><strong><span>SubDecor</span></strong></p>
    <p><span>这个玩意儿是什么呢？如果你看大多数Android窗口分析的话，应该是没有这个东西的，但是现在自己去看代码的话应该能看到这个View。</span></p>
    <pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded"
        lang="java"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre>
    </div>
    <div class="CodeMirror-measure"></div>
    <div style="position: relative; z-index: 1;"></div>
    <div class="CodeMirror-code" role="presentation">
        <div class="CodeMirror-activeline" style="position: relative;">
            <div class="CodeMirror-activeline-background CodeMirror-linebackground"></div>
            <div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div>
            <pre class=" CodeMirror-line "
                role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//AppCompatDelegateImpl 里面创建SubDecor 的方法</span></span></pre>
        </div>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">private</span> <span class="cm-variable">ViewGroup</span> <span class="cm-def">createSubDecor</span>() {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre>
    </div>
    </div>
    </div>
    </div>
    </div>
    <div
        style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 66px;">
    </div>
    <div class="CodeMirror-gutters" style="display: none; height: 66px;"></div>
    </div>
    </div>
    </pre>
    <p><span>因为现在的源码</span><code>setContentView</code><span>的操作委托给了AppCompatDelegateImpl去操作，在这里面会创建一个SubDecor，类型是ViewGroup，添加到DecorView里面。所以如果是较新的Android版本的话，我们自己的布局其实是添加到SubDecor里面的。</span>
    </p>
    <p>&nbsp;</p>
    <p><span>那上面这些东西是如何进行关联呢？下面从</span><code>AppCompatActivity</code><span>的</span><code>setContentView</code><span>开始进行源码流程跟踪。</span><code>setContentView</code><span>方法有几个重载方法，分别可以传入</span><code>布局ID</code><span>或者</span><code>View</code><span>或者</span><code>布局ID+LayoutParams</code><span>，因为个人习惯使用ViewBinding，所以调用</span><code>setContentView</code><span>的话传进去的直接是View了，所以我们就分析接收View的这个重载方法。</span>
    </p>
    <pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded"
        lang="java"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre>
    </div>
    <div class="CodeMirror-measure"></div>
    <div style="position: relative; z-index: 1;"></div>
    <div class="CodeMirror-code" role="presentation">
        <div class="CodeMirror-activeline" style="position: relative;">
            <div class="CodeMirror-activeline-background CodeMirror-linebackground"></div>
            <div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div>
            <pre class=" CodeMirror-line "
                role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">AppCompatActivity</span> &nbsp; &nbsp;</span></pre>
        </div>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-def">setContentView</span>(<span class="cm-variable">View</span> <span class="cm-variable">view</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">getDelegate</span>().<span class="cm-variable">setContentView</span>(<span class="cm-variable">view</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre>
    </div>
    </div>
    </div>
    </div>
    </div>
    <div
        style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 88px;">
    </div>
    <div class="CodeMirror-gutters" style="display: none; height: 88px;"></div>
    </div>
    </div>
    </pre>
    <p><span>调用了</span><code>getDelegate().setContentView(view)</code><span>，而</span><code>getDelegate()</code><span>获取的就是</span><code>AppCompatDelegateImpl</code><span>，所以这里其实就是调用到了AppCompatDelegateImpl的</span><code>setContentView(view)</code><span>方法。</span>
    </p>
    <pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded"
        lang="java"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre>
    </div>
    <div class="CodeMirror-measure"></div>
    <div style="position: relative; z-index: 1;"></div>
    <div class="CodeMirror-code" role="presentation" style="">
        <div class="CodeMirror-activeline" style="position: relative;">
            <div class="CodeMirror-activeline-background CodeMirror-linebackground"></div>
            <div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div>
            <pre class=" CodeMirror-line "
                role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">AppCompatDelegateImpl</span></span></pre>
        </div>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-def">setContentView</span>(<span class="cm-variable">View</span> <span class="cm-variable">v</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">//构建SubDecor</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">ensureSubDecor</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">//将我们传进入的View添加进SubDecor</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">ViewGroup</span> <span class="cm-variable">contentParent</span> <span class="cm-operator">=</span> <span class="cm-variable">mSubDecor</span>.<span class="cm-variable">findViewById</span>(<span class="cm-variable">android</span>.<span class="cm-variable">R</span>.<span class="cm-variable">id</span>.<span class="cm-variable">content</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">contentParent</span>.<span class="cm-variable">removeAllViews</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">contentParent</span>.<span class="cm-variable">addView</span>(<span class="cm-variable">v</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">//通知内容改变</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">mAppCompatWindowCallback</span>.<span class="cm-variable">getWrapped</span>().<span class="cm-variable">onContentChanged</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre>
    </div>
    </div>
    </div>
    </div>
    </div>
    <div
        style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 242px;">
    </div>
    <div class="CodeMirror-gutters" style="display: none; height: 242px;"></div>
    </div>
    </div>
    </pre>
    <p><span>这里首先调用</span><code>ensureSubDecor</code><span>方法，构建</span><code>SubDecor</code><span>。之后将我们传进来的View添加到</span><code>SubDecor</code><span>内</span><strong><span>id为content</span></strong><span>的ViewGroup中。</span>
    </p>
    <p><span>所以我们看一下</span><code>ensureSubDecor</code><span>方法，看一下</span><code>SubDecor</code><span>是如何构建出来的。</span></p>
    <pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"
        style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre>
    </div>
    <div class="CodeMirror-measure"></div>
    <div style="position: relative; z-index: 1;"></div>
    <div class="CodeMirror-code" role="presentation" style="">
        <div class="CodeMirror-activeline" style="position: relative;">
            <div class="CodeMirror-activeline-background CodeMirror-linebackground"></div>
            <div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div>
            <pre class=" CodeMirror-line "
                role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">AppCompatDelegateImpl</span></span></pre>
        </div>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">private</span> <span class="cm-variable-3">void</span> <span class="cm-def">ensureSubDecor</span>() {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">//构建SubDecor 布局</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">mSubDecor</span> <span class="cm-operator">=</span> <span class="cm-variable">createSubDecor</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">//设置标题到mSubDecor布局  getTitle() 方法获取到的就是在AndroidManifest.xml 中给Activity设置的label， 通过这里设置到了Android原生主题的标题</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">CharSequence</span> <span class="cm-variable">title</span> <span class="cm-operator">=</span> <span class="cm-variable">getTitle</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-operator">!</span><span class="cm-variable">TextUtils</span>.<span class="cm-variable">isEmpty</span>(<span class="cm-variable">title</span>)) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">mDecorContentParent</span> <span class="cm-operator">!=</span> <span class="cm-atom">null</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mDecorContentParent</span>.<span class="cm-variable">setWindowTitle</span>(<span class="cm-variable">title</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">else</span> <span class="cm-keyword">if</span> (<span class="cm-variable">peekSupportActionBar</span>() <span class="cm-operator">!=</span> <span class="cm-atom">null</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">peekSupportActionBar</span>().<span class="cm-variable">setWindowTitle</span>(<span class="cm-variable">title</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">else</span> <span class="cm-keyword">if</span> (<span class="cm-variable">mTitleView</span> <span class="cm-operator">!=</span> <span class="cm-atom">null</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mTitleView</span>.<span class="cm-variable">setText</span>(<span class="cm-variable">title</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">//根据主题的宽高，比如windowFixedWidthMajor等，重新设置给mSubDecor布局容器。</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">applyFixedSizeWindow</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span>...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre>
    </div>
    </div>
    </div>
    </div>
    </div>
    <div
        style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 462px;">
    </div>
    <div class="CodeMirror-gutters" style="display: none; height: 462px;"></div>
    </div>
    </div>
    </pre>
    <p><span>上面的注释应该写的比较明确了，通过</span><code>createSubDecor</code><span>方法构建出了SubDecor，下面都是对SubDecor的一些设置，所以我们看一下</span><code>createSubDecor</code><span>方法。</span>
    </p>
    <pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"
        style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre>
    </div>
    <div class="CodeMirror-measure"></div>
    <div style="position: relative; z-index: 1;"></div>
    <div class="CodeMirror-code" role="presentation" style="">
        <div class="CodeMirror-activeline" style="position: relative;">
            <div class="CodeMirror-activeline-background CodeMirror-linebackground"></div>
            <div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div>
            <pre class=" CodeMirror-line "
                role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">AppCompatDelegateImpl</span></span></pre>
        </div>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">private</span> <span class="cm-variable">ViewGroup</span> <span class="cm-def">createSubDecor</span>() {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">//确保已经存在Window对象,否则抛异常</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">ensureWindow</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">//安装DecorView</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">mWindow</span>.<span class="cm-variable">getDecorView</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">//根据各种有无工具栏等设置subDecor布局</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">final</span> <span class="cm-variable">LayoutInflater</span> <span class="cm-variable">inflater</span> <span class="cm-operator">=</span> <span class="cm-variable">LayoutInflater</span>.<span class="cm-variable">from</span>(<span class="cm-variable">mContext</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">ViewGroup</span> <span class="cm-variable">subDecor</span> <span class="cm-operator">=</span> <span class="cm-atom">null</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  ... &nbsp; &nbsp; <span class="cm-comment">//列出其中一个布局，没有标题栏的</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">subDecor</span> <span class="cm-operator">=</span> (<span class="cm-variable">ViewGroup</span>) <span class="cm-variable">inflater</span>.<span class="cm-variable">inflate</span>(<span class="cm-variable">R</span>.<span class="cm-variable">layout</span>.<span class="cm-variable">abc_screen_simple</span>, <span class="cm-atom">null</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">//获取subDecor内的容器</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">final</span> <span class="cm-variable">ContentFrameLayout</span> <span class="cm-variable">contentView</span> <span class="cm-operator">=</span> (<span class="cm-variable">ContentFrameLayout</span>) <span class="cm-variable">subDecor</span>.<span class="cm-variable">findViewById</span>(</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">R</span>.<span class="cm-variable">id</span>.<span class="cm-variable">action_bar_activity_content</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">//获取DecorView内的容器</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">final</span> <span class="cm-variable">ViewGroup</span> <span class="cm-variable">windowContentView</span> <span class="cm-operator">=</span> (<span class="cm-variable">ViewGroup</span>) <span class="cm-variable">mWindow</span>.<span class="cm-variable">findViewById</span>(<span class="cm-variable">android</span>.<span class="cm-variable">R</span>.<span class="cm-variable">id</span>.<span class="cm-variable">content</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">windowContentView</span> <span class="cm-operator">!=</span> <span class="cm-atom">null</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span>...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//兼容：将原来的DecorView内部容器的id设置为NO_ID，将subDecor内部容器id设置为content。所以对于外层调用这来说通过content都可以获取到底层的容器。</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">windowContentView</span>.<span class="cm-variable">setId</span>(<span class="cm-variable">View</span>.<span class="cm-variable">NO_ID</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">contentView</span>.<span class="cm-variable">setId</span>(<span class="cm-variable">android</span>.<span class="cm-variable">R</span>.<span class="cm-variable">id</span>.<span class="cm-variable">content</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span>...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">//将subDecor添加到DecorView之中</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">mWindow</span>.<span class="cm-variable">setContentView</span>(<span class="cm-variable">subDecor</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span>...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">subDecor</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre>
    </div>
    </div>
    </div>
    </div>
    </div>
    <div
        style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 682px;">
    </div>
    <div class="CodeMirror-gutters" style="display: none; height: 682px;"></div>
    </div>
    </div>
    </pre>
    <p><span>注释的已经很清楚了吧，我们挑重点来看。首先是调用了</span><code>ensureWindow</code><span>方法，该方法主要判断Window对象是否存在，不存在则会抛出异常。接下来调用Window的</span><code>getDecorView</code><span>方法，去获取DecorView。之后就是使用</span><code>LayoutInflater</code><span>填充SubDecor，这里省略了很多判断布局，总之会根据主题设置有无标题等相关的进行布局填充，比如上述列出填充的布局为</span><code>abc_screen_simple</code><span>，该布局没有标题，有一个id为</span><code>action_bar_activity_content</code><span>的FramLayout，再下来将它的id更换为</span><code>content</code><span>。之后将SubDecor通过Window添加到DecorView之中。</span>
    </p>
    <p><span>简单分析一下我们需要关注的重点：</span></p>
    <ol start=''>
        <li><span>DecorView是如何安装的，看</span><code>getDecorView</code><span>方法。</span></li>
        <li><span>SubDecor是如何安装到DecorView的，看</span><code>setContentView</code><span>方法。</span></li>
    </ol>
    <p><span>好，接下来看一下Window的</span><code>getDecorView</code><span>方法。通过上面分析我们知道Window的唯一实现类为PhoneWindow，所以我们看PhoneWindow对应的方法。</span>
    </p>
    <pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"
        style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre>
    </div>
    <div class="CodeMirror-measure"></div>
    <div style="position: relative; z-index: 1;"></div>
    <div class="CodeMirror-code" role="presentation" style="">
        <div class="CodeMirror-activeline" style="position: relative;">
            <div class="CodeMirror-activeline-background CodeMirror-linebackground"></div>
            <div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div>
            <pre class=" CodeMirror-line "
                role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">PhoneWindow</span></span></pre>
        </div>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">final</span> <span class="cm-meta">@NonNull</span> <span class="cm-variable">View</span> <span class="cm-def">getDecorView</span>() {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">installDecor</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">mDecor</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span class="cm-variable-3">void</span> <span class="cm-def">installDecor</span>() {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mForceDecorInstall</span> <span class="cm-operator">=</span> <span class="cm-atom">false</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">mDecor</span> <span class="cm-operator">==</span> <span class="cm-atom">null</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//构建DecorView</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mDecor</span> <span class="cm-operator">=</span> <span class="cm-variable">generateDecor</span>(<span class="cm-operator">-</span><span class="cm-number">1</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">mContentParent</span> <span class="cm-operator">==</span> <span class="cm-atom">null</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//填充DecorView布局</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mContentParent</span> <span class="cm-operator">=</span> <span class="cm-variable">generateLayout</span>(<span class="cm-variable">mDecor</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">protected</span> <span class="cm-variable">DecorView</span> <span class="cm-variable">generateDecor</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">featureId</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment">//直接new </span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-keyword">return</span> <span class="cm-keyword">new</span> <span class="cm-variable">DecorView</span>(<span class="cm-variable">context</span>, <span class="cm-variable">featureId</span>, <span class="cm-keyword">this</span>, <span class="cm-variable">getAttributes</span>());</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">protected</span> <span class="cm-variable">ViewGroup</span> <span class="cm-variable">generateLayout</span>(<span class="cm-variable">DecorView</span> <span class="cm-variable">decor</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">//设置flag相关，所以这儿就是为什么falg的设置要在调用setContentView之前</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">a</span>.<span class="cm-variable">getBoolean</span>(<span class="cm-variable">R</span>.<span class="cm-variable">styleable</span>.<span class="cm-variable">Window_windowNoTitle</span>, <span class="cm-atom">false</span>)) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">requestFeature</span>(<span class="cm-variable">FEATURE_NO_TITLE</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">else</span> <span class="cm-keyword">if</span> (<span class="cm-variable">a</span>.<span class="cm-variable">getBoolean</span>(<span class="cm-variable">R</span>.<span class="cm-variable">styleable</span>.<span class="cm-variable">Window_windowActionBar</span>, <span class="cm-atom">false</span>)) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// Don't allow an action bar if there is no title.</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">requestFeature</span>(<span class="cm-variable">FEATURE_ACTION_BAR</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">a</span>.<span class="cm-variable">getBoolean</span>(<span class="cm-variable">R</span>.<span class="cm-variable">styleable</span>.<span class="cm-variable">Window_windowTranslucentStatus</span>,</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-atom">false</span>)) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">setFlags</span>(<span class="cm-variable">FLAG_TRANSLUCENT_STATUS</span>, <span class="cm-variable">FLAG_TRANSLUCENT_STATUS</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">&amp;</span> (<span class="cm-variable">~getForcedWindowFlags</span>()));</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">//和前面SubDecor一样，根据主题设置宽高等属性</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">a</span>.<span class="cm-variable">hasValue</span>(<span class="cm-variable">R</span>.<span class="cm-variable">styleable</span>.<span class="cm-variable">Window_windowFixedWidthMajor</span>)) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">mFixedWidthMajor</span> <span class="cm-operator">==</span> <span class="cm-atom">null</span>) <span class="cm-variable">mFixedWidthMajor</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">TypedValue</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">a</span>.<span class="cm-variable">getValue</span>(<span class="cm-variable">R</span>.<span class="cm-variable">styleable</span>.<span class="cm-variable">Window_windowFixedWidthMajor</span>,</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mFixedWidthMajor</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// DecorView 布局填充 &nbsp;</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">int</span> <span class="cm-variable">layoutResource</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  ...<span class="cm-tab" role="presentation" cm-text="	"> </span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//这里列出一个最简单的布局 一个title 一个id为content的Framelayout</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">layoutResource</span> <span class="cm-operator">=</span> <span class="cm-variable">R</span>.<span class="cm-variable">layout</span>.<span class="cm-variable">screen_simple</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mDecor</span>.<span class="cm-variable">onResourcesLoaded</span>(<span class="cm-variable">mLayoutInflater</span>, <span class="cm-variable">layoutResource</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">//ID_ANDROID_CONTENT 其实就是R.id.content</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">ViewGroup</span> <span class="cm-variable">contentParent</span> <span class="cm-operator">=</span> (<span class="cm-variable">ViewGroup</span>)<span class="cm-variable">findViewById</span>(<span class="cm-variable">ID_ANDROID_CONTENT</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">contentParent</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  } &nbsp; &nbsp; &nbsp; &nbsp;</span></pre>
    </div>
    </div>
    </div>
    </div>
    </div>
    <div
        style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 1276px;">
    </div>
    <div class="CodeMirror-gutters" style="display: none; height: 1276px;"></div>
    </div>
    </div>
    </pre>
    <p><span>注释应该也非常明显了，内部核心调用了</span><code>installDecor</code><span>进行DecorView的构建，</span><code>installDecor</code><span>内部调用了两个核心的方法，一个是</span><code>generateDecor</code><span>；一个是</span><code>generateLayout</code><span>。</span>
    </p>
    <p><span>根据上面所说，大家应该知道DecorView其实是一个FrameLayout，所以</span><code>generateDecor</code><span>方法其实直接new了一个</span><code>DecorView</code><span>返回了，并赋值给了mDecor变量。</span>
    </p>
    <p><span>而</span><code>generateLayout</code><span>其实就是根据主题各种判断去选择系统的布局，最终加载到了DecorView之中。那么DecorView就创建完成了。</span>
    </p>
    <p>&nbsp;</p>
    <p><span>那么DecorView和SubDecor是如何关联的呢？还记得在</span><code>createSubDecor</code><span>方法的最后调用了</span><code>mWindow.setContentView(subDecor)</code><span>吗？接下来我们看看这个方法干了什么吧。</span>
    </p>
    <pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"
        style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre>
    </div>
    <div class="CodeMirror-measure"></div>
    <div style="position: relative; z-index: 1;"></div>
    <div class="CodeMirror-code" role="presentation" style="">
        <div class="CodeMirror-activeline" style="position: relative;">
            <div class="CodeMirror-activeline-background CodeMirror-linebackground"></div>
            <div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div>
            <pre class=" CodeMirror-line "
                role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">PhoneWindow</span> &nbsp; </span></pre>
        </div>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-def">setContentView</span>(<span class="cm-variable">View</span> <span class="cm-variable">view</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">setContentView</span>(<span class="cm-variable">view</span>, <span class="cm-keyword">new</span> <span class="cm-variable">ViewGroup</span>.<span class="cm-variable">LayoutParams</span>(<span class="cm-variable">MATCH_PARENT</span>, <span class="cm-variable">MATCH_PARENT</span>));</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-def">setContentView</span>(<span class="cm-variable">View</span> <span class="cm-variable">view</span>, <span class="cm-variable">ViewGroup</span>.<span class="cm-variable">LayoutParams</span> <span class="cm-variable">params</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">mContentParent</span> <span class="cm-operator">==</span> <span class="cm-atom">null</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">installDecor</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">else</span> <span class="cm-keyword">if</span> (<span class="cm-operator">!</span><span class="cm-variable">hasFeature</span>(<span class="cm-variable">FEATURE_CONTENT_TRANSITIONS</span>)) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//在getDecorView方法中已经给mContentParent赋值了，所以走这里</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mContentParent</span>.<span class="cm-variable">removeAllViews</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">hasFeature</span>(<span class="cm-variable">FEATURE_CONTENT_TRANSITIONS</span>)) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">view</span>.<span class="cm-variable">setLayoutParams</span>(<span class="cm-variable">params</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">final</span> <span class="cm-variable">Scene</span> <span class="cm-variable">newScene</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">Scene</span>(<span class="cm-variable">mContentParent</span>, <span class="cm-variable">view</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">transitionTo</span>(<span class="cm-variable">newScene</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">else</span> {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//将SubDecor添加进DecorView的布局之中</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mContentParent</span>.<span class="cm-variable">addView</span>(<span class="cm-variable">view</span>, <span class="cm-variable">params</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">final</span> <span class="cm-variable">Callback</span> <span class="cm-variable">cb</span> <span class="cm-operator">=</span> <span class="cm-variable">getCallback</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">cb</span> <span class="cm-operator">!=</span> <span class="cm-atom">null</span> <span class="cm-operator">&amp;&amp;</span> <span class="cm-operator">!</span><span class="cm-variable">isDestroyed</span>()) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//回调通知表示完成界面改变</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">cb</span>.<span class="cm-variable">onContentChanged</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre>
    </div>
    </div>
    </div>
    </div>
    </div>
    <div
        style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 594px;">
    </div>
    <div class="CodeMirror-gutters" style="display: none; height: 594px;"></div>
    </div>
    </div>
    </pre>
    <p><span>显而易见，将SubDecor给添加到了DecorView之中。之后通知</span><code>Activity</code><span>界面已经完成改变，因为</span><code>Activity</code><span>实现了</span><code>Window.Callback</code><span>接口，是一个空实现，所以可以通过重写该方法来监听布局内容的改变。</span>
    </p>
    <pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded"
        lang="java"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre>
    </div>
    <div class="CodeMirror-measure"></div>
    <div style="position: relative; z-index: 1;"></div>
    <div class="CodeMirror-code" role="presentation">
        <div class="CodeMirror-activeline" style="position: relative;">
            <div class="CodeMirror-activeline-background CodeMirror-linebackground"></div>
            <div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div>
            <pre class=" CodeMirror-line "
                role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-def">onContentChanged</span>() {</span></pre>
        </div>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> }</span></pre>
    </div>
    </div>
    </div>
    </div>
    </div>
    <div
        style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 44px;">
    </div>
    <div class="CodeMirror-gutters" style="display: none; height: 44px;"></div>
    </div>
    </div>
    </pre>
    <p>&nbsp;</p>
    <p><span>所以总结一下，调用onCreate时，我们的Activity已经持有了Window对象，且通过调用</span><code>setContentView</code><span>方法，我们会现在PhoneWindow中根据主题构建DecorView，之后因为</span><code>compat</code><span>等原因，会构建SubDecor添加到DecorView之中，而我们设置的布局则会添加到SubDecor之中，并且被添加的布局id为content。比如通过</span><code>getWindow().getDecorView()</code><span>获取到的对象，就是PhoneWindow中的DecorView。</span>
    </p>
    <h2><a name="window与window-manager的创建加载" class="md-header-anchor"></a><span>Window与Window Manager的创建加载</span></h2>
    <blockquote>
        <p><span>上一章节我们知道了在调用setContentView方法之后发生的一些列过程，我们可以看到在Activity中已经持有了Window对象，那么他们是如何关联起来的呢？</span></p>
        <p><span>本章节进行详细的说明。</span></p>
    </blockquote>
    <p><strong><span>首先介绍几个类与接口</span></strong></p>
    <p><strong><span>ViewManager</span></strong></p>
    <pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded"
        lang="java"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre>
    </div>
    <div class="CodeMirror-measure"></div>
    <div style="position: relative; z-index: 1;"></div>
    <div class="CodeMirror-code" role="presentation" style="">
        <div class="CodeMirror-activeline" style="position: relative;">
            <div class="CodeMirror-activeline-background CodeMirror-linebackground"></div>
            <div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div>
            <pre class=" CodeMirror-line "
                role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">interface</span> <span class="cm-def">ViewManager</span>{</span></pre>
        </div>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-variable">addView</span>(<span class="cm-variable">View</span> <span class="cm-variable">view</span>, <span class="cm-variable">ViewGroup</span>.<span class="cm-variable">LayoutParams</span> <span class="cm-variable">params</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-variable">updateViewLayout</span>(<span class="cm-variable">View</span> <span class="cm-variable">view</span>, <span class="cm-variable">ViewGroup</span>.<span class="cm-variable">LayoutParams</span> <span class="cm-variable">params</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-variable">removeView</span>(<span class="cm-variable">View</span> <span class="cm-variable">view</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre>
    </div>
    </div>
    </div>
    </div>
    </div>
    <div
        style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 132px;">
    </div>
    <div class="CodeMirror-gutters" style="display: none; height: 132px;"></div>
    </div>
    </div>
    </pre>
    <p><span>ViewManager 是一组接口，允许向 Activity 添加和删除子视图的界面。</span></p>
    <p><span>比如我们常见的ViewGroup就实现了ViewManager，下面将要说到的WindowManager也继承了ViewManager。</span></p>
    <p><strong><span>WindowManager</span></strong></p>
    <pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded"
        lang="java"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre>
    </div>
    <div class="CodeMirror-measure"></div>
    <div style="position: relative; z-index: 1;"></div>
    <div class="CodeMirror-code" role="presentation" style="">
        <div class="CodeMirror-activeline" style="position: relative;">
            <div class="CodeMirror-activeline-background CodeMirror-linebackground"></div>
            <div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div>
            <pre class=" CodeMirror-line "
                role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//应用程序用来与窗口管理器对话的界面。使用 Context.getSystemService(Context.WINDOW_SERVICE) 获取其中之一。</span></span></pre>
        </div>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">interface</span> <span class="cm-def">WindowManager</span> <span class="cm-keyword">extends</span> <span class="cm-variable">ViewManager</span> {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">//则是addView时它的LayoutParams无效则会被抛出，或是添加第二个View的时候没有移除第一个View则会被抛出</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-keyword">class</span> <span class="cm-def">BadTokenException</span> <span class="cm-keyword">extends</span> <span class="cm-variable">RuntimeException</span>{...}</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">//如果一个窗口是在一个二级的显示上而指定的显示找不到则会被抛出</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-keyword">class</span> <span class="cm-def">InvalidDisplayException</span> <span class="cm-keyword">extends</span> <span class="cm-variable">RuntimeException</span>{...}</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">//返回当前WindowManager管理的显示Display</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable">Display</span> <span class="cm-variable">getDefaultDisplay</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">//表示从窗口上移除View，一般是当View调用了onDetachedFromWindow也就是从Window上分开后，进行移除</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-variable">removeViewImmediate</span>(<span class="cm-variable">View</span> <span class="cm-variable">view</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">//Window的布局参数</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-keyword">class</span> <span class="cm-def">LayoutParams</span> <span class="cm-keyword">extends</span> <span class="cm-variable">ViewGroup</span>.<span class="cm-variable">LayoutParams</span> <span class="cm-keyword">implements</span> <span class="cm-variable">Parcelable</span>{...}</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre>
    </div>
    </div>
    </div>
    </div>
    </div>
    <div
        style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 286px;">
    </div>
    <div class="CodeMirror-gutters" style="display: none; height: 286px;"></div>
    </div>
    </div>
    </pre>
    <p><span>一个接口，继承了ViewManager，所以便可以进行添加或者删除View的操作了。最终的实现类为WindowManagerImpl。</span></p>
    <p><span>在第一章我们就分析到了，WindowManager的实现类为WindowManagerImpl，但是在WindowManagerImpl内部将所有的操作都委托给了WindowManagerGlobal，这里我们在重复一下，加深印象。</span>
    </p>
    <p>&nbsp;</p>
    <p><strong><span>源码分析</span></strong></p>
    <p><span>好的，接下来进行源码分析，看一下Window、WindowManager和Activity是如何关联起来的吧。</span></p>
    <p><span>对于SDK31的源码，Activity的启动最终会调用到TransactionExecutor的</span><code>execute(ClientTransaction transaction)</code><span>方法，之后会依次调用ActivityThread的</span><code>handleLaunchActivity</code><span>、</span><code>handleStartActivity</code><span>、</span><code>handleResumeActivity</code><span>方法。</span>
    </p>
    <p><span>对于本次源码分析先省略掉其他步骤，直接到ActivityThread的</span><code>handleLaunchActivity</code><span>中查看源码。</span></p>
    <pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded"
        lang="java"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre>
    </div>
    <div class="CodeMirror-measure"></div>
    <div style="position: relative; z-index: 1;"></div>
    <div class="CodeMirror-code" role="presentation" style="">
        <div class="CodeMirror-activeline" style="position: relative;">
            <div class="CodeMirror-activeline-background CodeMirror-linebackground"></div>
            <div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div>
            <pre class=" CodeMirror-line "
                role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">ActivityThread</span></span></pre>
        </div>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-variable">Activity</span> <span class="cm-def">handleLaunchActivity</span>(<span class="cm-variable">ActivityClientRecord</span> <span class="cm-variable">r</span>,<span class="cm-variable">PendingTransactionActions</span> <span class="cm-variable">pendingActions</span>, <span class="cm-variable">Intent</span> <span class="cm-variable">customIntent</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span>...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">//初始化WindowManager服务</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">WindowManagerGlobal</span>.<span class="cm-variable">initialize</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">//调用performLaunchActivity</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">final</span> <span class="cm-variable">Activity</span> <span class="cm-variable">a</span> <span class="cm-operator">=</span> <span class="cm-variable">performLaunchActivity</span>(<span class="cm-variable">r</span>, <span class="cm-variable">customIntent</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">a</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre>
    </div>
    </div>
    </div>
    </div>
    </div>
    <div
        style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 264px;">
    </div>
    <div class="CodeMirror-gutters" style="display: none; height: 264px;"></div>
    </div>
    </div>
    </pre>
    <p><span>先初始化了WindowManagerService之后调用了</span><code>performLaunchActivity</code></p>
    <pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"
        style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre>
    </div>
    <div class="CodeMirror-measure"></div>
    <div style="position: relative; z-index: 1;"></div>
    <div class="CodeMirror-code" role="presentation" style="">
        <div class="CodeMirror-activeline" style="position: relative;">
            <div class="CodeMirror-activeline-background CodeMirror-linebackground"></div>
            <div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div>
            <pre class=" CodeMirror-line "
                role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">ActivityThread</span></span></pre>
        </div>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">private</span> <span class="cm-variable">Activity</span> <span class="cm-def">performLaunchActivity</span>(<span class="cm-variable">ActivityClientRecord</span> <span class="cm-variable">r</span>, <span class="cm-variable">Intent</span> <span class="cm-variable">customIntent</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">//创建与activity的context</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">ContextImpl</span> <span class="cm-variable">appContext</span> <span class="cm-operator">=</span> <span class="cm-variable">createBaseContextForActivity</span>(<span class="cm-variable">r</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">Activity</span> <span class="cm-variable">activity</span> <span class="cm-operator">=</span> <span class="cm-atom">null</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">try</span> {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">java</span>.<span class="cm-variable">lang</span>.<span class="cm-variable">ClassLoader</span> <span class="cm-variable">cl</span> <span class="cm-operator">=</span> <span class="cm-variable">appContext</span>.<span class="cm-variable">getClassLoader</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//通过classLoader实例化Activity，支持Activity对象创建出来了。</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">activity</span> <span class="cm-operator">=</span> <span class="cm-variable">mInstrumentation</span>.<span class="cm-variable">newActivity</span>(<span class="cm-variable">cl</span>, <span class="cm-variable">component</span>.<span class="cm-variable">getClassName</span>(), <span class="cm-variable">r</span>.<span class="cm-variable">intent</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">try</span> {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//创建/获取Application</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Application</span> <span class="cm-variable">app</span> <span class="cm-operator">=</span> <span class="cm-variable">r</span>.<span class="cm-variable">packageInfo</span>.<span class="cm-variable">makeApplication</span>(<span class="cm-atom">false</span>, <span class="cm-variable">mInstrumentation</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//判断获取保留的window</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Window</span> <span class="cm-variable">window</span> <span class="cm-operator">=</span> <span class="cm-atom">null</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">r</span>.<span class="cm-variable">mPendingRemoveWindow</span> <span class="cm-operator">!=</span> <span class="cm-atom">null</span> <span class="cm-operator">&amp;&amp;</span> <span class="cm-variable">r</span>.<span class="cm-variable">mPreserveWindow</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">window</span> <span class="cm-operator">=</span> <span class="cm-variable">r</span>.<span class="cm-variable">mPendingRemoveWindow</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">r</span>.<span class="cm-variable">mPendingRemoveWindow</span> <span class="cm-operator">=</span> <span class="cm-atom">null</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">r</span>.<span class="cm-variable">mPendingRemoveWindowManager</span> <span class="cm-operator">=</span> <span class="cm-atom">null</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//调用activity的attach方法 &nbsp;</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">activity</span>.<span class="cm-variable">attach</span>(<span class="cm-variable">appContext</span>, <span class="cm-keyword">this</span>, <span class="cm-variable">getInstrumentation</span>(), <span class="cm-variable">r</span>.<span class="cm-variable">token</span>,</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">r</span>.<span class="cm-variable">ident</span>, <span class="cm-variable">app</span>, <span class="cm-variable">r</span>.<span class="cm-variable">intent</span>, <span class="cm-variable">r</span>.<span class="cm-variable">activityInfo</span>, <span class="cm-variable">title</span>, <span class="cm-variable">r</span>.<span class="cm-variable">parent</span>,</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">r</span>.<span class="cm-variable">embeddedID</span>, <span class="cm-variable">r</span>.<span class="cm-variable">lastNonConfigurationInstances</span>, <span class="cm-variable">config</span>,</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">r</span>.<span class="cm-variable">referrer</span>, <span class="cm-variable">r</span>.<span class="cm-variable">voiceInteractor</span>, <span class="cm-variable">window</span>, <span class="cm-variable">r</span>.<span class="cm-variable">configCallback</span>,</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">r</span>.<span class="cm-variable">assistToken</span>, <span class="cm-variable">r</span>.<span class="cm-variable">shareableActivityToken</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//设置主题</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">int</span> <span class="cm-variable">theme</span> <span class="cm-operator">=</span> <span class="cm-variable">r</span>.<span class="cm-variable">activityInfo</span>.<span class="cm-variable">getThemeResource</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">theme</span> <span class="cm-operator">!=</span> <span class="cm-number">0</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">activity</span>.<span class="cm-variable">setTheme</span>(<span class="cm-variable">theme</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//回调Activity的onCreate，通过上一章的分析，我们知道在这里构建了DecorView且并Window持有。</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">r</span>.<span class="cm-variable">isPersistable</span>()) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mInstrumentation</span>.<span class="cm-variable">callActivityOnCreate</span>(<span class="cm-variable">activity</span>, <span class="cm-variable">r</span>.<span class="cm-variable">state</span>, <span class="cm-variable">r</span>.<span class="cm-variable">persistentState</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">else</span> {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mInstrumentation</span>.<span class="cm-variable">callActivityOnCreate</span>(<span class="cm-variable">activity</span>, <span class="cm-variable">r</span>.<span class="cm-variable">state</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//设置生命周期状态</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">r</span>.<span class="cm-variable">setState</span>(<span class="cm-variable">ON_CREATE</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">activity</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre>
    </div>
    </div>
    </div>
    </div>
    </div>
    <div
        style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 968px;">
    </div>
    <div class="CodeMirror-gutters" style="display: none; height: 968px;"></div>
    </div>
    </div>
    </pre>
    <p><span>上面的注释还是挺清楚的，我们梳理一下这个方法大概做了什么事情，首先创建当前Activity的Context，通过ClassLoader构建出Activity，然后获取Application，接下来传入了一系列参数调用了Activity的attach方法，最后会调用Activity的onCreate以及设置一些主题生命周期等相关的属性。</span>
    </p>
    <p><span>所以进入Activity的attach方法，看看做了什么</span></p>
    <pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"
        style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre>
    </div>
    <div class="CodeMirror-measure"></div>
    <div style="position: relative; z-index: 1;"></div>
    <div class="CodeMirror-code" role="presentation" style="">
        <div class="CodeMirror-activeline" style="position: relative;">
            <div class="CodeMirror-activeline-background CodeMirror-linebackground"></div>
            <div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div>
            <pre class=" CodeMirror-line "
                role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Activity</span></span></pre>
        </div>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">final</span> <span class="cm-variable-3">void</span> <span class="cm-def">attach</span>(<span class="cm-variable">Context</span> <span class="cm-variable">context</span>, <span class="cm-variable">ActivityThread</span> <span class="cm-variable">aThread</span>,</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Instrumentation</span> <span class="cm-variable">instr</span>, <span class="cm-variable">IBinder</span> <span class="cm-variable">token</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">ident</span>,</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Application</span> <span class="cm-variable">application</span>, <span class="cm-variable">Intent</span> <span class="cm-variable">intent</span>, <span class="cm-variable">ActivityInfo</span> <span class="cm-variable">info</span>,</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">CharSequence</span> <span class="cm-variable">title</span>, <span class="cm-variable">Activity</span> <span class="cm-variable">parent</span>, <span class="cm-variable-3">String</span> <span class="cm-variable">id</span>,</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">NonConfigurationInstances</span> <span class="cm-variable">lastNonConfigurationInstances</span>,</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Configuration</span> <span class="cm-variable">config</span>, <span class="cm-variable-3">String</span> <span class="cm-variable">referrer</span>, <span class="cm-variable">IVoiceInteractor</span> <span class="cm-variable">voiceInteractor</span>,</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Window</span> <span class="cm-variable">window</span>, <span class="cm-variable">ActivityConfigCallback</span> <span class="cm-variable">activityConfigCallback</span>, <span class="cm-variable">IBinder</span> <span class="cm-variable">assistToken</span>,</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">IBinder</span> <span class="cm-variable">shareableActivityToken</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-tab" role="presentation" cm-text="	"> </span>...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">//找到了，实例化Window对象</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">mWindow</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">PhoneWindow</span>(<span class="cm-keyword">this</span>, <span class="cm-variable">window</span>, <span class="cm-variable">activityConfigCallback</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">mWindow</span>.<span class="cm-variable">setWindowControllerCallback</span>(<span class="cm-variable">mWindowControllerCallback</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">//设置回调CallBack,上一章节最后getCallback获取到的CallBack就是这时候设置进去的。</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">mWindow</span>.<span class="cm-variable">setCallback</span>(<span class="cm-keyword">this</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">mWindow</span>.<span class="cm-variable">setOnWindowDismissedCallback</span>(<span class="cm-keyword">this</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">mWindow</span>.<span class="cm-variable">getLayoutInflater</span>().<span class="cm-variable">setPrivateFactory</span>(<span class="cm-keyword">this</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">//设置UI Thread</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">mUiThread</span> <span class="cm-operator">=</span> <span class="cm-variable">Thread</span>.<span class="cm-variable">currentThread</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">//持有ActivityThread对象</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">mMainThread</span> <span class="cm-operator">=</span> <span class="cm-variable">aThread</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">//有一个重点，给Window对象设置WindowManager</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">mWindow</span>.<span class="cm-variable">setWindowManager</span>(</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  (<span class="cm-variable">WindowManager</span>)<span class="cm-variable">context</span>.<span class="cm-variable">getSystemService</span>(<span class="cm-variable">Context</span>.<span class="cm-variable">WINDOW_SERVICE</span>),</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mToken</span>, <span class="cm-variable">mComponent</span>.<span class="cm-variable">flattenToString</span>(),</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  (<span class="cm-variable">info</span>.<span class="cm-variable">flags</span> <span class="cm-operator">&amp;</span> <span class="cm-variable">ActivityInfo</span>.<span class="cm-variable">FLAG_HARDWARE_ACCELERATED</span>) <span class="cm-operator">!=</span> <span class="cm-number">0</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">mParent</span> <span class="cm-operator">!=</span> <span class="cm-atom">null</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mWindow</span>.<span class="cm-variable">setContainer</span>(<span class="cm-variable">mParent</span>.<span class="cm-variable">getWindow</span>());</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">//持有WindowManager对象，通过Window的getWindowManager获取WindowManager对象</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">mWindowManager</span> <span class="cm-operator">=</span> <span class="cm-variable">mWindow</span>.<span class="cm-variable">getWindowManager</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre>
    </div>
    </div>
    </div>
    </div>
    </div>
    <div
        style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 770px;">
    </div>
    <div class="CodeMirror-gutters" style="display: none; height: 770px;"></div>
    </div>
    </div>
    </pre>
    <p><span>简明扼要，在Activity的attach里面，构建了Window对象被Activity持有，所以我们可以通过</span><code>getWindow</code><span>方法获取PhoneWindow。之后将WindowManager传入了Window之中，并且Activity也会持有WindowManager对象，且可以用过</span><code>getWindowManager</code><span>获取WindowManager对象。</span>
    </p>
    <p><span>在ActivityThread的performLaunchActivity方法中我们可以看到，attach的调用结束之后才会回调onCreate方法，所以我们在分析onCreate的setContentView方法里面逻辑的时候，就已经包含了Window对象。至此</span><code>handleLaunchActivity</code><span>分析完毕，接下来我们看一下</span><code>handleStartActivity</code><span>.</span>
    </p>
    <pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"
        style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre>
    </div>
    <div class="CodeMirror-measure"></div>
    <div style="position: relative; z-index: 1;"></div>
    <div class="CodeMirror-code" role="presentation" style="">
        <div class="CodeMirror-activeline" style="position: relative;">
            <div class="CodeMirror-activeline-background CodeMirror-linebackground"></div>
            <div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div>
            <pre class=" CodeMirror-line "
                role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">ActivityThread</span></span></pre>
        </div>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-def">handleStartActivity</span>(<span class="cm-variable">ActivityClientRecord</span> <span class="cm-variable">r</span>,<span class="cm-variable">PendingTransactionActions</span> <span class="cm-variable">pendingActions</span>, <span class="cm-variable">ActivityOptions</span> <span class="cm-variable">activityOptions</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span>...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">//回调onStart方法</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">activity</span>.<span class="cm-variable">performStart</span>(<span class="cm-string">"handleStartActivity"</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">r</span>.<span class="cm-variable">setState</span>(<span class="cm-variable">ON_START</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// 最终回调到了onRestoreInstanceState(savedInstanceState)方法</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">pendingActions</span>.<span class="cm-variable">shouldRestoreInstanceState</span>()) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">r</span>.<span class="cm-variable">isPersistable</span>()) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">r</span>.<span class="cm-variable">state</span> <span class="cm-operator">!=</span> <span class="cm-atom">null</span> <span class="cm-operator">||</span> <span class="cm-variable">r</span>.<span class="cm-variable">persistentState</span> <span class="cm-operator">!=</span> <span class="cm-atom">null</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mInstrumentation</span>.<span class="cm-variable">callActivityOnRestoreInstanceState</span>(<span class="cm-variable">activity</span>, <span class="cm-variable">r</span>.<span class="cm-variable">state</span>,</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">r</span>.<span class="cm-variable">persistentState</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">else</span> <span class="cm-keyword">if</span> (<span class="cm-variable">r</span>.<span class="cm-variable">state</span> <span class="cm-operator">!=</span> <span class="cm-atom">null</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mInstrumentation</span>.<span class="cm-variable">callActivityOnRestoreInstanceState</span>(<span class="cm-variable">activity</span>, <span class="cm-variable">r</span>.<span class="cm-variable">state</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre>
    </div>
    </div>
    </div>
    </div>
    </div>
    <div
        style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 462px;">
    </div>
    <div class="CodeMirror-gutters" style="display: none; height: 462px;"></div>
    </div>
    </div>
    </pre>
    <p><span>看到</span><code>handleStartActivity</code><span>里面就是回调了onStart方法，之后会调用到Activity的onRestoreInstanceState用来恢复数据。</span>
    </p>
    <p><span>最后来看</span><code>handleResumeActivity</code><span>方法。</span></p>
    <pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"
        style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre>
    </div>
    <div class="CodeMirror-measure"></div>
    <div style="position: relative; z-index: 1;"></div>
    <div class="CodeMirror-code" role="presentation" style="">
        <div class="CodeMirror-activeline" style="position: relative;">
            <div class="CodeMirror-activeline-background CodeMirror-linebackground"></div>
            <div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div>
            <pre class=" CodeMirror-line "
                role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">ActivityThread</span></span></pre>
        </div>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-def">handleResumeActivity</span>(<span class="cm-variable">ActivityClientRecord</span> <span class="cm-variable">r</span>, <span class="cm-variable-3">boolean</span> <span class="cm-variable">finalStateRequest</span>,<span class="cm-variable-3">boolean</span> <span class="cm-variable">isForward</span>, <span class="cm-variable-3">String</span> <span class="cm-variable">reason</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">//会判断是否调用onRestart以及调用onResume，并且进行ActivityClientRecord数据更新</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-operator">!</span><span class="cm-variable">performResumeActivity</span>(<span class="cm-variable">r</span>, <span class="cm-variable">finalStateRequest</span>, <span class="cm-variable">reason</span>)) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">//Window赋值</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">r</span>.<span class="cm-variable">window</span> <span class="cm-operator">==</span> <span class="cm-atom">null</span> <span class="cm-operator">&amp;&amp;</span> <span class="cm-operator">!</span><span class="cm-variable">a</span>.<span class="cm-variable">mFinished</span> <span class="cm-operator">&amp;&amp;</span> <span class="cm-variable">willBeVisible</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">r</span>.<span class="cm-variable">window</span> <span class="cm-operator">=</span> <span class="cm-variable">r</span>.<span class="cm-variable">activity</span>.<span class="cm-variable">getWindow</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">View</span> <span class="cm-variable">decor</span> <span class="cm-operator">=</span> <span class="cm-variable">r</span>.<span class="cm-variable">window</span>.<span class="cm-variable">getDecorView</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">decor</span>.<span class="cm-variable">setVisibility</span>(<span class="cm-variable">View</span>.<span class="cm-variable">INVISIBLE</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">ViewManager</span> <span class="cm-variable">wm</span> <span class="cm-operator">=</span> <span class="cm-variable">a</span>.<span class="cm-variable">getWindowManager</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">WindowManager</span>.<span class="cm-variable">LayoutParams</span> <span class="cm-variable">l</span> <span class="cm-operator">=</span> <span class="cm-variable">r</span>.<span class="cm-variable">window</span>.<span class="cm-variable">getAttributes</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">a</span>.<span class="cm-variable">mDecor</span> <span class="cm-operator">=</span> <span class="cm-variable">decor</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">l</span>.<span class="cm-variable">type</span> <span class="cm-operator">=</span> <span class="cm-variable">WindowManager</span>.<span class="cm-variable">LayoutParams</span>.<span class="cm-variable">TYPE_BASE_APPLICATION</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">l</span>.<span class="cm-variable">softInputMode</span> <span class="cm-operator">|=</span> <span class="cm-variable">forwardBit</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">a</span>.<span class="cm-variable">mVisibleFromClient</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-operator">!</span><span class="cm-variable">a</span>.<span class="cm-variable">mWindowAdded</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">a</span>.<span class="cm-variable">mWindowAdded</span> <span class="cm-operator">=</span> <span class="cm-atom">true</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//将DecorView与WindowManager通过addView进行绑定,准备进行视图显示</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">wm</span>.<span class="cm-variable">addView</span>(<span class="cm-variable">decor</span>, <span class="cm-variable">l</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">r</span>.<span class="cm-variable">activity</span>.<span class="cm-variable">mVisibleFromServer</span> <span class="cm-operator">=</span> <span class="cm-atom">true</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mNumVisibleActivities</span><span class="cm-operator">++</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">r</span>.<span class="cm-variable">activity</span>.<span class="cm-variable">mVisibleFromClient</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//DecorView 进行显示</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">r</span>.<span class="cm-variable">activity</span>.<span class="cm-variable">makeVisible</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Activity</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//如果mDecor没有被添加到WindowManager则重新添加一次，然后显示DecorView</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">void</span> <span class="cm-variable">makeVisible</span>() {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-operator">!</span><span class="cm-variable">mWindowAdded</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">ViewManager</span> <span class="cm-variable">wm</span> <span class="cm-operator">=</span> <span class="cm-variable">getWindowManager</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">wm</span>.<span class="cm-variable">addView</span>(<span class="cm-variable">mDecor</span>, <span class="cm-variable">getWindow</span>().<span class="cm-variable">getAttributes</span>());</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mWindowAdded</span> <span class="cm-operator">=</span> <span class="cm-atom">true</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">mDecor</span>.<span class="cm-variable">setVisibility</span>(<span class="cm-variable">View</span>.<span class="cm-variable">VISIBLE</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre>
    </div>
    </div>
    </div>
    </div>
    </div>
    <div
        style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 1034px;">
    </div>
    <div class="CodeMirror-gutters" style="display: none; height: 1034px;"></div>
    </div>
    </div>
    </pre>
    <p><span>在</span><code>handleResumeActivity</code><span>中，先进行</span><code>onRestart</code><span>以及</span><code>onResume</code><span>的调用，之后对</span><code>window</code><span>、</span><code>decorView</code><span>的给数据进行赋值，然后将</span><code>decorView</code><span>通过WindowManager的addView进行绑定管理。之后进行DecorView的显示。</span>
    </p>
    <p><strong><span>总结</span></strong></p>
    <p><span>在</span><code>handleLaunchActivity</code><span>中进行Activity的实例化，之后初始化WindowManager，Context等，Window持有WindowManager，给Activity绑定Window对象。然后调用到onCreate的setContentView，创建DecorView被Window持有。同时我们自己的布局包含在了DecorView中；之后调用</span><code>handleStartActivity</code><span>方法，里面会调用</span><code>onStart</code><span>以及</span><code>onRestoreInstanceState</code><span>；之后调用</span><code>handleResumeActivity</code><span>先回调调用</span><code>onResume</code><span>之后将DecorView通过WindowManager的addView方法和WindowManager进行绑定，最后调用Activity的</span><code>makeVisible</code><span>进行显示。</span>
    </p>
    <h2><a name="viewrootimpl的创建以及视图真正加载" class="md-header-anchor"></a><span>ViewRootImpl的创建以及视图真正加载</span></h2>
    <blockquote>
        <p><span>通过上一章我们知道在handleResumeActivity方法中，最终将将DecorView通过addView方法被添加到了WindowManager之中了。那么这里面干了什么呢？</span></p>
        <p><span>这里涉及到一个重要的类ViewRootImpl，本章详细解析ViewRootImpl的创建以及视图真正的加载过</span><strong><span>程</span></strong></p>
    </blockquote>
    <p><strong><span>ViewRootImpl</span></strong></p>
    <pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"
        style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre>
    </div>
    <div class="CodeMirror-measure"></div>
    <div style="position: relative; z-index: 1;"></div>
    <div class="CodeMirror-code" role="presentation" style="">
        <div class="CodeMirror-activeline" style="position: relative;">
            <div class="CodeMirror-activeline-background CodeMirror-linebackground"></div>
            <div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div>
            <pre class=" CodeMirror-line "
                role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">final</span> <span class="cm-keyword">class</span> <span class="cm-def">ViewRootImpl</span> <span class="cm-keyword">implements</span> <span class="cm-variable">ViewParent</span>,</span></pre>
        </div>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">View</span>.<span class="cm-variable">AttachInfo</span>.<span class="cm-variable">Callbacks</span>, <span class="cm-variable">ThreadedRenderer</span>.<span class="cm-variable">DrawCallbacks</span>,</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">AttachedSurfaceControl</span> {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//持有主线程</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">final</span> <span class="cm-variable">Thread</span> <span class="cm-variable">mThread</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//DecorView</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">View</span> <span class="cm-variable">mView</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">final</span> <span class="cm-variable">View</span>.<span class="cm-variable">AttachInfo</span> <span class="cm-variable">mAttachInfo</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//执行setView方法去想Window添加View</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-variable">setView</span>(<span class="cm-variable">View</span> <span class="cm-variable">view</span>, <span class="cm-variable">WindowManager</span>.<span class="cm-variable">LayoutParams</span> <span class="cm-variable">attrs</span>, <span class="cm-variable">View</span> <span class="cm-variable">panelParentView</span>,</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">int</span> <span class="cm-variable">userId</span>) {...}</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">void</span> <span class="cm-variable">doTraversal</span>() {...}</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">void</span> <span class="cm-variable">scheduleTraversals</span>() {...}</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre>
    </div>
    </div>
    </div>
    </div>
    </div>
    <div
        style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 374px;">
    </div>
    <div class="CodeMirror-gutters" style="display: none; height: 374px;"></div>
    </div>
    </div>
    </pre>
    <p><span>差不多见名识意吧：</span></p>
    <ul>
        <li><span>它会在WindowManager调用addView添加DecorView时进行初始化，能和系统的WindowManagerService交互，管理DecorView
                的绘图和窗口状态；会持有DecorView；</span></li>
        <li><span>会进行绘制主线程检查，异步线程抛异常；</span></li>
        <li><span>会进行我们所熟知视图绘制三大流程，performMeasure、performLayout、performDraw；</span></li>
        <li><span>在View中会被</span><code>mParent</code><span>变量所持有，在View.AttachInfo中被</span><code>mViewRootImpl</code><span>变量所持有，我们平时调用的</span><code>getViewRootImpl()</code><span>方法，就是获取的</span><code>mViewRootImpl</code><span>变量的引用。</span>
        </li>
        <li><span>调用View的</span><code>invalidate()</code><span>方法也会到ViewRootImpl里面，另外，除了绘制流程，它还承担了事件分发（即输入事件中转站，下一章节讲到）。</span>
        </li>
        <li><span>负责和WMS进行进程间通信。</span></li>
    </ul>
    <p><strong><span>源码调用分析</span></strong></p>
    <p><span>通过上一章节分析我们知道，WindowManager调用</span><code>addView</code><span>方法进行管理DecorView。我们又知道最终肯定是通过WindowManagerGlobal来进行实际的执行，所以我们直接看WindowManagerGlobal的addView方法：</span>
    </p>
    <pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"
        style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre>
    </div>
    <div class="CodeMirror-measure"></div>
    <div style="position: relative; z-index: 1;"></div>
    <div class="CodeMirror-code" role="presentation" style="">
        <div class="CodeMirror-activeline" style="position: relative;">
            <div class="CodeMirror-activeline-background CodeMirror-linebackground"></div>
            <div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div>
            <pre class=" CodeMirror-line "
                role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">WindowManagerGlobal</span></span></pre>
        </div>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-def">addView</span>(<span class="cm-variable">View</span> <span class="cm-variable">view</span>, <span class="cm-variable">ViewGroup</span>.<span class="cm-variable">LayoutParams</span> <span class="cm-variable">params</span>,</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Display</span> <span class="cm-variable">display</span>, <span class="cm-variable">Window</span> <span class="cm-variable">parentWindow</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">userId</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">ViewRootImpl</span> <span class="cm-variable">root</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">View</span> <span class="cm-variable">panelParentView</span> <span class="cm-operator">=</span> <span class="cm-atom">null</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span>...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">root</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">ViewRootImpl</span>(<span class="cm-variable">view</span>.<span class="cm-variable">getContext</span>(), <span class="cm-variable">display</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//保存ViewRootImpl、DecorView以及params</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mViews</span>.<span class="cm-variable">add</span>(<span class="cm-variable">view</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mRoots</span>.<span class="cm-variable">add</span>(<span class="cm-variable">root</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  <span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">mParams</span>.<span class="cm-variable">add</span>(<span class="cm-variable">wparams</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">try</span> {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//调用ViewRootImpl的setView方法</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">root</span>.<span class="cm-variable">setView</span>(<span class="cm-variable">view</span>, <span class="cm-variable">wparams</span>, <span class="cm-variable">panelParentView</span>, <span class="cm-variable">userId</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">catch</span> (<span class="cm-variable">RuntimeException</span> <span class="cm-variable">e</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// BadTokenException or InvalidDisplayException, clean up.</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">index</span> <span class="cm-operator">&gt;=</span> <span class="cm-number">0</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">removeViewLocked</span>(<span class="cm-variable">index</span>, <span class="cm-atom">true</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">throw</span> <span class="cm-variable">e</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre>
    </div>
    </div>
    </div>
    </div>
    </div>
    <div
        style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 572px;">
    </div>
    <div class="CodeMirror-gutters" style="display: none; height: 572px;"></div>
    </div>
    </div>
    </pre>
    <p><span>在</span><code>addView</code><span>中我们看到了</span><code>ViewRootImpl</code><span>，首先构建</span><code>ViewRootImpl</code><span>，之后通过</span><code>setView</code><span>方法，将DecorView传递到了</span><code>ViewRootImpl</code><span>。</span>
    </p>
    <p><span>另WindowManagerGlobal中维护的和Window操作相关的3个列表，在窗口的添加、更新和删除过程中都会涉及这3个列表，它们分别是View
            列表</span><code>（ArrayList＜View＞ mViews）</code><span>、布局参数列表</span><code>（ArrayList＜WindowManager.LayoutParams＞mParams）</code><span>和ViewRootImpl列表</span><code>（ArrayList＜ViewRootImpl＞mRoots</code><span>。</span>
    </p>
    <p><span>看</span><code>ViewRootImpl</code><span>的构建以及</span><code>setView</code><span>的源码：</span></p>
    <pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"
        style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre>
    </div>
    <div class="CodeMirror-measure"></div>
    <div style="position: relative; z-index: 1;"></div>
    <div class="CodeMirror-code" role="presentation" style="">
        <div class="CodeMirror-activeline" style="position: relative;">
            <div class="CodeMirror-activeline-background CodeMirror-linebackground"></div>
            <div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div>
            <pre class=" CodeMirror-line "
                role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//ViewRootImpl构造方法</span></span></pre>
        </div>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-variable">ViewRootImpl</span>(<span class="cm-meta">@UiContext</span> <span class="cm-variable">Context</span> <span class="cm-variable">context</span>, <span class="cm-variable">Display</span> <span class="cm-variable">display</span>, <span class="cm-variable">IWindowSession</span> <span class="cm-variable">session</span>,</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">boolean</span> <span class="cm-variable">useSfChoreographer</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span>...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; <span class="cm-tab" role="presentation" cm-text="	"> </span><span class="cm-comment">//持有主线程，即创建ViewRootImpl的线程</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">mThread</span> <span class="cm-operator">=</span> <span class="cm-variable">Thread</span>.<span class="cm-variable">currentThread</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">//初始化AttachInfo，内部传递持有了ViewRootImpl，后续的代码里，它将被传递给View，所以可以通过View获取到mAttachInfo，进而获取到ViewRootImpl。</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">mAttachInfo</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">View</span>.<span class="cm-variable">AttachInfo</span>(<span class="cm-variable">mWindowSession</span>, <span class="cm-variable">mWindow</span>, <span class="cm-variable">display</span>, <span class="cm-keyword">this</span>, <span class="cm-variable">mHandler</span>, <span class="cm-keyword">this</span>,<span class="cm-variable">context</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">ViewRootImpl</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-def">setView</span>(<span class="cm-variable">View</span> <span class="cm-variable">view</span>, <span class="cm-variable">WindowManager</span>.<span class="cm-variable">LayoutParams</span> <span class="cm-variable">attrs</span>, <span class="cm-variable">View</span> <span class="cm-variable">panelParentView</span>,</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">int</span> <span class="cm-variable">userId</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">synchronized</span> (<span class="cm-keyword">this</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">mView</span> <span class="cm-operator">==</span> <span class="cm-atom">null</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//持有DecorView</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mView</span> <span class="cm-operator">=</span> <span class="cm-variable">view</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//AttachInfo持有DecorView</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mAttachInfo</span>.<span class="cm-variable">mRootView</span> <span class="cm-operator">=</span> <span class="cm-variable">view</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//调用requestLayout</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">requestLayout</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//通过WindowSession来完成window最终的添加，该过程mWindowSession类型是IWindowSession，它是一个Binder对象，真正的实现类是Session，所以这其实是一次IPC的过程，远程的调用了Session的addToDisPlay方法。</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">res</span> <span class="cm-operator">=</span> <span class="cm-variable">mWindowSession</span>.<span class="cm-variable">addToDisplayAsUser</span>(<span class="cm-variable">mWindow</span>, <span class="cm-variable">mWindowAttributes</span>,</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">getHostVisibility</span>(), <span class="cm-variable">mDisplay</span>.<span class="cm-variable">getDisplayId</span>(), <span class="cm-variable">userId</span>,</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mInsetsController</span>.<span class="cm-variable">getRequestedVisibility</span>(), <span class="cm-variable">inputChannel</span>, <span class="cm-variable">mTempInsets</span>,</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mTempControls</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span>...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-tab" role="presentation" cm-text="	"> </span><span class="cm-comment">//将自己传递给View的mParent变量，如此调用View相关的invalidate方法，就直接调用到了ViewRootImpl</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">view</span>.<span class="cm-variable">assignParent</span>(<span class="cm-keyword">this</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre>
    </div>
    </div>
    </div>
    </div>
    </div>
    <div
        style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 770px;">
    </div>
    <div class="CodeMirror-gutters" style="display: none; height: 770px;"></div>
    </div>
    </div>
    </pre>
    <p><span>除了相关变量的赋值操作，在</span><code>setView</code><span>中有两个很值得注意的地方。</span></p>
    <ol start=''>
        <li><span>调用了</span><code>requestLayout</code><span>方法，其内部会调用到</span><code>scheduleTraversals</code><span>，进而调用了</span><code>measure、layout、draw</code><span>。</span>
        </li>
        <li><span>通过IPC，将window添加到WMS（WindowManagerService）进行管理。</span></li>
    </ol>
    <p><span>针对将window添加到WMS这一块，我们可以看一下Session的代码：</span></p>
    <pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded"
        lang="java"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre>
    </div>
    <div class="CodeMirror-measure"></div>
    <div style="position: relative; z-index: 1;"></div>
    <div class="CodeMirror-code" role="presentation" style="">
        <div class="CodeMirror-activeline" style="position: relative;">
            <div class="CodeMirror-activeline-background CodeMirror-linebackground"></div>
            <div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div>
            <pre class=" CodeMirror-line "
                role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Session</span></span></pre>
        </div>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-variable-3">int</span> <span class="cm-def">addToDisplayAsUser</span>(<span class="cm-variable">IWindow</span> <span class="cm-variable">window</span>, <span class="cm-variable">WindowManager</span>.<span class="cm-variable">LayoutParams</span> <span class="cm-variable">attrs</span>,</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable-3">int</span> <span class="cm-variable">viewVisibility</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">displayId</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">userId</span>, <span class="cm-variable">InsetsState</span> <span class="cm-variable">requestedVisibility</span>,</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">InputChannel</span> <span class="cm-variable">outInputChannel</span>, <span class="cm-variable">InsetsState</span> <span class="cm-variable">outInsetsState</span>,</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">InsetsSourceControl</span>[] <span class="cm-variable">outActiveControls</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">mService</span>.<span class="cm-variable">addWindow</span>(<span class="cm-keyword">this</span>, <span class="cm-variable">window</span>, <span class="cm-variable">attrs</span>, <span class="cm-variable">viewVisibility</span>, <span class="cm-variable">displayId</span>, <span class="cm-variable">userId</span>,</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">requestedVisibility</span>, <span class="cm-variable">outInputChannel</span>, <span class="cm-variable">outInsetsState</span>, <span class="cm-variable">outActiveControls</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre>
    </div>
    </div>
    </div>
    </div>
    </div>
    <div
        style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 176px;">
    </div>
    <div class="CodeMirror-gutters" style="display: none; height: 176px;"></div>
    </div>
    </div>
    </pre>
    <p><span>这个</span><code>mService</code><span>就是WMS，也就是说ViewRootImpl通过Session可以和WMS进行跨进程调用，而我们看到Session也被WMS持有，每个应用程序进程都会对应一个Session，WMS会用ArrayList来保存这些Session。剩下的工作就交给WMS来处理，在WMS中会为这个添加的窗口分配Surface，并确定窗口显示次序，可见负责显示界面的是画布Surface，而不是窗口本身。WMS
            会将它所管理的Surface 交由SurfaceFlinger处理，SurfaceFlinger会将这些Surface混合并绘制到屏幕上。</span></p>
    <p>&nbsp;</p>
    <p><span>DecorView的绘制流程则是通过调用</span><code>requestLayout</code><span>来继续完成的</span></p>
    <pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded"
        lang="java"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre>
    </div>
    <div class="CodeMirror-measure"></div>
    <div style="position: relative; z-index: 1;"></div>
    <div class="CodeMirror-code" role="presentation" style="">
        <div class="CodeMirror-activeline" style="position: relative;">
            <div class="CodeMirror-activeline-background CodeMirror-linebackground"></div>
            <div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div>
            <pre class=" CodeMirror-line "
                role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">ViewRootImpl</span></span></pre>
        </div>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-def">requestLayout</span>() {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-operator">!</span><span class="cm-variable">mHandlingLayoutInLayoutRequest</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//判断当前是否是主线程即mThread,如果不是，则抛异常。就是在子线程更新UI没使用handler的话就会抛出的异常</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">checkThread</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//设置mLayoutRequested为true。</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mLayoutRequested</span> <span class="cm-operator">=</span> <span class="cm-atom">true</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//进而测量、布局、绘制</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">scheduleTraversals</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre>
    </div>
    </div>
    </div>
    </div>
    </div>
    <div
        style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 242px;">
    </div>
    <div class="CodeMirror-gutters" style="display: none; height: 242px;"></div>
    </div>
    </div>
    </pre>
    <p><span>在</span><code>requestLayout</code><span>的方法中，首先进行调用者的线程检查，如果不是主线程，即不和</span><code>mThread</code><span>指向的不是同一个线程对象，就抛出异常。随后设置</span><code>mLayoutRequested</code><span>为true，这个变量是做什么呢？它主要用来区分是否需要进行测量和布局。最后调用</span><code>mLayoutRequested</code><span>方法。</span>
    </p>
    <p><span>这里说明一下，</span><code>requestLayout</code><span>方法和</span><code>invalidae</code><span>方法均是通过最后均调用了</span><code>scheduleTraversals</code><span>方法，那么</span><strong><span>是如何区分是不是需要测量和布局呢</span></strong><span>？就是上面提到的</span><code>mLayoutRequested</code><span>变量了，如果是</span><code>requestLayout</code><span>则赋值为true，就会调用测量和布局；如果是</span><code>invalidae</code><span>，则默认就为false。</span>
    </p>
    <p><span>接下来看一下</span><code>scheduleTraversals</code><span>及其相关方法的调用流程。</span></p>
    <pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"
        style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre>
    </div>
    <div class="CodeMirror-measure"></div>
    <div style="position: relative; z-index: 1;"></div>
    <div class="CodeMirror-code" role="presentation" style="">
        <div class="CodeMirror-activeline" style="position: relative;">
            <div class="CodeMirror-activeline-background CodeMirror-linebackground"></div>
            <div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div>
            <pre class=" CodeMirror-line "
                role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">ViewRootImpl</span></span></pre>
        </div>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable-3">void</span> <span class="cm-def">scheduleTraversals</span>() {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-operator">!</span><span class="cm-variable">mTraversalScheduled</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mTraversalScheduled</span> <span class="cm-operator">=</span> <span class="cm-atom">true</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mTraversalBarrier</span> <span class="cm-operator">=</span> <span class="cm-variable">mHandler</span>.<span class="cm-variable">getLooper</span>().<span class="cm-variable">getQueue</span>().<span class="cm-variable">postSyncBarrier</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mChoreographer</span>.<span class="cm-variable">postCallback</span>(</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Choreographer</span>.<span class="cm-variable">CALLBACK_TRAVERSAL</span>, <span class="cm-variable">mTraversalRunnable</span>, <span class="cm-atom">null</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">notifyRendererOfFramePending</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">pokeDrawLockIfNeeded</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">mTraversalRunnable</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">final</span> <span class="cm-keyword">class</span> <span class="cm-def">TraversalRunnable</span> <span class="cm-keyword">implements</span> <span class="cm-variable">Runnable</span> {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-meta">@Override</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-variable">run</span>() {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">doTraversal</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">ViewRootImpl</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable-3">void</span> <span class="cm-def">doTraversal</span>() {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">mTraversalScheduled</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mTraversalScheduled</span> <span class="cm-operator">=</span> <span class="cm-atom">false</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mHandler</span>.<span class="cm-variable">getLooper</span>().<span class="cm-variable">getQueue</span>().<span class="cm-variable">removeSyncBarrier</span>(<span class="cm-variable">mTraversalBarrier</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//调用了performTraversals</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">performTraversals</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">ViewRootImpl</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span class="cm-variable-3">void</span> <span class="cm-def">performTraversals</span>() {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">final</span> <span class="cm-variable">View</span> <span class="cm-variable">host</span> <span class="cm-operator">=</span> <span class="cm-variable">mView</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//将mAttachInfo传入View，同时会调用View的onAttachedToWindow方法</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">host</span>.<span class="cm-variable">dispatchAttachedToWindow</span>(<span class="cm-variable">mAttachInfo</span>, <span class="cm-number">0</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">performMeasure</span>(<span class="cm-variable">childWidthMeasureSpec</span>, <span class="cm-variable">childHeightMeasureSpec</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">performLayout</span>(<span class="cm-variable">lp</span>, <span class="cm-variable">mWidth</span>, <span class="cm-variable">mHeight</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">performDraw</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  ...</span></pre>
    </div>
    </div>
    </div>
    </div>
    </div>
    <div
        style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 880px;">
    </div>
    <div class="CodeMirror-gutters" style="display: none; height: 880px;"></div>
    </div>
    </div>
    </pre>
    <p><span>上面列出了</span><code>scheduleTraversals</code><span>整个方法的调用链，下面来梳理一下：</span></p>
    <ol start=''>
        <li><span>给Choreographer注册了一个</span><code>mTraversalRunnable</code><span>。Choreographer用于接收显示系统的VSync信号，在下一个帧渲染时控制执行一些操作。Choreographer的postCallback方法用于发起添加回调，这个添加的回调将在下一帧被渲染时执行。所以我们知道</span><code>mTraversalRunnable</code><span>里面的内容将在下一帧渲染时被执行。</span>
        </li>
        <li><span>我们看一下</span><code>mTraversalRunnable</code><span>的类型，内部调用了</span><code>doTraversal</code><span>。而在</span><code>doTraversal</code><span>内部调用了</span><code>performTraversals</code><span>。</span>
        </li>
        <li><span>在</span><code>performTraversals</code><span>中，调用DecorView
                的</span><code>dispatchAttachedToWindow</code><span>方法，给View绑定了</span><code>mAttachInfo</code><span>，进而可以调用到View的</span><code>onAttachedToWindow</code><span>方法。之后就是熟悉的测量、布局、绘制调用流程。</span>
        </li>
    </ol>
    <p>&nbsp;</p>
    <p><span>ViewRootImpl的创建以及视图绘制流程就清楚了，和之前的结合进行简单的总结一下：</span></p>
    <p><span>在</span><code>handleLaunchActivity</code><span>中进行Activity的实例化，之后初始化WindowManager，Context等，Window持有WindowManager，给Activity绑定Window对象。然后调用到onCreate的setContentView，创建DecorView被Window持有。同时我们自己的布局包含在了DecorView中；之后调用</span><code>handleStartActivity</code><span>方法，里面会调用</span><code>onStart</code><span>以及</span><code>onRestoreInstanceState</code><span>；</span>
    </p>
    <p><span>之后真正的显示过程在调用</span><code>handleResumeActivity</code><span>回调调用</span><code>onResume</code><span>之后，此时会将DecorView通过WindowManager的addView方法和WindowManager进行绑定，利</span><strong><span>用ViewRootImpl进行和WMS交互，加入window布局到到WMS，然后进行View的测量、布局、绘制</span></strong><span>，最后调用Activity的</span><code>makeVisible</code><span>进行显示。</span>
    </p>
    <h2><a name="viewrootimpl的事件分发" class="md-header-anchor"></a><span>ViewRootImpl的事件分发</span></h2>
    <blockquote>
        <p><span>上一章节，我们知道ViewRootImpl的绘制流程。</span></p>
        <p><span>那么今天就来看一看ViewRootImpl的另一个大的功能点事件分发吧。</span></p>
    </blockquote>
    <p><strong><span>事件是如何被接收的呢？</span></strong></p>
    <p><span>首先需要思考一个问题，事件是如何传递到ViewGroup呢？</span></p>
    <p><span>我们都知道Android底层是Linux内核，所以事件的传递过程大概如下所示：</span></p>
    <p><img src="E:\Documentation\My_Learn_Documentation_Git\android\pic_android\event_deliver.jpg"
            referrerpolicy="no-referrer" alt="event_deliver"></p>
    <p>&nbsp;</p>
    <p><span>在Android系统开机的过程中，会启动许多系统服务，其中包括</span><code>InputManagerService</code><span>用来监听事件的输入，而</span><code>WindowManagerService</code><span>作为事件输入中转站，管理输入事件，配合</span><code>InputManagerService</code><span>将输入事件交由合适的</span><code>Window</code><span>，即最终传输到</span><code>ViewRootImpl</code><span>的</span><code>InputChannel</code><span>，最终被</span><code>ViewRootImpl</code><span>的</span><code>WindowInputEventReceiver</code><span>所接受。</span>
    </p>
    <p><span>对于上述的流程，这里先简单看一下源码：</span></p>
    <pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"
        style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre>
    </div>
    <div class="CodeMirror-measure"></div>
    <div style="position: relative; z-index: 1;"></div>
    <div class="CodeMirror-code" role="presentation" style="">
        <div class="CodeMirror-activeline" style="position: relative;">
            <div class="CodeMirror-activeline-background CodeMirror-linebackground"></div>
            <div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div>
            <pre class=" CodeMirror-line "
                role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">ViewRootImpl</span></span></pre>
        </div>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-def">setView</span>(<span class="cm-variable">View</span> <span class="cm-variable">view</span>, <span class="cm-variable">WindowManager</span>.<span class="cm-variable">LayoutParams</span> <span class="cm-variable">attrs</span>, <span class="cm-variable">View</span> <span class="cm-variable">panelParentView</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">userId</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span>...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">//构建inputChannel</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">InputChannel</span> <span class="cm-variable">inputChannel</span> <span class="cm-operator">=</span> <span class="cm-atom">null</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">if</span> ((<span class="cm-variable">mWindowAttributes</span>.<span class="cm-variable">inputFeatures</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">&amp;</span> <span class="cm-variable">WindowManager</span>.<span class="cm-variable">LayoutParams</span>.<span class="cm-variable">INPUT_FEATURE_NO_INPUT_CHANNEL</span>) <span class="cm-operator">==</span> <span class="cm-number">0</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">inputChannel</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">InputChannel</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">//在上一章节，就讲的很清楚了，这里会通IPC调用到WMS，添加window。但是注意，此时把inputChannel也传递过去了，被WMS持有用作事件分发。</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">res</span> <span class="cm-operator">=</span> <span class="cm-variable">mWindowSession</span>.<span class="cm-variable">addToDisplayAsUser</span>(<span class="cm-variable">mWindow</span>, <span class="cm-variable">mWindowAttributes</span>,</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">getHostVisibility</span>(), <span class="cm-variable">mDisplay</span>.<span class="cm-variable">getDisplayId</span>(), <span class="cm-variable">userId</span>,</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">mInsetsController</span>.<span class="cm-variable">getRequestedVisibility</span>(), <span class="cm-variable">inputChannel</span>, <span class="cm-variable">mTempInsets</span>,</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">mTempControls</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">//通时inputChannel也被WindowInputEventReceiver所持有，接受WMS分发过来的事件。</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">mInputEventReceiver</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">WindowInputEventReceiver</span>(<span class="cm-variable">inputChannel</span>,</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Looper</span>.<span class="cm-variable">myLooper</span>());</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span>...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre>
    </div>
    </div>
    </div>
    </div>
    </div>
    <div
        style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 484px;">
    </div>
    <div class="CodeMirror-gutters" style="display: none; height: 484px;"></div>
    </div>
    </div>
    </pre>
    <p><span>上一章节我们已经很清楚了，</span><code>setView</code><span>会在</span><code>ActivityThread</code><span>调用</span><code>handleResumeActivity</code><span>时被</span><code>WindowManager</code><span>调用</span><code>addView</code><span>所调用，用于添加DecorView，以及调用绘制流程。但是这里面也会初始化</span><code>InputChannel</code><span>以及</span><code>WindowInputEventReceiver</code><span>用于接收事件输入。</span>
    </p>
    <p>&nbsp;</p>
    <p><strong><span>ViewRootImpl事件分发源码分析</span></strong></p>
    <p><span>好了接下来进入正题，看ViewRootImpl接收到事件之后是如何处理的。</span></p>
    <pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded"
        lang="java"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre>
    </div>
    <div class="CodeMirror-measure"></div>
    <div style="position: relative; z-index: 1;"></div>
    <div class="CodeMirror-code" role="presentation" style="">
        <div class="CodeMirror-activeline" style="position: relative;">
            <div class="CodeMirror-activeline-background CodeMirror-linebackground"></div>
            <div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div>
            <pre class=" CodeMirror-line "
                role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">ViewRootImpl</span></span></pre>
        </div>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">final</span> <span class="cm-keyword">class</span> <span class="cm-def">WindowInputEventReceiver</span> <span class="cm-keyword">extends</span> <span class="cm-variable">InputEventReceiver</span> {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span>...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">//用于接收事件输入</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-variable">onInputEvent</span>(<span class="cm-variable">InputEvent</span> <span class="cm-variable">event</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//注意：最后一个参数传入了true</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">enqueueInputEvent</span>(<span class="cm-variable">event</span>, <span class="cm-keyword">this</span>, <span class="cm-number">0</span>, <span class="cm-atom">true</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span>...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre>
    </div>
    </div>
    </div>
    </div>
    </div>
    <div
        style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 264px;">
    </div>
    <div class="CodeMirror-gutters" style="display: none; height: 264px;"></div>
    </div>
    </div>
    </pre>
    <p><span>我们直接看</span><code>WindowInputEventReceiver</code><span>类，他是ViewRootImpl的内部类。其中</span><code>onInputEvent</code><span>用于接收事件输入，它调用了</span><code>enqueueInputEvent</code><span>，且最后一个参数传入了</span><code>true</code><span>。</span>
    </p>
    <pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"
        style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre>
    </div>
    <div class="CodeMirror-measure"></div>
    <div style="position: relative; z-index: 1;"></div>
    <div class="CodeMirror-code" role="presentation" style="">
        <div class="CodeMirror-activeline" style="position: relative;">
            <div class="CodeMirror-activeline-background CodeMirror-linebackground"></div>
            <div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div>
            <pre class=" CodeMirror-line "
                role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">ViewRootImpl</span></span></pre>
        </div>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">void</span> <span class="cm-def">enqueueInputEvent</span>(<span class="cm-variable">InputEvent</span> <span class="cm-variable">event</span>,</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">InputEventReceiver</span> <span class="cm-variable">receiver</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">flags</span>, <span class="cm-variable-3">boolean</span> <span class="cm-variable">processImmediately</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//获取队列输入事件</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">QueuedInputEvent</span> <span class="cm-variable">q</span> <span class="cm-operator">=</span> <span class="cm-variable">obtainQueuedInputEvent</span>(<span class="cm-variable">event</span>, <span class="cm-variable">receiver</span>, <span class="cm-variable">flags</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span>...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">///输入事件添加进队列后，加入输入事件的默认尾部</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">QueuedInputEvent</span> <span class="cm-variable">last</span> <span class="cm-operator">=</span> <span class="cm-variable">mPendingInputEventTail</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">last</span> <span class="cm-operator">==</span> <span class="cm-atom">null</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mPendingInputEventHead</span> <span class="cm-operator">=</span> <span class="cm-variable">q</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mPendingInputEventTail</span> <span class="cm-operator">=</span> <span class="cm-variable">q</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">else</span> {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">last</span>.<span class="cm-variable">mNext</span> <span class="cm-operator">=</span> <span class="cm-variable">q</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mPendingInputEventTail</span> <span class="cm-operator">=</span> <span class="cm-variable">q</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mPendingInputEventCount</span> <span class="cm-operator">+=</span> <span class="cm-number">1</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//由于调用传进来的是true，这里执行doProcessInputEvents</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">processImmediately</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">doProcessInputEvents</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">else</span> {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">scheduleProcessInputEvents</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre>
    </div>
    </div>
    </div>
    </div>
    </div>
    <div
        style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 528px;">
    </div>
    <div class="CodeMirror-gutters" style="display: none; height: 528px;"></div>
    </div>
    </div>
    </pre>
    <p><span>在</span><code>enqueueInputEvent</code><span>中，选获取了队列输入事件，之后将它加入链表末尾，然后调用了</span><code>doProcessInputEvents</code><span>。</span>
    </p>
    <pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"
        style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre>
    </div>
    <div class="CodeMirror-measure"></div>
    <div style="position: relative; z-index: 1;"></div>
    <div class="CodeMirror-code" role="presentation" style="">
        <div class="CodeMirror-activeline" style="position: relative;">
            <div class="CodeMirror-activeline-background CodeMirror-linebackground"></div>
            <div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div>
            <pre class=" CodeMirror-line "
                role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">ViewRootImpl</span></span></pre>
        </div>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable-3">void</span> <span class="cm-def">doProcessInputEvents</span>() {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 交付队列中所有待处理的输入事件。</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">while</span> (<span class="cm-variable">mPendingInputEventHead</span> <span class="cm-operator">!=</span> <span class="cm-atom">null</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">QueuedInputEvent</span> <span class="cm-variable">q</span> <span class="cm-operator">=</span> <span class="cm-variable">mPendingInputEventHead</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mPendingInputEventHead</span> <span class="cm-operator">=</span> <span class="cm-variable">q</span>.<span class="cm-variable">mNext</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">mPendingInputEventHead</span> <span class="cm-operator">==</span> <span class="cm-atom">null</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mPendingInputEventTail</span> <span class="cm-operator">=</span> <span class="cm-atom">null</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">q</span>.<span class="cm-variable">mNext</span> <span class="cm-operator">=</span> <span class="cm-atom">null</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mPendingInputEventCount</span> <span class="cm-operator">-=</span> <span class="cm-number">1</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Trace</span>.<span class="cm-variable">traceCounter</span>(<span class="cm-variable">Trace</span>.<span class="cm-variable">TRACE_TAG_INPUT</span>, <span class="cm-variable">mPendingInputEventQueueLengthCounterName</span>,</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mPendingInputEventCount</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mViewFrameInfo</span>.<span class="cm-variable">setInputEvent</span>(<span class="cm-variable">mInputEventAssigner</span>.<span class="cm-variable">processEvent</span>(<span class="cm-variable">q</span>.<span class="cm-variable">mEvent</span>));</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">//事件处理</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">deliverInputEvent</span>(<span class="cm-variable">q</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span>...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre>
    </div>
    </div>
    </div>
    </div>
    </div>
    <div
        style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 462px;">
    </div>
    <div class="CodeMirror-gutters" style="display: none; height: 462px;"></div>
    </div>
    </div>
    </pre>
    <p><span>这里循环取出事件，然后交予</span><code>deliverInputEvent</code><span>进行处理。</span></p>
    <pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"
        style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre>
    </div>
    <div class="CodeMirror-measure"></div>
    <div style="position: relative; z-index: 1;"></div>
    <div class="CodeMirror-code" role="presentation" style="">
        <div class="CodeMirror-activeline" style="position: relative;">
            <div class="CodeMirror-activeline-background CodeMirror-linebackground"></div>
            <div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div>
            <pre class=" CodeMirror-line "
                role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">private</span> <span class="cm-variable-3">void</span> <span class="cm-def">deliverInputEvent</span>(<span class="cm-variable">QueuedInputEvent</span> <span class="cm-variable">q</span>) {</span></pre>
        </div>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">InputStage</span> <span class="cm-variable">stage</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">q</span>.<span class="cm-variable">shouldSendToSynthesizer</span>()) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">stage</span> <span class="cm-operator">=</span> <span class="cm-variable">mSyntheticInputStage</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  } <span class="cm-keyword">else</span> {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">stage</span> <span class="cm-operator">=</span> <span class="cm-variable">q</span>.<span class="cm-variable">shouldSkipIme</span>() <span class="cm-operator">?</span> <span class="cm-variable">mFirstPostImeInputStage</span> : <span class="cm-variable">mFirstInputStage</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span>...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">stage</span> <span class="cm-operator">!=</span> <span class="cm-atom">null</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">handleWindowFocusChanged</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//通过deliver最终会调用到，InputStage具体实现类的onProcess方法。</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">stage</span>.<span class="cm-variable">deliver</span>(<span class="cm-variable">q</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  } <span class="cm-keyword">else</span> {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">finishInputEvent</span>(<span class="cm-variable">q</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//这里说明一下，在ViewRootImpl的setView方法中，还会初始化，这么几个InputStage，用于处理不同的事件。</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//对于点击事件来说，则最终会交由ViewPostImeInputStage进行处理</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">InputStage</span> <span class="cm-variable">viewPostImeStage</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">ViewPostImeInputStage</span>(<span class="cm-variable">mSyntheticInputStage</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">InputStage</span> <span class="cm-variable">nativePostImeStage</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">NativePostImeInputStage</span>(<span class="cm-variable">viewPostImeStage</span>,</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"aq:native-post-ime:"</span> <span class="cm-operator">+</span> <span class="cm-variable">counterSuffix</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">InputStage</span> <span class="cm-variable">earlyPostImeStage</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">EarlyPostImeInputStage</span>(<span class="cm-variable">nativePostImeStage</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">InputStage</span> <span class="cm-variable">imeStage</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">ImeInputStage</span>(<span class="cm-variable">earlyPostImeStage</span>,</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"aq:ime:"</span> <span class="cm-operator">+</span> <span class="cm-variable">counterSuffix</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">InputStage</span> <span class="cm-variable">viewPreImeStage</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">ViewPreImeInputStage</span>(<span class="cm-variable">imeStage</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">InputStage</span> <span class="cm-variable">nativePreImeStage</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">NativePreImeInputStage</span>(<span class="cm-variable">viewPreImeStage</span>,</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"aq:native-pre-ime:"</span> <span class="cm-operator">+</span> <span class="cm-variable">counterSuffix</span>);</span></pre>
    </div>
    </div>
    </div>
    </div>
    </div>
    <div
        style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 660px;">
    </div>
    <div class="CodeMirror-gutters" style="display: none; height: 660px;"></div>
    </div>
    </div>
    </pre>
    <p><span>这个方法里面出现了</span><code>InputStage</code><span>，它是一个基类，有各种不同的实现用来处理不同的事件，比如点击事件，我们可以看</span><code>ViewPostImeInputStage</code><span>。</span>
    </p>
    <pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"
        style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre>
    </div>
    <div class="CodeMirror-measure"></div>
    <div style="position: relative; z-index: 1;"></div>
    <div class="CodeMirror-code" role="presentation" style="">
        <div class="CodeMirror-activeline" style="position: relative;">
            <div class="CodeMirror-activeline-background CodeMirror-linebackground"></div>
            <div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div>
            <pre class=" CodeMirror-line "
                role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">ViewPostImeInputStage</span></span></pre>
        </div>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">protected</span> <span class="cm-variable-3">int</span> <span class="cm-def">onProcess</span>(<span class="cm-variable">QueuedInputEvent</span> <span class="cm-variable">q</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">if</span> (<span class="cm-variable">q</span>.<span class="cm-variable">mEvent</span> <span class="cm-keyword">instanceof</span> <span class="cm-variable">KeyEvent</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">return</span> <span class="cm-variable">processKeyEvent</span>(<span class="cm-variable">q</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span>} <span class="cm-keyword">else</span> {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">final</span> <span class="cm-variable-3">int</span> <span class="cm-variable">source</span> <span class="cm-operator">=</span> <span class="cm-variable">q</span>.<span class="cm-variable">mEvent</span>.<span class="cm-variable">getSource</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">if</span> ((<span class="cm-variable">source</span> <span class="cm-operator">&amp;</span> <span class="cm-variable">InputDevice</span>.<span class="cm-variable">SOURCE_CLASS_POINTER</span>) <span class="cm-operator">!=</span> <span class="cm-number">0</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//判断触摸事件，会走这个方法</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">return</span> <span class="cm-variable">processPointerEvent</span>(<span class="cm-variable">q</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span>} <span class="cm-keyword">else</span> <span class="cm-keyword">if</span> ((<span class="cm-variable">source</span> <span class="cm-operator">&amp;</span> <span class="cm-variable">InputDevice</span>.<span class="cm-variable">SOURCE_CLASS_TRACKBALL</span>) <span class="cm-operator">!=</span> <span class="cm-number">0</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">return</span> <span class="cm-variable">processTrackballEvent</span>(<span class="cm-variable">q</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span>} <span class="cm-keyword">else</span> {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">return</span> <span class="cm-variable">processGenericMotionEvent</span>(<span class="cm-variable">q</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span>}</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span>}</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre>
    </div>
    </div>
    </div>
    </div>
    </div>
    <div
        style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 352px;">
    </div>
    <div class="CodeMirror-gutters" style="display: none; height: 352px;"></div>
    </div>
    </div>
    </pre>
    <p><span>这里会判断事件类型，比如触摸还是键盘输入？我们看触摸事件，此时会调用</span><code>processPointerEvent</code><span>。</span></p>
    <pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded"
        lang="java"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre>
    </div>
    <div class="CodeMirror-measure"></div>
    <div style="position: relative; z-index: 1;"></div>
    <div class="CodeMirror-code" role="presentation" style="">
        <div class="CodeMirror-activeline" style="position: relative;">
            <div class="CodeMirror-activeline-background CodeMirror-linebackground"></div>
            <div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div>
            <pre class=" CodeMirror-line "
                role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">ViewPostImeInputStage</span></span></pre>
        </div>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">private</span> <span class="cm-variable-3">int</span> <span class="cm-def">processPointerEvent</span>(<span class="cm-variable">QueuedInputEvent</span> <span class="cm-variable">q</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">final</span> <span class="cm-variable">MotionEvent</span> <span class="cm-variable">event</span> <span class="cm-operator">=</span> (<span class="cm-variable">MotionEvent</span>)<span class="cm-variable">q</span>.<span class="cm-variable">mEvent</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span>...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">//调用了dispatchPointerEvent</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable-3">boolean</span> <span class="cm-variable">handled</span> <span class="cm-operator">=</span> <span class="cm-variable">mView</span>.<span class="cm-variable">dispatchPointerEvent</span>(<span class="cm-variable">event</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span>...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">return</span> <span class="cm-variable">handled</span> <span class="cm-operator">?</span> <span class="cm-variable">FINISH_HANDLED</span> : <span class="cm-variable">FORWARD</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre>
    </div>
    </div>
    </div>
    </div>
    </div>
    <div
        style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 220px;">
    </div>
    <div class="CodeMirror-gutters" style="display: none; height: 220px;"></div>
    </div>
    </div>
    </pre>
    <p><span>我们看到这里面调用了</span><code>dispatchPointerEvent</code><span>，那么这个</span><code>mView</code><span>是谁呢？当然是DecorView了，在</span><code>setView</code><span>的时候传进来的嘛。</span>
    </p>
    <p><span>接下来看DecorView的</span><code>dispatchPointerEvent</code><span>，但是找了一下竟然没发现！！！</span></p>
    <p><span>好吧，在其父类View中发现了，我们看一眼</span></p>
    <pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded"
        lang="java"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre>
    </div>
    <div class="CodeMirror-measure"></div>
    <div style="position: relative; z-index: 1;"></div>
    <div class="CodeMirror-code" role="presentation" style="">
        <div class="CodeMirror-activeline" style="position: relative;">
            <div class="CodeMirror-activeline-background CodeMirror-linebackground"></div>
            <div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div>
            <pre class=" CodeMirror-line "
                role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">View</span></span></pre>
        </div>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">final</span> <span class="cm-variable-3">boolean</span> <span class="cm-def">dispatchPointerEvent</span>(<span class="cm-variable">MotionEvent</span> <span class="cm-variable">event</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">if</span> (<span class="cm-variable">event</span>.<span class="cm-variable">isTouchEvent</span>()) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//触摸，执行</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">return</span> <span class="cm-variable">dispatchTouchEvent</span>(<span class="cm-variable">event</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span>} <span class="cm-keyword">else</span> {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">return</span> <span class="cm-variable">dispatchGenericMotionEvent</span>(<span class="cm-variable">event</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span>}</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre>
    </div>
    </div>
    </div>
    </div>
    </div>
    <div
        style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 198px;">
    </div>
    <div class="CodeMirror-gutters" style="display: none; height: 198px;"></div>
    </div>
    </div>
    </pre>
    <p><span>这里面依旧判断了是否是触摸，所以我们直接看</span><code>dispatchTouchEvent</code><span>，由于我们知道</span><code>mView</code><span>就是DecorView，而DecorView会实现</span><code>dispatchTouchEvent</code><span>方法，所以我们需要看DecorView的</span><code>dispatchTouchEvent</code><span>方法。</span>
    </p>
    <pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded"
        lang="java"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre>
    </div>
    <div class="CodeMirror-measure"></div>
    <div style="position: relative; z-index: 1;"></div>
    <div class="CodeMirror-code" role="presentation" style="">
        <div class="CodeMirror-activeline" style="position: relative;">
            <div class="CodeMirror-activeline-background CodeMirror-linebackground"></div>
            <div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div>
            <pre class=" CodeMirror-line "
                role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">DecorView</span></span></pre>
        </div>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-variable-3">boolean</span> <span class="cm-def">dispatchTouchEvent</span>(<span class="cm-variable">MotionEvent</span> <span class="cm-variable">ev</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">final</span> <span class="cm-variable">Window</span>.<span class="cm-variable">Callback</span> <span class="cm-variable">cb</span> <span class="cm-operator">=</span> <span class="cm-variable">mWindow</span>.<span class="cm-variable">getCallback</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">return</span> <span class="cm-variable">cb</span> <span class="cm-operator">!=</span> <span class="cm-atom">null</span> <span class="cm-operator">&amp;&amp;</span> <span class="cm-operator">!</span><span class="cm-variable">mWindow</span>.<span class="cm-variable">isDestroyed</span>() <span class="cm-operator">&amp;&amp;</span> <span class="cm-variable">mFeatureId</span> <span class="cm-operator">&lt;</span> <span class="cm-number">0</span> <span class="cm-operator">?</span> <span class="cm-variable">cb</span>.<span class="cm-variable">dispatchTouchEvent</span>(<span class="cm-variable">ev</span>) : <span class="cm-keyword">super</span>.<span class="cm-variable">dispatchTouchEvent</span>(<span class="cm-variable">ev</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre>
    </div>
    </div>
    </div>
    </div>
    </div>
    <div
        style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 132px;">
    </div>
    <div class="CodeMirror-gutters" style="display: none; height: 132px;"></div>
    </div>
    </div>
    </pre>
    <p><span>而在前面的章节中我们知道，在ActivityThread调用</span><code>HandleLaunchActivity</code><span>流程中，会调用到Activity的</span><code>attach</code><span>方法，在这里会创建真正的PhoneWindow，同时执行了这样依据代码</span><code>mWindow.setCallback(this);</code><span>，所以显而易见，Activity实现了</span><code>Window.Callback</code><span>接口，并且被</span><code>mWindow</code><span>所持有。所以这里面就调用到了Activity的</span><code>dispatchTouchEvent</code><span>。</span>
    </p>
    <pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded"
        lang="java"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre>
    </div>
    <div class="CodeMirror-measure"></div>
    <div style="position: relative; z-index: 1;"></div>
    <div class="CodeMirror-code" role="presentation" style="">
        <div class="CodeMirror-activeline" style="position: relative;">
            <div class="CodeMirror-activeline-background CodeMirror-linebackground"></div>
            <div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div>
            <pre class=" CodeMirror-line "
                role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Activity</span></span></pre>
        </div>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-variable-3">boolean</span> <span class="cm-def">dispatchTouchEvent</span>(<span class="cm-variable">MotionEvent</span> <span class="cm-variable">ev</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">if</span> (<span class="cm-variable">ev</span>.<span class="cm-variable">getAction</span>() <span class="cm-operator">==</span> <span class="cm-variable">MotionEvent</span>.<span class="cm-variable">ACTION_DOWN</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">onUserInteraction</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span>}</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">//通过PhoneWindow调用到DecorView的superDispatchTouchEvent方法，DecorView调用了ViewGroup的dispatchTouchEvent，开启事件分发。</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">getWindow</span>().<span class="cm-variable">superDispatchTouchEvent</span>(<span class="cm-variable">ev</span>)) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">return</span> <span class="cm-atom">true</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span>}</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">//如果没有拦截处理，则自己消费处理</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">return</span> <span class="cm-variable">onTouchEvent</span>(<span class="cm-variable">ev</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre>
    </div>
    </div>
    </div>
    </div>
    </div>
    <div
        style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 286px;">
    </div>
    <div class="CodeMirror-gutters" style="display: none; height: 286px;"></div>
    </div>
    </div>
    </pre>
    <p><span>说明一下：</span><strong><span>这里面的</span><code>getWindow().superDispatchTouchEvent(ev)</code><span>，最终会调用到DecorView的</span><code>superDispatchTouchEvent</code><span>方法，而DecorView的</span><code>superDispatchTouchEvent</code><span>会调用ViewGroup的</span><code>dispatchTouchEvent</code><span>，进而开启我们所熟知的事件分发</span></strong><span>。</span>
    </p>
    <p><span>看了上面的流程可能大家有点不理解，为什么要从DecorView绕道Activity，之后再给DecorView呢？</span></p>
    <p><strong><span>因为绕一圈，才可以将Activity作为事件分发的起点呀，当大家都不消费的事件的时候，事件就流回Activity了</span></strong><span>。</span></p>
    <p>&nbsp;</p>
    <p><strong><span>总结</span></strong></p>
    <p><span>直接看流程图就好</span></p>
    <p><img src="E:\Documentation\My_Learn_Documentation_Git\android\pic_android\event_deliver1.jpg"
            alt="event_deliver1" style="zoom:50%;" /></p>
    <h2><a name="一定要在主线程才可以更新ui吗为什么" class="md-header-anchor"></a><span>一定要在主线程才可以更新UI吗？为什么？</span></h2>
    <blockquote>
        <p><span>通过前几章节的介绍，大家应该大致都了解Android整体的窗口机制了吧。</span></p>
        <p><span>那么问一个问题，UI一定要在主线程才可以更新吗？回答这个问题之前，先看一个简单的例子</span></p>
    </blockquote>
    <p><strong><span>示例演示</span></strong></p>
    <p><span>代码如下所示：代码很简单，在</span><code>onCreate</code><span>中启动子线程（子线程的名字被设置为</span><code>Myself Thread</code><span>）更新</span><code>TextView</code><span>的</span><code>text</code><span>属性，在</span><code>onResume</code><span>函数中将当前的</span><code>text</code><span>值打印在控制台。</span>
    </p>
    <pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="kotlin"
        style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="kotlin"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre>
    </div>
    <div class="CodeMirror-measure"></div>
    <div style="position: relative; z-index: 1;"></div>
    <div class="CodeMirror-code" role="presentation" style="">
        <div class="CodeMirror-activeline" style="position: relative;">
            <div class="CodeMirror-activeline-background CodeMirror-linebackground"></div>
            <div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div>
            <pre class=" CodeMirror-line "
                role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">lateinit</span> <span class="cm-keyword">var</span> <span class="cm-def">binding</span>: <span class="cm-variable">ActivityThreadTestBinding</span></span></pre>
        </div>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">@SuppressLint</span>(<span class="cm-string">"SetTextI18n"</span>)</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">override</span> <span class="cm-keyword">fun</span> <span class="cm-def">onCreate</span>(<span class="cm-variable">savedInstanceState</span>: <span class="cm-variable">Bundle</span><span class="cm-operator">?</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">super</span>.<span class="cm-variable">onCreate</span>(<span class="cm-variable">savedInstanceState</span>)</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">binding</span> <span class="cm-operator">=</span> <span class="cm-variable">ActivityThreadTestBinding</span>.<span class="cm-variable">inflate</span>(<span class="cm-variable">layoutInflater</span>)</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">setContentView</span>(<span class="cm-variable">binding</span>.<span class="cm-variable">root</span>)</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//子线程更新text</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">Thread</span> {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">binding</span>.<span class="cm-variable">tv1</span>.<span class="cm-variable">text</span> <span class="cm-operator">=</span> <span class="cm-string">"The name of the current thread is ${Thread.currentThread().name}."</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }.<span class="cm-variable">apply</span> {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">name</span> <span class="cm-operator">=</span> <span class="cm-string">"Myself Thread"</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }.<span class="cm-variable">start</span>()</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">override</span> <span class="cm-keyword">fun</span> <span class="cm-def">onResume</span>() {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">super</span>.<span class="cm-variable">onResume</span>()</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//打印出当前控件所设置的text</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">binding</span>.<span class="cm-variable">tv1</span>.<span class="cm-variable">text</span>.<span class="cm-variable">toString</span>().<span class="cm-variable">toLogI</span>()</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre>
    </div>
    </div>
    </div>
    </div>
    </div>
    <div
        style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 462px;">
    </div>
    <div class="CodeMirror-gutters" style="display: none; height: 462px;"></div>
    </div>
    </div>
    </pre>
    <p><span>大家可以猜测一下，上述代码可以正常运行吗❓</span></p>
    <p><strong><span>答案是</span></strong><span>：可以正常运行，并且控制台打印出来了</span><code>The name of the current thread is Myself Thread.</code>
    </p>
    <p><span>啊😮？这是为什么呢？子线程竟然更新UI竟然没有抛异常而且成功了🤦‍♀️？不着急，我们慢慢分析。</span></p>
    <p>&nbsp;</p>
    <p><strong><span>为什么子线程可以更新UI呢？下面我们分析一下。</span></strong></p>
    <p><span>我们知道视图更新会调用View的</span><code>requestLayout</code><span>或者</span><code>invalidate</code><span>方法，而这两个方法均会调用ViewRootImpl的</span><code>requestLayout</code><span>方法，进而调用到ViewRootImpl的</span><code>scheduleTraversals</code><span>，好的我们回顾一下ViewRootImpl的</span><code>requestLayout</code><span>方法。</span>
    </p>
    <pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"
        style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre>
    </div>
    <div class="CodeMirror-measure"></div>
    <div style="position: relative; z-index: 1;"></div>
    <div class="CodeMirror-code" role="presentation" style="">
        <div class="CodeMirror-activeline" style="position: relative;">
            <div class="CodeMirror-activeline-background CodeMirror-linebackground"></div>
            <div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div>
            <pre class=" CodeMirror-line "
                role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">ViewRootImpl</span></span></pre>
        </div>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-def">requestLayout</span>() {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-operator">!</span><span class="cm-variable">mHandlingLayoutInLayoutRequest</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//判断当前是否是主线程即mThread,如果不是，则抛异常。就是在子线程更新UI没使用handler的话就会抛出的异常</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">checkThread</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//设置mLayoutRequested为true。</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mLayoutRequested</span> <span class="cm-operator">=</span> <span class="cm-atom">true</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//进而测量、布局、绘制</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">scheduleTraversals</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//判断当前线程如果不是主线程的话，则抛出异常</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">void</span> <span class="cm-def">checkThread</span>() {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">mThread</span> <span class="cm-operator">!=</span> <span class="cm-variable">Thread</span>.<span class="cm-variable">currentThread</span>()) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">throw</span> <span class="cm-keyword">new</span> <span class="cm-variable">CalledFromWrongThreadException</span>(</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"Only the original thread that created a view hierarchy can touch its views."</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre>
    </div>
    </div>
    </div>
    </div>
    </div>
    <div
        style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 396px;">
    </div>
    <div class="CodeMirror-gutters" style="display: none; height: 396px;"></div>
    </div>
    </div>
    </pre>
    <p><span>看得到，在ViewRootImpl的</span><code>checkThread</code><span>的方法里面，会进行判断，如果不是主线程的话，就抛出异常（就是我们常见的不能在子线程更新UI的异常）。</span>
    </p>
    <p><span>那么聪明的同学们可能就要发问了，那为什么上面的代码没有抛异常还运行成功了？</span></p>
    <p>&nbsp;</p>
    <p><span>我们再回忆一下前面的章节内容，</span><strong><span>ViewRootImpl是在什么时候被实例化的呢</span></strong><span>？</span></p>
    <p><span>流程大致如下：</span><code>ActivityThread.handleResumeActivity -&gt; Activity.onResume -&gt; WindowManagerGlobal.addView -&gt; new ViewRootImpl -&gt; ViewRootImpl.setView -&gt; View.assignParent(this)</code>
    </p>
    <p><span>就是在系统准备显示界面的时候，直观一点的话，就是在Activity的</span><code>onResume</code><span>方法被调用之后，会新创建一个</span><code>ViewRootImpl</code><span>，之后会调用其</span><code>setView</code><span>方法，里面调用到DecorView的</span><code>assignParent</code><span>方法，将其分配给View的</span><code>mParent</code><span>变量。</span>
    </p>
    <p>&nbsp;</p>
    <p><span>所以综上所述：</span><strong><span>在</span><code>onCreate</code><span>方法里面调用设置UI的时候，并没有进行实际的绘制流程，因为ViewRootImpl还没有被设置，那么猜测我们设置的值，应该是被View存在内存了，等到进行真正执行绘制流程的时候，才被渲染出来</span></strong><span>。</span>
    </p>
    <p><span>下面进行上述猜测验证，简单分析一下</span><code>TextView.setText</code><span>的流程。</span></p>
    <pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"
        style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre>
    </div>
    <div class="CodeMirror-measure"></div>
    <div style="position: relative; z-index: 1;"></div>
    <div class="CodeMirror-code" role="presentation" style="">
        <div class="CodeMirror-activeline" style="position: relative;">
            <div class="CodeMirror-activeline-background CodeMirror-linebackground"></div>
            <div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div>
            <pre class=" CodeMirror-line "
                role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">TextView</span> </span></pre>
        </div>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">private</span> <span class="cm-variable-3">void</span> <span class="cm-def">setText</span>(<span class="cm-variable">CharSequence</span> <span class="cm-variable">text</span>, <span class="cm-variable">BufferType</span> <span class="cm-variable">type</span>, <span class="cm-variable-3">boolean</span> <span class="cm-variable">notifyBefore</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">oldlen</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span>...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">//将value设置到内存</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">setTextInternal</span>(<span class="cm-variable">text</span>)</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">//具体绘制调用</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">mLayout</span> <span class="cm-operator">!=</span> <span class="cm-atom">null</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">checkForRelayout</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">private</span> <span class="cm-variable-3">void</span> <span class="cm-def">setTextInternal</span>(<span class="cm-meta">@Nullable</span> <span class="cm-variable">CharSequence</span> <span class="cm-variable">text</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">//内存中储存text值</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">mText</span> <span class="cm-operator">=</span> <span class="cm-variable">text</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">mSpannable</span> <span class="cm-operator">=</span> (<span class="cm-variable">text</span> <span class="cm-keyword">instanceof</span> <span class="cm-variable">Spannable</span>) <span class="cm-operator">?</span> (<span class="cm-variable">Spannable</span>) <span class="cm-variable">text</span> : <span class="cm-atom">null</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">mPrecomputed</span> <span class="cm-operator">=</span> (<span class="cm-variable">text</span> <span class="cm-keyword">instanceof</span> <span class="cm-variable">PrecomputedText</span>) <span class="cm-operator">?</span> (<span class="cm-variable">PrecomputedText</span>) <span class="cm-variable">text</span> : <span class="cm-atom">null</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">private</span> <span class="cm-variable-3">void</span> <span class="cm-def">checkForRelayout</span>() {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">//则机会调用view的这两个方法</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">requestLayout</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">invalidate</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//View的requestLayout</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-def">requestLayout</span>() {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">//mParent指的是ViewRootImpl，如果是在onCreate的时候异步线程更新UI的话，此时mParent为null，所以不会具体的进行绘制，所以就不会抛异常</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">mParent</span> <span class="cm-operator">!=</span> <span class="cm-atom">null</span> <span class="cm-operator">&amp;&amp;</span> <span class="cm-operator">!</span><span class="cm-variable">mParent</span>.<span class="cm-variable">isLayoutRequested</span>()) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mParent</span>.<span class="cm-variable">requestLayout</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre>
    </div>
    </div>
    </div>
    </div>
    </div>
    <div
        style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 814px;">
    </div>
    <div class="CodeMirror-gutters" style="display: none; height: 814px;"></div>
    </div>
    </div>
    </pre>
    <p><span>显而易见，在</span><code>onCreate</code><span>中更新UI时，只是把值保存到了内存中，当视图真正渲染时，才进行正常的绘制流程。</span></p>
    <p><span>比如如果我们把异步线程</span><code>setText</code><span>的操作，放到一个按钮里面，通过点击实现，那么一定会抛出异常（因为此时界面已经显示出来了）。如下所示：</span></p>
    <pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="kotlin"
        style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="kotlin"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre>
    </div>
    <div class="CodeMirror-measure"></div>
    <div style="position: relative; z-index: 1;"></div>
    <div class="CodeMirror-code" role="presentation" style="">
        <div class="CodeMirror-activeline" style="position: relative;">
            <div class="CodeMirror-activeline-background CodeMirror-linebackground"></div>
            <div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div>
            <pre class=" CodeMirror-line "
                role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">binding</span>.<span class="cm-variable">bt1</span>.<span class="cm-variable">setOnClickListener</span> {</span></pre>
        </div>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable-3">Thread</span> {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">binding</span>.<span class="cm-variable">tv1</span>.<span class="cm-variable">text</span> <span class="cm-operator">=</span> <span class="cm-string">"The name of the current thread is ${Thread.currentThread().name}."</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span>}.<span class="cm-variable">apply</span> {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">name</span> <span class="cm-operator">=</span> <span class="cm-string">"Myself Thread2"</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span>}.<span class="cm-variable">start</span>()</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">点击，控制台打印的异常信息如下：</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  <span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">android</span>.<span class="cm-variable">view</span>.<span class="cm-variable">ViewRootImpl$CalledFromWrongThreadException</span>: <span class="cm-variable">Only</span> <span class="cm-variable">the</span> <span class="cm-variable">original</span> <span class="cm-variable">thread</span> <span class="cm-variable">that</span> <span class="cm-variable">created</span> <span class="cm-variable">a</span> <span class="cm-variable">view</span> <span class="cm-variable">hierarchy</span> <span class="cm-variable">can</span> <span class="cm-variable">touch</span> <span class="cm-variable">its</span> <span class="cm-variable">views</span>.</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">at</span> <span class="cm-variable">android</span>.<span class="cm-variable">view</span>.<span class="cm-variable">ViewRootImpl</span>.<span class="cm-variable">checkThread</span>(<span class="cm-variable">ViewRootImpl</span>.<span class="cm-variable">java</span>:<span class="cm-number">9328</span>)</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">at</span> <span class="cm-variable">com</span>.<span class="cm-variable">pumpkin</span>.<span class="cm-variable">automatic_execution</span>.<span class="cm-variable">View</span>.<span class="cm-variable">ThreadTestActivity</span>.<span class="cm-variable">onCreate$lambda</span><span class="cm-operator">-</span><span class="cm-number">2</span><span class="cm-variable">$lambda</span><span class="cm-operator">-</span><span class="cm-number">0</span>(<span class="cm-variable">ThreadTestActivity</span>.<span class="cm-variable">kt</span>:<span class="cm-number">24</span>)</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre>
    </div>
    </div>
    </div>
    </div>
    </div>
    <div
        style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 352px;">
    </div>
    <div class="CodeMirror-gutters" style="display: none; height: 352px;"></div>
    </div>
    </div>
    </pre>
    <p><span>看看抛出的异常堆栈信息了吗？在ViewRootImpl的</span><code>checkThread</code><span>方法。</span></p>
    <p><span>好了 ， 以上的分析就到这里。</span></p>
    <p><span>那么ViewRootImpl判断的线程，能不能自己设置呢？Dialog就可以设置，想知道怎么操作的小伙伴可以等下一章节噢🙆‍♀️</span></p>
    <h2><a name="activity的token和dialog的关系" class="md-header-anchor"></a><span>Activity的Token和Dialog的关系</span></h2>
    <blockquote>
        <p><span>前面几个章节已经搞清楚Activity的窗口加载过程，那么其他窗口呢？今天我们分析一下Dialog，搞清楚以下几个问题：</span></p>
    </blockquote>
    <ol start=''>
        <li><span>token是什么？</span></li>
        <li><span>Dialog为什么一定需要Activity作为Context</span></li>
        <li><span>Dialog弹出后对于Activity生命周期有何影响</span></li>
        <li><span>如何正确的设置到Dialog的宽高</span></li>
    </ol>
    <p><strong><span>前言</span></strong></p>
    <p><span>首先大家需要了解一下</span><code>LayoutParams</code><span>，当然属性很多，简单了解即可：</span></p>
    <pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"
        style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre>
    </div>
    <div class="CodeMirror-measure"></div>
    <div style="position: relative; z-index: 1;"></div>
    <div class="CodeMirror-code" role="presentation" style="">
        <div class="CodeMirror-activeline" style="position: relative;">
            <div class="CodeMirror-activeline-background CodeMirror-linebackground"></div>
            <div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div>
            <pre class=" CodeMirror-line "
                role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-tab" role="presentation" cm-text="	"> </span><span class="cm-tab" role="presentation" cm-text="	">  </span>...</span></pre>
        </div>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//窗口类型</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//有3种主要类型如下：</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//ApplicationWindows取值在FIRST_APPLICATION_WINDOW与LAST_APPLICATION_WINDOW之间，是常用的顶层应用程序窗口，须将token设置成Activity的token；</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//SubWindows取值在FIRST_SUB_WINDOW和LAST_SUB_WINDOW之间，与顶层窗口相关联，需将token设置成它所附着宿主窗口的token；</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//SystemWindows取值在FIRST_SYSTEM_WINDOW和LAST_SYSTEM_WINDOW之间，不能用于应用程序，使用时需要有特殊权限，它是特定的系统功能才能使用；</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">int</span> <span class="cm-variable">type</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//WindowType：开始应用程序窗口</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable-3">int</span> <span class="cm-variable">FIRST_APPLICATION_WINDOW</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//WindowType：所有程序窗口的base窗口，其他应用程序窗口都显示在它上面</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable-3">int</span> <span class="cm-variable">TYPE_BASE_APPLICATION</span> &nbsp; <span class="cm-operator">=</span> <span class="cm-number">1</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//WindowType：普通应用程序窗口，token必须设置为Activity的token来指定窗口属于谁</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable-3">int</span> <span class="cm-variable">TYPE_APPLICATION</span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-number">2</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//WindowType：应用程序启动时所显示的窗口，应用自己不要使用这种类型，它被系统用来显示一些信息，直到应用程序可以开启自己的窗口为止</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable-3">int</span> <span class="cm-variable">TYPE_APPLICATION_STARTING</span> <span class="cm-operator">=</span> <span class="cm-number">3</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//WindowType：结束应用程序窗口</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable-3">int</span> <span class="cm-variable">LAST_APPLICATION_WINDOW</span> <span class="cm-operator">=</span> <span class="cm-number">99</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//WindowType：SubWindows子窗口，子窗口的Z序和坐标空间都依赖于他们的宿主窗口</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable-3">int</span> <span class="cm-variable">FIRST_SUB_WINDOW</span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-number">1000</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//WindowType： 面板窗口，显示于宿主窗口的上层</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable-3">int</span> <span class="cm-variable">TYPE_APPLICATION_PANEL</span> &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">FIRST_SUB_WINDOW</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//WindowType：媒体窗口（例如视频），显示于宿主窗口下层</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable-3">int</span> <span class="cm-variable">TYPE_APPLICATION_MEDIA</span> &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">FIRST_SUB_WINDOW</span><span class="cm-operator">+</span><span class="cm-number">1</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//WindowType：应用程序窗口的子面板，显示于所有面板窗口的上层</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable-3">int</span> <span class="cm-variable">TYPE_APPLICATION_SUB_PANEL</span> <span class="cm-operator">=</span> <span class="cm-variable">FIRST_SUB_WINDOW</span><span class="cm-operator">+</span><span class="cm-number">2</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//WindowType：对话框，类似于面板窗口，绘制类似于顶层窗口，而不是宿主的子窗口</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable-3">int</span> <span class="cm-variable">TYPE_APPLICATION_ATTACHED_DIALOG</span> <span class="cm-operator">=</span> <span class="cm-variable">FIRST_SUB_WINDOW</span><span class="cm-operator">+</span><span class="cm-number">3</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//WindowType：媒体信息，显示在媒体层和程序窗口之间，需要实现半透明效果</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable-3">int</span> <span class="cm-variable">TYPE_APPLICATION_MEDIA_OVERLAY</span> &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">FIRST_SUB_WINDOW</span><span class="cm-operator">+</span><span class="cm-number">4</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//WindowType：子窗口结束</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable-3">int</span> <span class="cm-variable">LAST_SUB_WINDOW</span> &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-number">1999</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//WindowType：系统窗口，非应用程序创建</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable-3">int</span> <span class="cm-variable">FIRST_SYSTEM_WINDOW</span> &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-number">2000</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//WindowType：状态栏，只能有一个状态栏，位于屏幕顶端，其他窗口都位于它下方</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable-3">int</span> <span class="cm-variable">TYPE_STATUS_BAR</span> &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">FIRST_SYSTEM_WINDOW</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//WindowType：搜索栏，只能有一个搜索栏，位于屏幕上方</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable-3">int</span> <span class="cm-variable">TYPE_SEARCH_BAR</span> &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">FIRST_SYSTEM_WINDOW</span><span class="cm-operator">+</span><span class="cm-number">1</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//WindowType：电话窗口，它用于电话交互（特别是呼入），置于所有应用程序之上，状态栏之下</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable-3">int</span> <span class="cm-variable">TYPE_PHONE</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">FIRST_SYSTEM_WINDOW</span><span class="cm-operator">+</span><span class="cm-number">2</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//WindowType：系统提示，出现在应用程序窗口之上</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable-3">int</span> <span class="cm-variable">TYPE_SYSTEM_ALERT</span> &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">FIRST_SYSTEM_WINDOW</span><span class="cm-operator">+</span><span class="cm-number">3</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//WindowType：锁屏窗口</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable-3">int</span> <span class="cm-variable">TYPE_KEYGUARD</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">FIRST_SYSTEM_WINDOW</span><span class="cm-operator">+</span><span class="cm-number">4</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//WindowType：信息窗口，用于显示Toast</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable-3">int</span> <span class="cm-variable">TYPE_TOAST</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">FIRST_SYSTEM_WINDOW</span><span class="cm-operator">+</span><span class="cm-number">5</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//WindowType：系统顶层窗口，显示在其他一切内容之上，此窗口不能获得输入焦点，否则影响锁屏</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable-3">int</span> <span class="cm-variable">TYPE_SYSTEM_OVERLAY</span> &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">FIRST_SYSTEM_WINDOW</span><span class="cm-operator">+</span><span class="cm-number">6</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//WindowType：电话优先，当锁屏时显示，此窗口不能获得输入焦点，否则影响锁屏</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable-3">int</span> <span class="cm-variable">TYPE_PRIORITY_PHONE</span> &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">FIRST_SYSTEM_WINDOW</span><span class="cm-operator">+</span><span class="cm-number">7</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//WindowType：系统对话框</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable-3">int</span> <span class="cm-variable">TYPE_SYSTEM_DIALOG</span> &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">FIRST_SYSTEM_WINDOW</span><span class="cm-operator">+</span><span class="cm-number">8</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//WindowType：锁屏时显示的对话框</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable-3">int</span> <span class="cm-variable">TYPE_KEYGUARD_DIALOG</span> &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">FIRST_SYSTEM_WINDOW</span><span class="cm-operator">+</span><span class="cm-number">9</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//WindowType：系统内部错误提示，显示于所有内容之上</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable-3">int</span> <span class="cm-variable">TYPE_SYSTEM_ERROR</span> &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">FIRST_SYSTEM_WINDOW</span><span class="cm-operator">+</span><span class="cm-number">10</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//WindowType：内部输入法窗口，显示于普通UI之上，应用程序可重新布局以免被此窗口覆盖</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable-3">int</span> <span class="cm-variable">TYPE_INPUT_METHOD</span> &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">FIRST_SYSTEM_WINDOW</span><span class="cm-operator">+</span><span class="cm-number">11</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//WindowType：内部输入法对话框，显示于当前输入法窗口之上</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable-3">int</span> <span class="cm-variable">TYPE_INPUT_METHOD_DIALOG</span><span class="cm-operator">=</span> <span class="cm-variable">FIRST_SYSTEM_WINDOW</span><span class="cm-operator">+</span><span class="cm-number">12</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//WindowType：墙纸窗口</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable-3">int</span> <span class="cm-variable">TYPE_WALLPAPER</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-variable">FIRST_SYSTEM_WINDOW</span><span class="cm-operator">+</span><span class="cm-number">13</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//WindowType：状态栏的滑动面板</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable-3">int</span> <span class="cm-variable">TYPE_STATUS_BAR_PANEL</span> &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">FIRST_SYSTEM_WINDOW</span><span class="cm-operator">+</span><span class="cm-number">14</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//WindowType：安全系统覆盖窗口，这些窗户必须不带输入焦点，否则会干扰键盘</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable-3">int</span> <span class="cm-variable">TYPE_SECURE_SYSTEM_OVERLAY</span> <span class="cm-operator">=</span> <span class="cm-variable">FIRST_SYSTEM_WINDOW</span><span class="cm-operator">+</span><span class="cm-number">15</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//WindowType：拖放伪窗口，只有一个阻力层(最多)，它被放置在所有其他窗口上面</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable-3">int</span> <span class="cm-variable">TYPE_DRAG</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">FIRST_SYSTEM_WINDOW</span><span class="cm-operator">+</span><span class="cm-number">16</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//WindowType：状态栏下拉面板</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable-3">int</span> <span class="cm-variable">TYPE_STATUS_BAR_SUB_PANEL</span> <span class="cm-operator">=</span> <span class="cm-variable">FIRST_SYSTEM_WINDOW</span><span class="cm-operator">+</span><span class="cm-number">17</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//WindowType：鼠标指针</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable-3">int</span> <span class="cm-variable">TYPE_POINTER</span> <span class="cm-operator">=</span> <span class="cm-variable">FIRST_SYSTEM_WINDOW</span><span class="cm-operator">+</span><span class="cm-number">18</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//WindowType：导航栏(有别于状态栏时)</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable-3">int</span> <span class="cm-variable">TYPE_NAVIGATION_BAR</span> <span class="cm-operator">=</span> <span class="cm-variable">FIRST_SYSTEM_WINDOW</span><span class="cm-operator">+</span><span class="cm-number">19</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//WindowType：音量级别的覆盖对话框，显示当用户更改系统音量大小</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable-3">int</span> <span class="cm-variable">TYPE_VOLUME_OVERLAY</span> <span class="cm-operator">=</span> <span class="cm-variable">FIRST_SYSTEM_WINDOW</span><span class="cm-operator">+</span><span class="cm-number">20</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//WindowType：起机进度框，在一切之上</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable-3">int</span> <span class="cm-variable">TYPE_BOOT_PROGRESS</span> <span class="cm-operator">=</span> <span class="cm-variable">FIRST_SYSTEM_WINDOW</span><span class="cm-operator">+</span><span class="cm-number">21</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//WindowType：假窗，消费导航栏隐藏时触摸事件</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable-3">int</span> <span class="cm-variable">TYPE_HIDDEN_NAV_CONSUMER</span> <span class="cm-operator">=</span> <span class="cm-variable">FIRST_SYSTEM_WINDOW</span><span class="cm-operator">+</span><span class="cm-number">22</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//WindowType：梦想(屏保)窗口，略高于键盘</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable-3">int</span> <span class="cm-variable">TYPE_DREAM</span> <span class="cm-operator">=</span> <span class="cm-variable">FIRST_SYSTEM_WINDOW</span><span class="cm-operator">+</span><span class="cm-number">23</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//WindowType：导航栏面板(不同于状态栏的导航栏)</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable-3">int</span> <span class="cm-variable">TYPE_NAVIGATION_BAR_PANEL</span> <span class="cm-operator">=</span> <span class="cm-variable">FIRST_SYSTEM_WINDOW</span><span class="cm-operator">+</span><span class="cm-number">24</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//WindowType：universe背后真正的窗户</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable-3">int</span> <span class="cm-variable">TYPE_UNIVERSE_BACKGROUND</span> <span class="cm-operator">=</span> <span class="cm-variable">FIRST_SYSTEM_WINDOW</span><span class="cm-operator">+</span><span class="cm-number">25</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//WindowType：显示窗口覆盖，用于模拟辅助显示设备</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable-3">int</span> <span class="cm-variable">TYPE_DISPLAY_OVERLAY</span> <span class="cm-operator">=</span> <span class="cm-variable">FIRST_SYSTEM_WINDOW</span><span class="cm-operator">+</span><span class="cm-number">26</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//WindowType：放大窗口覆盖，用于突出显示的放大部分可访问性放大时启用</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable-3">int</span> <span class="cm-variable">TYPE_MAGNIFICATION_OVERLAY</span> <span class="cm-operator">=</span> <span class="cm-variable">FIRST_SYSTEM_WINDOW</span><span class="cm-operator">+</span><span class="cm-number">27</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//WindowType：......</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable-3">int</span> <span class="cm-variable">TYPE_KEYGUARD_SCRIM</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">=</span> <span class="cm-variable">FIRST_SYSTEM_WINDOW</span><span class="cm-operator">+</span><span class="cm-number">29</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable-3">int</span> <span class="cm-variable">TYPE_PRIVATE_PRESENTATION</span> <span class="cm-operator">=</span> <span class="cm-variable">FIRST_SYSTEM_WINDOW</span><span class="cm-operator">+</span><span class="cm-number">30</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable-3">int</span> <span class="cm-variable">TYPE_VOICE_INTERACTION</span> <span class="cm-operator">=</span> <span class="cm-variable">FIRST_SYSTEM_WINDOW</span><span class="cm-operator">+</span><span class="cm-number">31</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable-3">int</span> <span class="cm-variable">TYPE_ACCESSIBILITY_OVERLAY</span> <span class="cm-operator">=</span> <span class="cm-variable">FIRST_SYSTEM_WINDOW</span><span class="cm-operator">+</span><span class="cm-number">32</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//WindowType：系统窗口结束</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable-3">int</span> <span class="cm-variable">LAST_SYSTEM_WINDOW</span> &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-number">2999</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  ......</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre>
    </div>
    </div>
    </div>
    </div>
    </div>
    <div
        style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 2310px;">
    </div>
    <div class="CodeMirror-gutters" style="display: none; height: 2310px;"></div>
    </div>
    </div>
    </pre>
    <p><span>这里需要我们知道的是</span><code>WindowManager.LayoutParams</code><span>有三种窗口type，分别对应为：</span></p>
    <ul>
        <li><span>应用窗口程序：type值在</span><code>FIRST_APPLICATION_WINDOW ~ LAST_APPLICATION_WINDOW</code><span>，</span><strong><span>必须将</span><code>token</code><span>设置为Activity的</span><code>token</code></strong><span>。比如Dialog。</span>
        </li>
        <li><span>子窗口：
                type值在</span><code>FIRST_SUB_WINDOW ~ LAST_SUB_WINDOW SubWindows</code><span>，</span><strong><span>必须将</span><code>token</code><span>设置为Activity的</span><code>token</code></strong><span>。比如PopupWindow。</span>
        </li>
        <li><span>系统窗口：
                type值在</span><code>FIRST_SYSTEM_WINDOW ~ LAST_SYSTEM_WINDOW</code><span>，使用需要权限，属于特定的系统功能。比如Toast。</span>
        </li>
    </ul>
    <p><span>这里就说到了</span><code>token</code><span>的问题，应用窗口程序和子窗口均需要获取到Activity的token。那么token是什么呢？</span></p>
    <p>&nbsp;</p>
    <p><strong><span>token</span></strong></p>
    <p><code>AMS(ActivityManagerService)</code><span>和</span><code>ActivityThread</code><span>之间的通信采用了token来对Activity进行标识，且</span><code>WMS(WindowManagerService)</code><span>会用token进行鉴别，只有符合条件的</span><code>window</code><span>才会被添加。</span>
    </p>
    <p><span>那么token是怎么保存的呢？</span></p>
    <pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"
        style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre>
    </div>
    <div class="CodeMirror-measure"></div>
    <div style="position: relative; z-index: 1;"></div>
    <div class="CodeMirror-code" role="presentation" style="">
        <div class="CodeMirror-activeline" style="position: relative;">
            <div class="CodeMirror-activeline-background CodeMirror-linebackground"></div>
            <div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div>
            <pre class=" CodeMirror-line "
                role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Activity</span></span></pre>
        </div>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">final</span> <span class="cm-variable-3">void</span> <span class="cm-def">attach</span>(<span class="cm-variable">Context</span> <span class="cm-variable">context</span>, <span class="cm-variable">ActivityThread</span> <span class="cm-variable">aThread</span>,</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Instrumentation</span> <span class="cm-variable">instr</span>, <span class="cm-variable">IBinder</span> <span class="cm-variable">token</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">ident</span>,</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Application</span> <span class="cm-variable">application</span>, <span class="cm-variable">Intent</span> <span class="cm-variable">intent</span>, <span class="cm-variable">ActivityInfo</span> <span class="cm-variable">info</span>,</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">CharSequence</span> <span class="cm-variable">title</span>, <span class="cm-variable">Activity</span> <span class="cm-variable">parent</span>, <span class="cm-variable-3">String</span> <span class="cm-variable">id</span>,</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">NonConfigurationInstances</span> <span class="cm-variable">lastNonConfigurationInstances</span>,</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Configuration</span> <span class="cm-variable">config</span>, <span class="cm-variable-3">String</span> <span class="cm-variable">referrer</span>, <span class="cm-variable">IVoiceInteractor</span> <span class="cm-variable">voiceInteractor</span>,</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Window</span> <span class="cm-variable">window</span>, <span class="cm-variable">ActivityConfigCallback</span> <span class="cm-variable">activityConfigCallback</span>, <span class="cm-variable">IBinder</span> <span class="cm-variable">assistToken</span>,</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">IBinder</span> <span class="cm-variable">shareableActivityToken</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">mWindow</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">PhoneWindow</span>(<span class="cm-keyword">this</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">mToken</span> <span class="cm-operator">=</span> <span class="cm-variable">token</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; <span class="cm-tab" role="presentation" cm-text="	"> </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span> <span class="cm-variable">mWindow</span>.<span class="cm-variable">setWindowManager</span>(</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  (<span class="cm-variable">WindowManager</span>)<span class="cm-variable">context</span>.<span class="cm-variable">getSystemService</span>(<span class="cm-variable">Context</span>.<span class="cm-variable">WINDOW_SERVICE</span>),</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mToken</span>, <span class="cm-variable">mComponent</span>.<span class="cm-variable">flattenToString</span>(),</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  (<span class="cm-variable">info</span>.<span class="cm-variable">flags</span> <span class="cm-operator">&amp;</span> <span class="cm-variable">ActivityInfo</span>.<span class="cm-variable">FLAG_HARDWARE_ACCELERATED</span>) <span class="cm-operator">!=</span> <span class="cm-number">0</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre>
    </div>
    </div>
    </div>
    </div>
    </div>
    <div
        style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 396px;">
    </div>
    <div class="CodeMirror-gutters" style="display: none; height: 396px;"></div>
    </div>
    </div>
    </pre>
    <p><span>从前面我知道ActivityThread通过调用</span><code>performLaunchActivity</code><span>来启动Activity，随后调用Activity的attach的方法，会传入token。Activity自己会保存一份，随后传入</span><code>mWindow.setWindowManager</code><span>中。</span>
    </p>
    <pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"
        style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre>
    </div>
    <div class="CodeMirror-measure"></div>
    <div style="position: relative; z-index: 1;"></div>
    <div class="CodeMirror-code" role="presentation" style="">
        <div class="CodeMirror-activeline" style="position: relative;">
            <div class="CodeMirror-activeline-background CodeMirror-linebackground"></div>
            <div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div>
            <pre class=" CodeMirror-line "
                role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-def">setWindowManager</span>(<span class="cm-variable">WindowManager</span> <span class="cm-variable">wm</span>, <span class="cm-variable">IBinder</span> <span class="cm-variable">appToken</span>, <span class="cm-variable-3">String</span> <span class="cm-variable">appName</span>,</span></pre>
        </div>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">boolean</span> <span class="cm-variable">hardwareAccelerated</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mAppToken</span> <span class="cm-operator">=</span> <span class="cm-variable">appToken</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mAppName</span> <span class="cm-operator">=</span> <span class="cm-variable">appName</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mHardwareAccelerated</span> <span class="cm-operator">=</span> <span class="cm-variable">hardwareAccelerated</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">wm</span> <span class="cm-operator">==</span> <span class="cm-atom">null</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">wm</span> <span class="cm-operator">=</span> (<span class="cm-variable">WindowManager</span>)<span class="cm-variable">mContext</span>.<span class="cm-variable">getSystemService</span>(<span class="cm-variable">Context</span>.<span class="cm-variable">WINDOW_SERVICE</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mWindowManager</span> <span class="cm-operator">=</span> ((<span class="cm-variable">WindowManagerImpl</span>)<span class="cm-variable">wm</span>).<span class="cm-variable">createLocalWindowManager</span>(<span class="cm-keyword">this</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">//WindowManager，并且赋值当前的window给到parentWindow属性</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable">WindowManagerImpl</span> <span class="cm-def">createLocalWindowManager</span>(<span class="cm-variable">Window</span> <span class="cm-variable">parentWindow</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-keyword">new</span> <span class="cm-variable">WindowManagerImpl</span>(<span class="cm-variable">mContext</span>, <span class="cm-variable">parentWindow</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre>
    </div>
    </div>
    </div>
    </div>
    </div>
    <div
        style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 308px;">
    </div>
    <div class="CodeMirror-gutters" style="display: none; height: 308px;"></div>
    </div>
    </div>
    </pre>
    <p><span>在</span><code>setWindowManager</code><span>方法中，token被赋值到Window的</span><code>mAppToken</code><span>属性上，同时在当前Window上创建了WindowManager。</span>
    </p>
    <p>&nbsp;</p>
    <p><span>接下来再看</span><code>addView</code><span>，在前面章节的分析中，我们知道</span><code>addView</code><span>最终在</span><code>WindowManagerGlobal</code><span>中进行了实现，</span>
    </p>
    <pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded"
        lang="java"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre>
    </div>
    <div class="CodeMirror-measure"></div>
    <div style="position: relative; z-index: 1;"></div>
    <div class="CodeMirror-code" role="presentation" style="">
        <div class="CodeMirror-activeline" style="position: relative;">
            <div class="CodeMirror-activeline-background CodeMirror-linebackground"></div>
            <div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div>
            <pre class=" CodeMirror-line "
                role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">WindowManagerGlobal</span></span></pre>
        </div>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-def">addView</span>(<span class="cm-variable">View</span> <span class="cm-variable">view</span>, <span class="cm-variable">ViewGroup</span>.<span class="cm-variable">LayoutParams</span> <span class="cm-variable">params</span>,</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Display</span> <span class="cm-variable">display</span>, <span class="cm-variable">Window</span> <span class="cm-variable">parentWindow</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">userId</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">final</span> <span class="cm-variable">WindowManager</span>.<span class="cm-variable">LayoutParams</span> <span class="cm-variable">wparams</span> <span class="cm-operator">=</span> (<span class="cm-variable">WindowManager</span>.<span class="cm-variable">LayoutParams</span>) <span class="cm-variable">params</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">parentWindow</span> <span class="cm-operator">!=</span> <span class="cm-atom">null</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">parentWindow</span>.<span class="cm-variable">adjustLayoutParamsForSubWindow</span>(<span class="cm-variable">wparams</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  } </span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre>
    </div>
    </div>
    </div>
    </div>
    </div>
    <div
        style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 220px;">
    </div>
    <div class="CodeMirror-gutters" style="display: none; height: 220px;"></div>
    </div>
    </div>
    </pre>
    <p><span>由前面的</span><code>parentWindow</code><span>赋值情况我们知道，对于Activity启动流程来说，走到这里，</span><code>parentWindow</code><span>一定是不为null的。</span>
    </p>
    <p><span>其实：只有系统窗口，</span><code>parentWindow</code><span>才会为null。</span></p>
    <pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"
        style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre>
    </div>
    <div class="CodeMirror-measure"></div>
    <div style="position: relative; z-index: 1;"></div>
    <div class="CodeMirror-code" role="presentation" style="">
        <div class="CodeMirror-activeline" style="position: relative;">
            <div class="CodeMirror-activeline-background CodeMirror-linebackground"></div>
            <div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div>
            <pre class=" CodeMirror-line "
                role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">window</span></span></pre>
        </div>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">void</span> <span class="cm-def">adjustLayoutParamsForSubWindow</span>(<span class="cm-variable">WindowManager</span>.<span class="cm-variable">LayoutParams</span> <span class="cm-variable">wp</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">CharSequence</span> <span class="cm-variable">curTitle</span> <span class="cm-operator">=</span> <span class="cm-variable">wp</span>.<span class="cm-variable">getTitle</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">wp</span>.<span class="cm-variable">type</span> <span class="cm-operator">&gt;=</span> <span class="cm-variable">WindowManager</span>.<span class="cm-variable">LayoutParams</span>.<span class="cm-variable">FIRST_SUB_WINDOW</span> <span class="cm-operator">&amp;&amp;</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">wp</span>.<span class="cm-variable">type</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">WindowManager</span>.<span class="cm-variable">LayoutParams</span>.<span class="cm-variable">LAST_SUB_WINDOW</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">wp</span>.<span class="cm-variable">token</span> <span class="cm-operator">==</span> <span class="cm-atom">null</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">View</span> <span class="cm-variable">decor</span> <span class="cm-operator">=</span> <span class="cm-variable">peekDecorView</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">decor</span> <span class="cm-operator">!=</span> <span class="cm-atom">null</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//子窗口，则给到父window即Activity的token</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">wp</span>.<span class="cm-variable">token</span> <span class="cm-operator">=</span> <span class="cm-variable">decor</span>.<span class="cm-variable">getWindowToken</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">else</span> {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">wp</span>.<span class="cm-variable">token</span> <span class="cm-operator">==</span> <span class="cm-atom">null</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//否则token则是自己</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">wp</span>.<span class="cm-variable">token</span> <span class="cm-operator">=</span> <span class="cm-variable">mContainer</span> <span class="cm-operator">==</span> <span class="cm-atom">null</span> <span class="cm-operator">?</span> <span class="cm-variable">mAppToken</span> : <span class="cm-variable">mContainer</span>.<span class="cm-variable">mAppToken</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre>
    </div>
    </div>
    </div>
    </div>
    </div>
    <div
        style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 484px;">
    </div>
    <div class="CodeMirror-gutters" style="display: none; height: 484px;"></div>
    </div>
    </div>
    </pre>
    <p><span>这里会判断窗口类型，设置token。获取到Token后就保存在了</span><code>LayoutParams</code><span>里面，之后被传递到</span><code>ViewRootImpl.setView</code><span>中去。</span>
    </p>
    <pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded"
        lang="java"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre>
    </div>
    <div class="CodeMirror-measure"></div>
    <div style="position: relative; z-index: 1;"></div>
    <div class="CodeMirror-code" role="presentation" style="">
        <div class="CodeMirror-activeline" style="position: relative;">
            <div class="CodeMirror-activeline-background CodeMirror-linebackground"></div>
            <div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div>
            <pre class=" CodeMirror-line "
                role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-def">setView</span>(<span class="cm-variable">View</span> <span class="cm-variable">view</span>, <span class="cm-variable">WindowManager</span>.<span class="cm-variable">LayoutParams</span> <span class="cm-variable">attrs</span>, <span class="cm-variable">View</span> <span class="cm-variable">panelParentView</span>) {</span></pre>
        </div>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">synchronized</span> (<span class="cm-keyword">this</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">mView</span> <span class="cm-operator">==</span> <span class="cm-atom">null</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mWindowAttributes</span>.<span class="cm-variable">copyFrom</span>(<span class="cm-variable">attrs</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">res</span> <span class="cm-operator">=</span> <span class="cm-variable">mWindowSession</span>.<span class="cm-variable">addToDisplay</span>(<span class="cm-variable">mWindow</span>, <span class="cm-variable">mSeq</span>, <span class="cm-variable">mWindowAttributes</span>,</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">getHostVisibility</span>(), <span class="cm-variable">mDisplay</span>.<span class="cm-variable">getDisplayId</span>(),</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mAttachInfo</span>.<span class="cm-variable">mContentInsets</span>, <span class="cm-variable">mAttachInfo</span>.<span class="cm-variable">mStableInsets</span>,</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mAttachInfo</span>.<span class="cm-variable">mOutsets</span>, <span class="cm-variable">mInputChannel</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre>
    </div>
    </div>
    </div>
    </div>
    </div>
    <div
        style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 264px;">
    </div>
    <div class="CodeMirror-gutters" style="display: none; height: 264px;"></div>
    </div>
    </div>
    </pre>
    <p><span>这里将包含token的</span><code>LayoutParams</code><span>通过Session最终调用到了</span><code>WMS</code><span>的</span><code>addWindow</code><span>方法（这些流程前面的章节都提到过，所以这里就简单带过）。</span>
    </p>
    <pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"
        style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre>
    </div>
    <div class="CodeMirror-measure"></div>
    <div style="position: relative; z-index: 1;"></div>
    <div class="CodeMirror-code" role="presentation" style="">
        <div class="CodeMirror-activeline" style="position: relative;">
            <div class="CodeMirror-activeline-background CodeMirror-linebackground"></div>
            <div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div>
            <pre class=" CodeMirror-line "
                role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">WindowManagerService</span></span></pre>
        </div>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-variable-3">int</span> <span class="cm-def">addWindow</span>(<span class="cm-variable">Session</span> <span class="cm-variable">session</span>, <span class="cm-variable">IWindow</span> <span class="cm-variable">client</span>, <span class="cm-variable">LayoutParams</span> <span class="cm-variable">attrs</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">viewVisibility</span>,</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">int</span> <span class="cm-variable">displayId</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">requestUserId</span>, <span class="cm-variable">InsetsState</span> <span class="cm-variable">requestedVisibility</span>,</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">InputChannel</span> <span class="cm-variable">outInputChannel</span>, <span class="cm-variable">InsetsState</span> <span class="cm-variable">outInsetsState</span>,</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">InsetsSourceControl</span>[] <span class="cm-variable">outActiveControls</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//通过token获取到DisplayContent，来判断是否是非法的显示内容</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">final</span> <span class="cm-variable">DisplayContent</span> <span class="cm-variable">displayContent</span> <span class="cm-operator">=</span> <span class="cm-variable">getDisplayContentOrCreate</span>(<span class="cm-variable">displayId</span>, <span class="cm-variable">attrs</span>.<span class="cm-variable">token</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">displayContent</span> <span class="cm-operator">==</span> <span class="cm-atom">null</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">ProtoLog</span>.<span class="cm-variable">w</span>(<span class="cm-variable">WM_ERROR</span>, <span class="cm-string">"Attempted to add window to a display that does "</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">+</span> <span class="cm-string">"not exist: %d. Aborting."</span>, <span class="cm-variable">displayId</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">WindowManagerGlobal</span>.<span class="cm-variable">ADD_INVALID_DISPLAY</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-operator">!</span><span class="cm-variable">displayContent</span>.<span class="cm-variable">hasAccess</span>(<span class="cm-variable">session</span>.<span class="cm-variable">mUid</span>)) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">ProtoLog</span>.<span class="cm-variable">w</span>(<span class="cm-variable">WM_ERROR</span>,</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"Attempted to add window to a display for which the application "</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">+</span> <span class="cm-string">"does not have access: %d.  Aborting."</span>,</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">displayContent</span>.<span class="cm-variable">getDisplayId</span>());</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">WindowManagerGlobal</span>.<span class="cm-variable">ADD_INVALID_DISPLAY</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">mWindowMap</span>.<span class="cm-variable">containsKey</span>(<span class="cm-variable">client</span>.<span class="cm-variable">asBinder</span>())) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">ProtoLog</span>.<span class="cm-variable">w</span>(<span class="cm-variable">WM_ERROR</span>, <span class="cm-string">"Window %s is already added"</span>, <span class="cm-variable">client</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">WindowManagerGlobal</span>.<span class="cm-variable">ADD_DUPLICATE_ADD</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  } </span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//根据token获取activity，判断所添加的合法性</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">activity</span> <span class="cm-operator">=</span> <span class="cm-variable">token</span>.<span class="cm-variable">asActivityRecord</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">activity</span> <span class="cm-operator">==</span> <span class="cm-atom">null</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">ProtoLog</span>.<span class="cm-variable">w</span>(<span class="cm-variable">WM_ERROR</span>, <span class="cm-string">"Attempted to add window with non-application token "</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">+</span> <span class="cm-string">".%s Aborting."</span>, <span class="cm-variable">token</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">WindowManagerGlobal</span>.<span class="cm-variable">ADD_NOT_APP_TOKEN</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">else</span> <span class="cm-keyword">if</span> (<span class="cm-variable">activity</span>.<span class="cm-variable">getParent</span>() <span class="cm-operator">==</span> <span class="cm-atom">null</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">ProtoLog</span>.<span class="cm-variable">w</span>(<span class="cm-variable">WM_ERROR</span>, <span class="cm-string">"Attempted to add window with exiting application token "</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">+</span> <span class="cm-string">".%s Aborting."</span>, <span class="cm-variable">token</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">WindowManagerGlobal</span>.<span class="cm-variable">ADD_APP_EXITING</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">else</span> <span class="cm-keyword">if</span> (<span class="cm-variable">type</span> <span class="cm-operator">==</span> <span class="cm-variable">TYPE_APPLICATION_STARTING</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">activity</span>.<span class="cm-variable">mStartingWindow</span> <span class="cm-operator">!=</span> <span class="cm-atom">null</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">ProtoLog</span>.<span class="cm-variable">w</span>(<span class="cm-variable">WM_ERROR</span>, <span class="cm-string">"Attempted to add starting window to "</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">+</span> <span class="cm-string">"token with already existing starting window"</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">WindowManagerGlobal</span>.<span class="cm-variable">ADD_DUPLICATE_ADD</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">activity</span>.<span class="cm-variable">mStartingData</span> <span class="cm-operator">==</span> <span class="cm-atom">null</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">ProtoLog</span>.<span class="cm-variable">w</span>(<span class="cm-variable">WM_ERROR</span>, <span class="cm-string">"Attempted to add starting window to "</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">+</span> <span class="cm-string">"token but already cleaned"</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">WindowManagerGlobal</span>.<span class="cm-variable">ADD_DUPLICATE_ADD</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre>
    </div>
    </div>
    </div>
    </div>
    </div>
    <div
        style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 1166px;">
    </div>
    <div class="CodeMirror-gutters" style="display: none; height: 1166px;"></div>
    </div>
    </div>
    </pre>
    <p><span>以上，</span><code>WMS</code><span>会对token进行校验，只有合理的token才允许添加</span><code>Window</code><span>，否则返回相关的错误指标（判断的代码过于长，只是列出了一部分）。</span>
    </p>
    <p><span>那么这些返回值如何进行处理呢？别慌，看下面的代码。</span></p>
    <pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"
        style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre>
    </div>
    <div class="CodeMirror-measure"></div>
    <div style="position: relative; z-index: 1;"></div>
    <div class="CodeMirror-code" role="presentation" style="">
        <div class="CodeMirror-activeline" style="position: relative;">
            <div class="CodeMirror-activeline-background CodeMirror-linebackground"></div>
            <div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div>
            <pre class=" CodeMirror-line "
                role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">res</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">WindowManagerGlobal</span>.<span class="cm-variable">ADD_OKAY</span>) {</span></pre>
        </div>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mAttachInfo</span>.<span class="cm-variable">mRootView</span> <span class="cm-operator">=</span> <span class="cm-atom">null</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mAdded</span> <span class="cm-operator">=</span> <span class="cm-atom">false</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mFallbackEventHandler</span>.<span class="cm-variable">setView</span>(<span class="cm-atom">null</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">unscheduleTraversals</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">setAccessibilityFocus</span>(<span class="cm-atom">null</span>, <span class="cm-atom">null</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">switch</span> (<span class="cm-variable">res</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">case</span> <span class="cm-variable">WindowManagerGlobal</span>.<span class="cm-variable">ADD_BAD_APP_TOKEN</span>:</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">case</span> <span class="cm-variable">WindowManagerGlobal</span>.<span class="cm-variable">ADD_BAD_SUBWINDOW_TOKEN</span>:</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">throw</span> <span class="cm-keyword">new</span> <span class="cm-variable">WindowManager</span>.<span class="cm-variable">BadTokenException</span>(</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"Unable to add window -- token "</span> <span class="cm-operator">+</span> <span class="cm-variable">attrs</span>.<span class="cm-variable">token</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">+</span> <span class="cm-string">" is not valid; is your activity running?"</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">case</span> <span class="cm-variable">WindowManagerGlobal</span>.<span class="cm-variable">ADD_NOT_APP_TOKEN</span>:</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">throw</span> <span class="cm-keyword">new</span> <span class="cm-variable">WindowManager</span>.<span class="cm-variable">BadTokenException</span>(</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"Unable to add window -- token "</span> <span class="cm-operator">+</span> <span class="cm-variable">attrs</span>.<span class="cm-variable">token</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">+</span> <span class="cm-string">" is not for an application"</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">case</span> <span class="cm-variable">WindowManagerGlobal</span>.<span class="cm-variable">ADD_APP_EXITING</span>:</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">throw</span> <span class="cm-keyword">new</span> <span class="cm-variable">WindowManager</span>.<span class="cm-variable">BadTokenException</span>(</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"Unable to add window -- app for token "</span> <span class="cm-operator">+</span> <span class="cm-variable">attrs</span>.<span class="cm-variable">token</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">+</span> <span class="cm-string">" is exiting"</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">case</span> <span class="cm-variable">WindowManagerGlobal</span>.<span class="cm-variable">ADD_DUPLICATE_ADD</span>:</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">throw</span> <span class="cm-keyword">new</span> <span class="cm-variable">WindowManager</span>.<span class="cm-variable">BadTokenException</span>(</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"Unable to add window -- window "</span> <span class="cm-operator">+</span> <span class="cm-variable">mWindow</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">+</span> <span class="cm-string">" has already been added"</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">case</span> <span class="cm-variable">WindowManagerGlobal</span>.<span class="cm-variable">ADD_STARTING_NOT_NEEDED</span>:</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// Silently ignore -- we would have just removed it</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// right away, anyway.</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">case</span> <span class="cm-variable">WindowManagerGlobal</span>.<span class="cm-variable">ADD_MULTIPLE_SINGLETON</span>:</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">throw</span> <span class="cm-keyword">new</span> <span class="cm-variable">WindowManager</span>.<span class="cm-variable">BadTokenException</span>(<span class="cm-string">"Unable to add window "</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">+</span> <span class="cm-variable">mWindow</span> <span class="cm-operator">+</span> <span class="cm-string">" -- another window of type "</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">+</span> <span class="cm-variable">mWindowAttributes</span>.<span class="cm-variable">type</span> <span class="cm-operator">+</span> <span class="cm-string">" already exists"</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">case</span> <span class="cm-variable">WindowManagerGlobal</span>.<span class="cm-variable">ADD_PERMISSION_DENIED</span>:</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">throw</span> <span class="cm-keyword">new</span> <span class="cm-variable">WindowManager</span>.<span class="cm-variable">BadTokenException</span>(<span class="cm-string">"Unable to add window "</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">+</span> <span class="cm-variable">mWindow</span> <span class="cm-operator">+</span> <span class="cm-string">" -- permission denied for window type "</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">+</span> <span class="cm-variable">mWindowAttributes</span>.<span class="cm-variable">type</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">case</span> <span class="cm-variable">WindowManagerGlobal</span>.<span class="cm-variable">ADD_INVALID_DISPLAY</span>:</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">throw</span> <span class="cm-keyword">new</span> <span class="cm-variable">WindowManager</span>.<span class="cm-variable">InvalidDisplayException</span>(<span class="cm-string">"Unable to add window "</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">+</span> <span class="cm-variable">mWindow</span> <span class="cm-operator">+</span> <span class="cm-string">" -- the specified display can not be found"</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">case</span> <span class="cm-variable">WindowManagerGlobal</span>.<span class="cm-variable">ADD_INVALID_TYPE</span>:</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">throw</span> <span class="cm-keyword">new</span> <span class="cm-variable">WindowManager</span>.<span class="cm-variable">InvalidDisplayException</span>(<span class="cm-string">"Unable to add window "</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">+</span> <span class="cm-variable">mWindow</span> <span class="cm-operator">+</span> <span class="cm-string">" -- the specified window type "</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">+</span> <span class="cm-variable">mWindowAttributes</span>.<span class="cm-variable">type</span> <span class="cm-operator">+</span> <span class="cm-string">" is not valid"</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">case</span> <span class="cm-variable">WindowManagerGlobal</span>.<span class="cm-variable">ADD_INVALID_USER</span>:</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">throw</span> <span class="cm-keyword">new</span> <span class="cm-variable">WindowManager</span>.<span class="cm-variable">BadTokenException</span>(<span class="cm-string">"Unable to add Window "</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">+</span> <span class="cm-variable">mWindow</span> <span class="cm-operator">+</span> <span class="cm-string">" -- requested userId is not valid"</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">throw</span> <span class="cm-keyword">new</span> <span class="cm-variable">RuntimeException</span>(</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"Unable to add window -- unknown error code "</span> <span class="cm-operator">+</span> <span class="cm-variable">res</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre>
    </div>
    </div>
    </div>
    </div>
    </div>
    <div
        style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 1100px;">
    </div>
    <div class="CodeMirror-gutters" style="display: none; height: 1100px;"></div>
    </div>
    </div>
    </pre>
    <p><span>而ViewRootImpl中也对返回的值进行了判断，如果token不合理，则直接抛出了相关的异常！！！</span></p>
    <p><span>所以，简单总结一下，每个Activity都有一个自己的token，用于各种校验，而对于</span><code>WMS</code><span>来说，如果想添加非系统级别的窗口，都需要一个合理的token。</span>
    </p>
    <p><span>好了，有了上面的了解，我们分析一下其他的窗口，比如Dialog。</span></p>
    <p><strong><span>Dialog</span></strong></p>
    <p><span>先简单使用一下：</span></p>
    <pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="kotlin"
        style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="kotlin"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre>
    </div>
    <div class="CodeMirror-measure"></div>
    <div style="position: relative; z-index: 1;"></div>
    <div class="CodeMirror-code" role="presentation" style="">
        <div class="CodeMirror-activeline" style="position: relative;">
            <div class="CodeMirror-activeline-background CodeMirror-linebackground"></div>
            <div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div>
            <pre class=" CodeMirror-line "
                role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//创建dialog</span></span></pre>
        </div>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">val</span> <span class="cm-def">dialog</span> <span class="cm-operator">=</span> <span class="cm-keyword">object</span> : <span class="cm-variable">AppCompatDialog</span>(<span class="cm-keyword">this</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">override</span> <span class="cm-keyword">fun</span> <span class="cm-def">onCreate</span>(<span class="cm-variable">savedInstanceState</span>: <span class="cm-variable">Bundle</span><span class="cm-operator">?</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">super</span>.<span class="cm-variable">onCreate</span>(<span class="cm-variable">savedInstanceState</span>)</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">setContentView</span>(<span class="cm-variable">TextView</span>(<span class="cm-keyword">this</span><span class="cm-variable">@LearnTestActivity</span>).<span class="cm-variable">apply</span> {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">text</span> <span class="cm-operator">=</span> <span class="cm-string">"dialog simple test"</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  })</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">dialog</span>.<span class="cm-variable">show</span>()</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//设置宽高</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">val</span> <span class="cm-def">phoneWindow</span> <span class="cm-operator">=</span> <span class="cm-variable">dialog</span>.<span class="cm-variable">window</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">if</span> (<span class="cm-variable">phoneWindow</span> <span class="cm-operator">!=</span> <span class="cm-atom">null</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">val</span> <span class="cm-def">wlp</span> <span class="cm-operator">=</span> <span class="cm-variable">phoneWindow</span>.<span class="cm-variable">attributes</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">wlp</span>.<span class="cm-variable">gravity</span> <span class="cm-operator">=</span> <span class="cm-variable">Gravity</span>.<span class="cm-variable">CENTER</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">wlp</span>.<span class="cm-variable">height</span> <span class="cm-operator">=</span> (<span class="cm-variable">obtainPhoneCurrentHeight</span>(<span class="cm-keyword">this</span><span class="cm-variable">@LearnTestActivity</span>) <span class="cm-operator">*</span> <span class="cm-number">0.5</span>).<span class="cm-variable">toInt</span>()</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">wlp</span>.<span class="cm-variable">width</span> <span class="cm-operator">=</span> (<span class="cm-variable">obtainPhoneCurrentWidth</span>(<span class="cm-keyword">this</span><span class="cm-variable">@LearnTestActivity</span>) <span class="cm-operator">*</span> <span class="cm-number">0.5</span>).<span class="cm-variable">toInt</span>()</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">phoneWindow</span>.<span class="cm-variable">attributes</span> <span class="cm-operator">=</span> <span class="cm-variable">wlp</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre>
    </div>
    </div>
    </div>
    </div>
    </div>
    <div
        style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 484px;">
    </div>
    <div class="CodeMirror-gutters" style="display: none; height: 484px;"></div>
    </div>
    </div>
    </pre>
    <p><span>Dialog使用起来很简单的，只需要创建dialog对象重写</span><code>onCreate</code><span>方法，设置自己的布局，然后使用的时候，调用show方法即可。</span><strong><span>但是构建Dialog对象的时候，传递给构造器的context必须为Activity</span></strong><span>。为什么呢？就和我们上面聊到的token有关系了，原因下面分析：</span>
    </p>
    <p><span>好，那么我们就从Dialog的构造函数看起来。PS：上面我使用的</span><code>AppCompatDialog</code><span>最终也是调用到了</span><code>Dialog</code><span>的构造器，所以直接看</span><code>Dialog</code><span>即可。</span>
    </p>
    <pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"
        style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre>
    </div>
    <div class="CodeMirror-measure"></div>
    <div style="position: relative; z-index: 1;"></div>
    <div class="CodeMirror-code" role="presentation" style="">
        <div class="CodeMirror-activeline" style="position: relative;">
            <div class="CodeMirror-activeline-background CodeMirror-linebackground"></div>
            <div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div>
            <pre class=" CodeMirror-line "
                role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">//Dialog </span></span></pre>
        </div>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">Dialog</span>(<span class="cm-meta">@UiContext</span> <span class="cm-meta">@NonNull</span> <span class="cm-variable">Context</span> <span class="cm-variable">context</span>, <span class="cm-meta">@StyleRes</span> <span class="cm-variable-3">int</span> <span class="cm-variable">themeResId</span>,</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">boolean</span> <span class="cm-variable">createContextThemeWrapper</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">createContextThemeWrapper</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//相关主题资源创建</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">themeResId</span> <span class="cm-operator">==</span> <span class="cm-variable">Resources</span>.<span class="cm-variable">ID_NULL</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">final</span> <span class="cm-variable">TypedValue</span> <span class="cm-variable">outValue</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">TypedValue</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">context</span>.<span class="cm-variable">getTheme</span>().<span class="cm-variable">resolveAttribute</span>(<span class="cm-variable">R</span>.<span class="cm-variable">attr</span>.<span class="cm-variable">dialogTheme</span>, <span class="cm-variable">outValue</span>, <span class="cm-atom">true</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">themeResId</span> <span class="cm-operator">=</span> <span class="cm-variable">outValue</span>.<span class="cm-variable">resourceId</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mContext</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">ContextThemeWrapper</span>(<span class="cm-variable">context</span>, <span class="cm-variable">themeResId</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">else</span> {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mContext</span> <span class="cm-operator">=</span> <span class="cm-variable">context</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">//获取Activity的WindowManager</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mWindowManager</span> <span class="cm-operator">=</span> (<span class="cm-variable">WindowManager</span>) <span class="cm-variable">context</span>.<span class="cm-variable">getSystemService</span>(<span class="cm-variable">Context</span>.<span class="cm-variable">WINDOW_SERVICE</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">//创建PhoneWindow</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">final</span> <span class="cm-variable">Window</span> <span class="cm-variable">w</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">PhoneWindow</span>(<span class="cm-variable">mContext</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mWindow</span> <span class="cm-operator">=</span> <span class="cm-variable">w</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//设置布局更改之后的回调，比如我们上面设置了Window.LayoutParams。通过这个回调，就会调用到Dialog的onWindowAttributesChanged方法，然后具体执行相关的改变。</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">w</span>.<span class="cm-variable">setCallback</span>(<span class="cm-keyword">this</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">w</span>.<span class="cm-variable">setOnWindowDismissedCallback</span>(<span class="cm-keyword">this</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">w</span>.<span class="cm-variable">setOnWindowSwipeDismissedCallback</span>(() <span class="cm-operator">-&gt;</span> {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">mCancelable</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">cancel</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  });</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//设置windowmanager</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">w</span>.<span class="cm-variable">setWindowManager</span>(<span class="cm-variable">mWindowManager</span>, <span class="cm-atom">null</span>, <span class="cm-atom">null</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">w</span>.<span class="cm-variable">setGravity</span>(<span class="cm-variable">Gravity</span>.<span class="cm-variable">CENTER</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mListenersHandler</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">ListenersHandler</span>(<span class="cm-keyword">this</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">//获取WindowManager</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">Activity</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">Object</span> <span class="cm-def">getSystemService</span>(<span class="cm-meta">@ServiceName</span> <span class="cm-meta">@NonNull</span> <span class="cm-variable-3">String</span> <span class="cm-variable">name</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">getBaseContext</span>() <span class="cm-operator">==</span> <span class="cm-atom">null</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">throw</span> <span class="cm-keyword">new</span> <span class="cm-variable">IllegalStateException</span>(</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"System services not available to Activities before onCreate()"</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">WINDOW_SERVICE</span>.<span class="cm-variable">equals</span>(<span class="cm-variable">name</span>)) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">mWindowManager</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">else</span> <span class="cm-keyword">if</span> (<span class="cm-variable">SEARCH_SERVICE</span>.<span class="cm-variable">equals</span>(<span class="cm-variable">name</span>)) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">ensureSearchManager</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">mSearchManager</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-keyword">super</span>.<span class="cm-variable">getSystemService</span>(<span class="cm-variable">name</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre>
    </div>
    </div>
    </div>
    </div>
    </div>
    <div
        style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 1100px;">
    </div>
    <div class="CodeMirror-gutters" style="display: none; height: 1100px;"></div>
    </div>
    </div>
    </pre>
    <p><span>整体流程和Activity的创建很相似，首先创建相关的主题资源，其次获取到Activity的WindowManager，之后创建自己的PhoneWindow，设置相关的监听回调等等。最后调用PhoneWindow的</span><code>setWindowManager</code><span>方法。但是注意，这是我们调用</span><code>setWindowManager</code><span>时，传入的token为null，也就是说，</span><strong><span>此时PhoneWindow内部的</span><code>mAppToken</code><span>属性为null</span></strong><span>。</span>
    </p>
    <p><span>我们接下来看Dialog的</span><code>show</code><span>方法。</span></p>
    <pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"
        style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre>
    </div>
    <div class="CodeMirror-measure"></div>
    <div style="position: relative; z-index: 1;"></div>
    <div class="CodeMirror-code" role="presentation" style="">
        <div class="CodeMirror-activeline" style="position: relative;">
            <div class="CodeMirror-activeline-background CodeMirror-linebackground"></div>
            <div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div>
            <pre class=" CodeMirror-line "
                role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-def">show</span>() {</span></pre>
        </div>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-operator">!</span><span class="cm-variable">mCreated</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//调用到onCreate 会调用到setContentView，之后会构建DecorView，自己的布局填充到DecorView上，并且被phoneWindow引用。和Activity的流程是一样的，这里就不再展开分析了。</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">dispatchOnCreate</span>(<span class="cm-atom">null</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">else</span> {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// Fill the DecorView in on any configuration changes that</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// may have occured while it was removed from the WindowManager.</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">final</span> <span class="cm-variable">Configuration</span> <span class="cm-variable">config</span> <span class="cm-operator">=</span> <span class="cm-variable">mContext</span>.<span class="cm-variable">getResources</span>().<span class="cm-variable">getConfiguration</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mWindow</span>.<span class="cm-variable">getDecorView</span>().<span class="cm-variable">dispatchConfigurationChanged</span>(<span class="cm-variable">config</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">onStart</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mDecor</span> <span class="cm-operator">=</span> <span class="cm-variable">mWindow</span>.<span class="cm-variable">getDecorView</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span>...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">WindowManager</span>.<span class="cm-variable">LayoutParams</span> <span class="cm-variable">l</span> <span class="cm-operator">=</span> <span class="cm-variable">mWindow</span>.<span class="cm-variable">getAttributes</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; <span class="cm-tab" role="presentation" cm-text="	"> </span>...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//因为添加的是应用程序窗口，所以在WindowManagerGlobel的addView中，会获取到parentWindow的token，即Activity的token。</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mWindowManager</span>.<span class="cm-variable">addView</span>(<span class="cm-variable">mDecor</span>, <span class="cm-variable">l</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mShowing</span> <span class="cm-operator">=</span> <span class="cm-atom">true</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">sendShowMessage</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre>
    </div>
    </div>
    </div>
    </div>
    </div>
    <div
        style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 594px;">
    </div>
    <div class="CodeMirror-gutters" style="display: none; height: 594px;"></div>
    </div>
    </div>
    </pre>
    <p><span>这里会调用到onCreate方法，构建布局。之后使用Activity的WindowManager调用了</span><code>addView</code><span>方法。之后的流程和Activity的添加是一致的</span><strong><span>。因为这里拿到的是Activity的WindowManager，且WindowManager的构建类型为应用程序窗口，所以在</span><code>WindowManagerGlobel</code><span>的</span><code>addView</code><span>中，会获取到</span><code>parentWindow</code><span>的token，即Activity的token。所以Dialog才可以被添加。如果此时传递的是</span><code>Appliocation</code><span>或者是</span><code>Service</code><span>，则在</span><code>ViewRootImpl.setView</code><span>中会抛出token相关的错误异常，找不到对应的token</span></strong><span>，所以这就是为什么使用Dialog我们必须传入Activity的原因。</span>
    </p>
    <p>&nbsp;</p>
    <p><span>Dialog流程，上面已经分析完毕了。</span></p>
    <p><span>接下来回答最初的几个问题：</span></p>
    <ol start=''>
        <li>
            <p><span>token是什么？</span></p>
            <p><span>简单理解，Activity的标识符。</span></p>
        </li>
        <li>
            <p><span>Dialog为什么一定需要Activity作为Context</span></p>
            <p><span>因为需要依赖Activity的token进行构建。</span></p>
        </li>
        <li>
            <p><span>Dialog弹出后对于Activity生命周期有何影响</span></p>
            <p><span>分两种情况：</span></p>
            <ul>
                <li><span>如果弹出的是当前界面的Dialog，则当前Activity不会有任何的变化。</span></li>
                <li><span>如果是别的Activity的Dialog，则当前Activity会走</span><code>onPause</code><span>。</span></li>
            </ul>
        </li>
        <li>
            <p><span>如何正确的设置到Dialog的宽高</span></p>
            <p><span>这个像上面写的demo一样，需要等到调用</span><code>dialog.show()</code><span>方法之后才可以去设置</span><code>WindowManager.LayoutParams</code><span>的宽高，因为只有调用</span><code>show()</code><span>方法之后，</span><code>decorview</code><span>才不会为null，只有它不为null，才会进行真正的相关属性设置，具体实现代码如下所示：</span>
            </p>
            <pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded"
                lang="java"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre>
            </div>
            <div class="CodeMirror-measure"></div>
            <div style="position: relative; z-index: 1;"></div>
            <div class="CodeMirror-code" role="presentation" style="">
                <div class="CodeMirror-activeline" style="position: relative;">
                    <div class="CodeMirror-activeline-background CodeMirror-linebackground"></div>
                    <div class="CodeMirror-gutter-background CodeMirror-activeline-gutter"
                        style="left: 0px; width: 0px;"></div>
                    <pre class=" CodeMirror-line "
                        role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">Dialog</span></span></pre>
                </div>
                <pre class=" CodeMirror-line "
                    role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-def">onWindowAttributesChanged</span>(<span class="cm-variable">WindowManager</span>.<span class="cm-variable">LayoutParams</span> <span class="cm-variable">params</span>) {</span></pre>
                <pre class=" CodeMirror-line "
                    role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">mDecor</span> <span class="cm-operator">!=</span> <span class="cm-atom">null</span>) {</span></pre>
                <pre class=" CodeMirror-line "
                    role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mWindowManager</span>.<span class="cm-variable">updateViewLayout</span>(<span class="cm-variable">mDecor</span>, <span class="cm-variable">params</span>);</span></pre>
                <pre class=" CodeMirror-line "
                    role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre>
                <pre class=" CodeMirror-line "
                    role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre>
            </div>
            </div>
            </div>
            </div>
            </div>
            <div
                style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 132px;">
            </div>
            <div class="CodeMirror-gutters" style="display: none; height: 132px;"></div>
            </div>
            </div>
            </pre>
        </li>
    </ol>
    <h2><a name="toast机制-封装可以在任何线程使用的toast" class="md-header-anchor"></a><span>Toast机制-(封装可以在任何线程使用的toast)</span></h2>
    <blockquote>
        <p><span>本章节带大家了解一下toast机制，并且简单封装一个可以在任何线程中使用的toast。</span></p>
    </blockquote>
    <p><span>带着以下几个问题，我们去看源码：</span></p>
    <ol start=''>
        <li><span>想在子线程调用</span><code>toast</code><span>应该怎么处理？</span></li>
        <li><code>toast</code><span>的</span><code>window</code><span>是什么，为什么回到桌面依旧会显示呢？</span></li>
    </ol>
    <p>&nbsp;</p>
    <p><strong><span>源码分析</span></strong></p>
    <p><code>Toast</code><span>的常规调用方式：</span><code>Toast.makeText(context, str, duration).show()</code><span>。</span>
    </p>
    <p><span>所以先看</span><code>makeText</code><span>方法。</span></p>
    <pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"
        style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre>
    </div>
    <div class="CodeMirror-measure"></div>
    <div style="position: relative; z-index: 1;"></div>
    <div class="CodeMirror-code" role="presentation" style="">
        <div class="CodeMirror-activeline" style="position: relative;">
            <div class="CodeMirror-activeline-background CodeMirror-linebackground"></div>
            <div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div>
            <pre class=" CodeMirror-line "
                role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">Toast</span></span></pre>
        </div>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-variable">Toast</span> <span class="cm-def">makeText</span>(<span class="cm-variable">Context</span> <span class="cm-variable">context</span>, <span class="cm-variable">CharSequence</span> <span class="cm-variable">text</span>, <span class="cm-meta">@Duration</span> <span class="cm-variable-3">int</span> <span class="cm-variable">duration</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//传入的looper为null</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">makeText</span>(<span class="cm-variable">context</span>, <span class="cm-atom">null</span>, <span class="cm-variable">text</span>, <span class="cm-variable">duration</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-variable">Toast</span> <span class="cm-def">makeText</span>(<span class="cm-meta">@NonNull</span> <span class="cm-variable">Context</span> <span class="cm-variable">context</span>, <span class="cm-meta">@Nullable</span> <span class="cm-variable">Looper</span> <span class="cm-variable">looper</span>,</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-meta">@NonNull</span> <span class="cm-variable">CharSequence</span> <span class="cm-variable">text</span>, <span class="cm-meta">@Duration</span> <span class="cm-variable-3">int</span> <span class="cm-variable">duration</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//对于以 Android 11（API 级别 30）或更高版本为目标平台的应用处于启用状态。</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//目的：文本消息框现在由 SystemUI 呈现，而不是在应用内呈现。具体toast的show操作，由SystemUI进行。</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">Compatibility</span>.<span class="cm-variable">isChangeEnabled</span>(<span class="cm-variable">CHANGE_TEXT_TOASTS_IN_THE_SYSTEM</span>)) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Toast</span> <span class="cm-variable">result</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">Toast</span>(<span class="cm-variable">context</span>, <span class="cm-variable">looper</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">result</span>.<span class="cm-variable">mText</span> <span class="cm-operator">=</span> <span class="cm-variable">text</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">result</span>.<span class="cm-variable">mDuration</span> <span class="cm-operator">=</span> <span class="cm-variable">duration</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">result</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">//构建Toast</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable">Toast</span>(<span class="cm-meta">@NonNull</span> <span class="cm-variable">Context</span> <span class="cm-variable">context</span>, <span class="cm-meta">@Nullable</span> <span class="cm-variable">Looper</span> <span class="cm-variable">looper</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mContext</span> <span class="cm-operator">=</span> <span class="cm-variable">context</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//构建token，一个Toast对应一个Token</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mToken</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">Binder</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//会判断如果传入的looper为null，则获取looper.mylooper。因为主线程创建之时就构建了Looper，故这里默认拿到的是主线程的Looper。</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">looper</span> <span class="cm-operator">=</span> <span class="cm-variable">getLooper</span>(<span class="cm-variable">looper</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mHandler</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">Handler</span>(<span class="cm-variable">looper</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mCallbacks</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">ArrayList</span><span class="cm-operator">&lt;&gt;</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mTN</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">TN</span>(<span class="cm-variable">context</span>, <span class="cm-variable">context</span>.<span class="cm-variable">getPackageName</span>(), <span class="cm-variable">mToken</span>,</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mCallbacks</span>, <span class="cm-variable">looper</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span class="cm-variable">Looper</span> <span class="cm-def">getLooper</span>(<span class="cm-meta">@Nullable</span> <span class="cm-variable">Looper</span> <span class="cm-variable">looper</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">looper</span> <span class="cm-operator">!=</span> <span class="cm-atom">null</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">looper</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">checkNotNull</span>(<span class="cm-variable">Looper</span>.<span class="cm-variable">myLooper</span>(),</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"Can't toast on a thread that has not called Looper.prepare()"</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre>
    </div>
    </div>
    </div>
    </div>
    </div>
    <div
        style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 836px;">
    </div>
    <div class="CodeMirror-gutters" style="display: none; height: 836px;"></div>
    </div>
    </div>
    </pre>
    <p><span>通过</span><code>makeToast</code><span>方法会构建一个</span><code>Toast</code><span>。而每一个</span><code>Toast</code><span>会对应到一个</span><code>token</code><span>。同时，默认情况下需要获取当前线程的</span><code>looper</code><span>。如果当前线程不存在</span><code>looper</code><span>则会抛异常。故，如果想要在子线程调用</span><code>Toast</code><span>，则必须要先构建</span><code>looper</code><span>。</span>
    </p>
    <p><span>另外说明一下，</span><code>Android11</code><span>以上，会进行</span><code>Compatibility.isChangeEnabled(CHANGE_TEXT_TOASTS_IN_THE_SYSTEM)</code><span>判断，之后具体的</span><code>toast</code><span>弹出由系统负责（因为之前大家看到的可能会通过IPC回调到TN，然后进行</span><code>show</code><span>or</span><code>hiden</code><span>，这里不再是了），下面会介绍到。</span>
    </p>
    <p>&nbsp;</p>
    <p><span>好，下面继续分析</span><code>show</code><span>的操作。</span></p>
    <pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"
        style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre>
    </div>
    <div class="CodeMirror-measure"></div>
    <div style="position: relative; z-index: 1;"></div>
    <div class="CodeMirror-code" role="presentation" style="">
        <div class="CodeMirror-activeline" style="position: relative;">
            <div class="CodeMirror-activeline-background CodeMirror-linebackground"></div>
            <div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div>
            <pre class=" CodeMirror-line "
                role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">Toast</span></span></pre>
        </div>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-def">show</span>() {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">//获取到NotificationManagerService</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">INotificationManager</span> <span class="cm-variable">service</span> <span class="cm-operator">=</span> <span class="cm-variable">getService</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//包名</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">String</span> <span class="cm-variable">pkg</span> <span class="cm-operator">=</span> <span class="cm-variable">mContext</span>.<span class="cm-variable">getOpPackageName</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">TN</span> <span class="cm-variable">tn</span> <span class="cm-operator">=</span> <span class="cm-variable">mTN</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">tn</span>.<span class="cm-variable">mNextView</span> <span class="cm-operator">=</span> <span class="cm-variable">mNextView</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">final</span> <span class="cm-variable-3">int</span> <span class="cm-variable">displayId</span> <span class="cm-operator">=</span> <span class="cm-variable">mContext</span>.<span class="cm-variable">getDisplayId</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">try</span> {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">Compatibility</span>.<span class="cm-variable">isChangeEnabled</span>(<span class="cm-variable">CHANGE_TEXT_TOASTS_IN_THE_SYSTEM</span>)) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">mNextView</span> <span class="cm-operator">!=</span> <span class="cm-atom">null</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">service</span>.<span class="cm-variable">enqueueToast</span>(<span class="cm-variable">pkg</span>, <span class="cm-variable">mToken</span>, <span class="cm-variable">tn</span>, <span class="cm-variable">mDuration</span>, <span class="cm-variable">displayId</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">else</span> {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 由于我们传入的是一个text，故走这里，注意并没有传入TN</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">ITransientNotificationCallback</span> <span class="cm-variable">callback</span> <span class="cm-operator">=</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">new</span> <span class="cm-variable">CallbackBinder</span>(<span class="cm-variable">mCallbacks</span>, <span class="cm-variable">mHandler</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//调用了NotificationManagerService的enqueueTextToast方法，传入了包名、token、文字、mDuration、displayId、callback</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//这个callback会在toast show 或者 hiden之后进行回调</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">service</span>.<span class="cm-variable">enqueueTextToast</span>(<span class="cm-variable">pkg</span>, <span class="cm-variable">mToken</span>, <span class="cm-variable">mText</span>, <span class="cm-variable">mDuration</span>, <span class="cm-variable">displayId</span>, <span class="cm-variable">callback</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">else</span> {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">service</span>.<span class="cm-variable">enqueueToast</span>(<span class="cm-variable">pkg</span>, <span class="cm-variable">mToken</span>, <span class="cm-variable">tn</span>, <span class="cm-variable">mDuration</span>, <span class="cm-variable">displayId</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  } </span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre>
    </div>
    </div>
    </div>
    </div>
    </div>
    <div
        style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 660px;">
    </div>
    <div class="CodeMirror-gutters" style="display: none; height: 660px;"></div>
    </div>
    </div>
    </pre>
    <p><code>show</code><span>首先获取到了</span><code>NotificationManagerService</code><span>，之后经过一系列的判断，调用到了</span><code>enqueueTextToast</code><span>方法。传入了包名、</span><code>token</code><span>等相关的参数。</span>
    </p>
    <p><span>接下来看</span><code>NotificationManagerService</code><span>相关的代码：</span></p>
    <pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"
        style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre>
    </div>
    <div class="CodeMirror-measure"></div>
    <div style="position: relative; z-index: 1;"></div>
    <div class="CodeMirror-code" role="presentation" style="">
        <div class="CodeMirror-activeline" style="position: relative;">
            <div class="CodeMirror-activeline-background CodeMirror-linebackground"></div>
            <div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div>
            <pre class=" CodeMirror-line "
                role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">NotificationManagerService</span></span></pre>
        </div>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">@Override</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-def">enqueueTextToast</span>(<span class="cm-variable-3">String</span> <span class="cm-variable">pkg</span>, <span class="cm-variable">IBinder</span> <span class="cm-variable">token</span>, <span class="cm-variable">CharSequence</span> <span class="cm-variable">text</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">duration</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">displayId</span>, <span class="cm-meta">@Nullable</span> <span class="cm-variable">ITransientNotificationCallback</span> <span class="cm-variable">callback</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">enqueueToast</span>(<span class="cm-variable">pkg</span>, <span class="cm-variable">token</span>, <span class="cm-variable">text</span>, <span class="cm-atom">null</span>, <span class="cm-variable">duration</span>, <span class="cm-variable">displayId</span>, <span class="cm-variable">callback</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">private</span> <span class="cm-variable-3">void</span> <span class="cm-def">enqueueToast</span>(<span class="cm-variable-3">String</span> <span class="cm-variable">pkg</span>, <span class="cm-variable">IBinder</span> <span class="cm-variable">token</span>, <span class="cm-meta">@Nullable</span> <span class="cm-variable">CharSequence</span> <span class="cm-variable">text</span>,</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-meta">@Nullable</span> <span class="cm-variable">ITransientNotification</span> <span class="cm-variable">callback</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">duration</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">displayId</span>,</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-meta">@Nullable</span> <span class="cm-variable">ITransientNotificationCallback</span> <span class="cm-variable">textCallback</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">//同步Toast队列</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">synchronized</span> (<span class="cm-variable">mToastQueue</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">int</span> <span class="cm-variable">callingPid</span> <span class="cm-operator">=</span> <span class="cm-variable">Binder</span>.<span class="cm-variable">getCallingPid</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">final</span> <span class="cm-variable-3">long</span> <span class="cm-variable">callingId</span> <span class="cm-operator">=</span> <span class="cm-variable">Binder</span>.<span class="cm-variable">clearCallingIdentity</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">try</span> {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">ToastRecord</span> <span class="cm-variable">record</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">int</span> <span class="cm-variable">index</span> <span class="cm-operator">=</span> <span class="cm-variable">indexOfToastLocked</span>(<span class="cm-variable">pkg</span>, <span class="cm-variable">token</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 如果它已经在队列中，我们就地更新它，我们不会将它移动到队列的末尾。</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">index</span> <span class="cm-operator">&gt;=</span> <span class="cm-number">0</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">record</span> <span class="cm-operator">=</span> <span class="cm-variable">mToastQueue</span>.<span class="cm-variable">get</span>(<span class="cm-variable">index</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">record</span>.<span class="cm-variable">update</span>(<span class="cm-variable">duration</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">else</span> {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 限制任何给定包可以排队的 toast 数量。 防止 DOS 攻击并处理泄漏。</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//MAX_PACKAGE_TOASTS 为5，所以限制每个应用在队列中只能保持5个ToastRcord</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">int</span> <span class="cm-variable">count</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">final</span> <span class="cm-variable-3">int</span> <span class="cm-variable">N</span> <span class="cm-operator">=</span> <span class="cm-variable">mToastQueue</span>.<span class="cm-variable">size</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">N</span>; <span class="cm-variable">i</span><span class="cm-operator">++</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">final</span> <span class="cm-variable">ToastRecord</span> <span class="cm-variable">r</span> <span class="cm-operator">=</span> <span class="cm-variable">mToastQueue</span>.<span class="cm-variable">get</span>(<span class="cm-variable">i</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">r</span>.<span class="cm-variable">pkg</span>.<span class="cm-variable">equals</span>(<span class="cm-variable">pkg</span>)) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">count</span><span class="cm-operator">++</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">count</span> <span class="cm-operator">&gt;=</span> <span class="cm-variable">MAX_PACKAGE_TOASTS</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Slog</span>.<span class="cm-variable">e</span>(<span class="cm-variable">TAG</span>, <span class="cm-string">"Package has already queued "</span> <span class="cm-operator">+</span> <span class="cm-variable">count</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-operator">+</span> <span class="cm-string">" toasts. Not showing more. Package="</span> <span class="cm-operator">+</span> <span class="cm-variable">pkg</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">//产生一个窗口令牌，Toast拿到这个令牌之后才能创建系统级的Window</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Binder</span> <span class="cm-variable">windowToken</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">Binder</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//注意传入的type类型是TYPE_TOAST，系统级type</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mWindowManagerInternal</span>.<span class="cm-variable">addWindowToken</span>(<span class="cm-variable">windowToken</span>, <span class="cm-variable">TYPE_TOAST</span>, <span class="cm-variable">displayId</span>,</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-atom">null</span> <span class="cm-comment">/* options */</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//创建toastRecord并加入队列</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">record</span> <span class="cm-operator">=</span> <span class="cm-variable">getToastRecord</span>(<span class="cm-variable">callingUid</span>, <span class="cm-variable">callingPid</span>, <span class="cm-variable">pkg</span>, <span class="cm-variable">isSystemToast</span>, <span class="cm-variable">token</span>,</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">text</span>, <span class="cm-variable">callback</span>, <span class="cm-variable">duration</span>, <span class="cm-variable">windowToken</span>, <span class="cm-variable">displayId</span>, <span class="cm-variable">textCallback</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mToastQueue</span>.<span class="cm-variable">add</span>(<span class="cm-variable">record</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">index</span> <span class="cm-operator">=</span> <span class="cm-variable">mToastQueue</span>.<span class="cm-variable">size</span>() <span class="cm-operator">-</span> <span class="cm-number">1</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">keepProcessAliveForToastIfNeededLocked</span>(<span class="cm-variable">callingPid</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">index</span> <span class="cm-operator">==</span> <span class="cm-number">0</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//如果当前的正好处在第一位，则直接展示。</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">showNextToastLocked</span>(<span class="cm-atom">false</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">finally</span> {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Binder</span>.<span class="cm-variable">restoreCallingIdentity</span>(<span class="cm-variable">callingId</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre>
    </div>
    </div>
    </div>
    </div>
    </div>
    <div
        style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 1276px;">
    </div>
    <div class="CodeMirror-gutters" style="display: none; height: 1276px;"></div>
    </div>
    </div>
    </pre>
    <p><span>调用到了</span><code>enqueueToast</code><span>方法，创建</span><code>windowToken</code><span>，而</span><code>windowToken</code><span>的类型是</span><code>TYPE_TOAST</code><span>。随后将创建好的</span><code>ToastRecord</code><span>插入队列。接下来调用</span><code>showNextToastLocked</code>
    </p>
    <pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"
        style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre>
    </div>
    <div class="CodeMirror-measure"></div>
    <div style="position: relative; z-index: 1;"></div>
    <div class="CodeMirror-code" role="presentation" style="">
        <div class="CodeMirror-activeline" style="position: relative;">
            <div class="CodeMirror-activeline-background CodeMirror-linebackground"></div>
            <div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div>
            <pre class=" CodeMirror-line "
                role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">NotificationManagerService</span></span></pre>
        </div>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable-3">void</span> <span class="cm-def">showNextToastLocked</span>(<span class="cm-variable-3">boolean</span> <span class="cm-variable">lastToastWasTextRecord</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">//获取到ToastRecord</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">ToastRecord</span> <span class="cm-variable">record</span> <span class="cm-operator">=</span> <span class="cm-variable">mToastQueue</span>.<span class="cm-variable">get</span>(<span class="cm-number">0</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">while</span> (<span class="cm-variable">record</span> <span class="cm-operator">!=</span> <span class="cm-atom">null</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">int</span> <span class="cm-variable">userId</span> <span class="cm-operator">=</span> <span class="cm-variable">UserHandle</span>.<span class="cm-variable">getUserId</span>(<span class="cm-variable">record</span>.<span class="cm-variable">uid</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">boolean</span> <span class="cm-variable">rateLimitingEnabled</span> <span class="cm-operator">=</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">!</span><span class="cm-variable">mToastRateLimitingDisabledUids</span>.<span class="cm-variable">contains</span>(<span class="cm-variable">record</span>.<span class="cm-variable">uid</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">boolean</span> <span class="cm-variable">isWithinQuota</span> <span class="cm-operator">=</span> <span class="cm-variable">mToastRateLimiter</span>.<span class="cm-variable">isWithinQuota</span>(<span class="cm-variable">userId</span>, <span class="cm-variable">record</span>.<span class="cm-variable">pkg</span>, <span class="cm-variable">TOAST_QUOTA_TAG</span>)</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">||</span> <span class="cm-variable">isExemptFromRateLimiting</span>(<span class="cm-variable">record</span>.<span class="cm-variable">pkg</span>, <span class="cm-variable">userId</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">boolean</span> <span class="cm-variable">isPackageInForeground</span> <span class="cm-operator">=</span> <span class="cm-variable">isPackageInForegroundForToast</span>(<span class="cm-variable">record</span>.<span class="cm-variable">uid</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">//showToast </span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">tryShowToast</span>(<span class="cm-variable">record</span>, <span class="cm-variable">rateLimitingEnabled</span>, <span class="cm-variable">isWithinQuota</span>, <span class="cm-variable">isPackageInForeground</span>)) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//到达指定时间后，隐藏toast</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">scheduleDurationReachedLocked</span>(<span class="cm-variable">record</span>, <span class="cm-variable">lastToastWasTextRecord</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mIsCurrentToastShown</span> <span class="cm-operator">=</span> <span class="cm-atom">true</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">rateLimitingEnabled</span> <span class="cm-operator">&amp;&amp;</span> <span class="cm-operator">!</span><span class="cm-variable">isPackageInForeground</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mToastRateLimiter</span>.<span class="cm-variable">noteEvent</span>(<span class="cm-variable">userId</span>, <span class="cm-variable">record</span>.<span class="cm-variable">pkg</span>, <span class="cm-variable">TOAST_QUOTA_TAG</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span>...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre>
    </div>
    </div>
    </div>
    </div>
    </div>
    <div
        style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 550px;">
    </div>
    <div class="CodeMirror-gutters" style="display: none; height: 550px;"></div>
    </div>
    </div>
    </pre>
    <p><span>下面我们分别来查看展示和隐藏：</span></p>
    <p><strong><span>展示</span></strong></p>
    <pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"
        style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre>
    </div>
    <div class="CodeMirror-measure"></div>
    <div style="position: relative; z-index: 1;"></div>
    <div class="CodeMirror-code" role="presentation" style="">
        <div class="CodeMirror-activeline" style="position: relative;">
            <div class="CodeMirror-activeline-background CodeMirror-linebackground"></div>
            <div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div>
            <pre class=" CodeMirror-line "
                role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">NotificationManagerService</span></span></pre>
        </div>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">private</span> <span class="cm-variable-3">boolean</span> <span class="cm-def">tryShowToast</span>(<span class="cm-variable">ToastRecord</span> <span class="cm-variable">record</span>, <span class="cm-variable-3">boolean</span> <span class="cm-variable">rateLimitingEnabled</span>,</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">boolean</span> <span class="cm-variable">isWithinQuota</span>, <span class="cm-variable-3">boolean</span> <span class="cm-variable">isPackageInForeground</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; <span class="cm-tab" role="presentation" cm-text="	"> </span>...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; <span class="cm-tab" role="presentation" cm-text="	"> </span><span class="cm-comment">//这里会调用到SystemUi，具体为ToastUI的showToast方法</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">record</span>.<span class="cm-variable">show</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">ToastUI</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-def">showToast</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">uid</span>, <span class="cm-variable-3">String</span> <span class="cm-variable">packageName</span>, <span class="cm-variable">IBinder</span> <span class="cm-variable">token</span>, <span class="cm-variable">CharSequence</span> <span class="cm-variable">text</span>,</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">IBinder</span> <span class="cm-variable">windowToken</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">duration</span>, <span class="cm-meta">@Nullable</span> <span class="cm-variable">ITransientNotificationCallback</span> <span class="cm-variable">callback</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Runnable</span> <span class="cm-variable">showToastRunnable</span> <span class="cm-operator">=</span> () <span class="cm-operator">-&gt;</span> {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">UserHandle</span> <span class="cm-variable">userHandle</span> <span class="cm-operator">=</span> <span class="cm-variable">UserHandle</span>.<span class="cm-variable">getUserHandleForUid</span>(<span class="cm-variable">uid</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Context</span> <span class="cm-variable">context</span> <span class="cm-operator">=</span> <span class="cm-variable">mContext</span>.<span class="cm-variable">createContextAsUser</span>(<span class="cm-variable">userHandle</span>, <span class="cm-number">0</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//获取toast，在这里会进行布局填充。</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mToast</span> <span class="cm-operator">=</span> <span class="cm-variable">mToastFactory</span>.<span class="cm-variable">createToast</span>(<span class="cm-variable">mContext</span> <span class="cm-comment">/* sysuiContext */</span>, <span class="cm-variable">text</span>, <span class="cm-variable">packageName</span>,</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">userHandle</span>.<span class="cm-variable">getIdentifier</span>(), <span class="cm-variable">mOrientation</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">//动画</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">mToast</span>.<span class="cm-variable">getInAnimation</span>() <span class="cm-operator">!=</span> <span class="cm-atom">null</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mToast</span>.<span class="cm-variable">getInAnimation</span>().<span class="cm-variable">start</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mCallback</span> <span class="cm-operator">=</span> <span class="cm-variable">callback</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//在ToastPresenter的构造函数中，会初始化mWindowManager，获取到系统的context.getSystemService(WindowManager.class)</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mPresenter</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">ToastPresenter</span>(<span class="cm-variable">context</span>, <span class="cm-variable">mIAccessibilityManager</span>,</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mNotificationManager</span>, <span class="cm-variable">packageName</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//设置为受信任的覆盖，以便触摸可以通过 toast</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mPresenter</span>.<span class="cm-variable">getLayoutParams</span>().<span class="cm-variable">setTrustedOverlay</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mToastLogger</span>.<span class="cm-variable">logOnShowToast</span>(<span class="cm-variable">uid</span>, <span class="cm-variable">packageName</span>, <span class="cm-variable">text</span>.<span class="cm-variable">toString</span>(), <span class="cm-variable">token</span>.<span class="cm-variable">toString</span>());</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//展示，向WindowManager添加View</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mPresenter</span>.<span class="cm-variable">show</span>(<span class="cm-variable">mToast</span>.<span class="cm-variable">getView</span>(), <span class="cm-variable">token</span>, <span class="cm-variable">windowToken</span>, <span class="cm-variable">duration</span>, <span class="cm-variable">mToast</span>.<span class="cm-variable">getGravity</span>(),</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mToast</span>.<span class="cm-variable">getXOffset</span>(), <span class="cm-variable">mToast</span>.<span class="cm-variable">getYOffset</span>(), <span class="cm-variable">mToast</span>.<span class="cm-variable">getHorizontalMargin</span>(),</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mToast</span>.<span class="cm-variable">getVerticalMargin</span>(), <span class="cm-variable">mCallback</span>, <span class="cm-variable">mToast</span>.<span class="cm-variable">hasCustomAnimation</span>());</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  };</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">ToastPresenter</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-def">show</span>(<span class="cm-variable">View</span> <span class="cm-variable">view</span>, <span class="cm-variable">IBinder</span> <span class="cm-variable">token</span>, <span class="cm-variable">IBinder</span> <span class="cm-variable">windowToken</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">duration</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">gravity</span>,</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">int</span> <span class="cm-variable">xOffset</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">yOffset</span>, <span class="cm-keyword">float</span> <span class="cm-variable">horizontalMargin</span>, <span class="cm-keyword">float</span> <span class="cm-variable">verticalMargin</span>,</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-meta">@Nullable</span> <span class="cm-variable">ITransientNotificationCallback</span> <span class="cm-variable">callback</span>, <span class="cm-variable-3">boolean</span> <span class="cm-variable">removeWindowAnimations</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mView</span> <span class="cm-operator">=</span> <span class="cm-variable">view</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mToken</span> <span class="cm-operator">=</span> <span class="cm-variable">token</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">//设置LayoutParams，设置LayoutParams为windowToken，以及其他布局相关信息</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">adjustLayoutParams</span>(<span class="cm-variable">mParams</span>, <span class="cm-variable">windowToken</span>, <span class="cm-variable">duration</span>, <span class="cm-variable">gravity</span>, <span class="cm-variable">xOffset</span>, <span class="cm-variable">yOffset</span>,</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">horizontalMargin</span>, <span class="cm-variable">verticalMargin</span>, <span class="cm-variable">removeWindowAnimations</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//向WindowManager添加view</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">addToastView</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">trySendAccessibilityEvent</span>(<span class="cm-variable">mView</span>, <span class="cm-variable">mPackageName</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">callback</span> <span class="cm-operator">!=</span> <span class="cm-atom">null</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">try</span> {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">callback</span>.<span class="cm-variable">onToastShown</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">catch</span> (<span class="cm-variable">RemoteException</span> <span class="cm-variable">e</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Log</span>.<span class="cm-variable">w</span>(<span class="cm-variable">TAG</span>, <span class="cm-string">"Error calling back "</span> <span class="cm-operator">+</span> <span class="cm-variable">mPackageName</span> <span class="cm-operator">+</span> <span class="cm-string">" to notify onToastShow()"</span>, <span class="cm-variable">e</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">//向WindowManager添加view</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span class="cm-variable-3">void</span> <span class="cm-def">addToastView</span>() {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">mView</span>.<span class="cm-variable">getParent</span>() <span class="cm-operator">!=</span> <span class="cm-atom">null</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mWindowManager</span>.<span class="cm-variable">removeView</span>(<span class="cm-variable">mView</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">try</span> {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//添加view</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mWindowManager</span>.<span class="cm-variable">addView</span>(<span class="cm-variable">mView</span>, <span class="cm-variable">mParams</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">catch</span> (<span class="cm-variable">WindowManager</span>.<span class="cm-variable">BadTokenException</span> <span class="cm-variable">e</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre>
    </div>
    </div>
    </div>
    </div>
    </div>
    <div
        style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 1518px;">
    </div>
    <div class="CodeMirror-gutters" style="display: none; height: 1518px;"></div>
    </div>
    </div>
    </pre>
    <p><span>这里获取到由</span><code>NotificationManagerService</code><span>产生的具有系统权限的</span><code>token</code><span>。之后将自己的视图添加上去。</span>
    </p>
    <p><span>展示完毕就是取消了，这里也是调用到了</span><code>ToastUI</code><span>。</span></p>
    <p><strong><span>取消</span></strong></p>
    <pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"
        style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre>
    </div>
    <div class="CodeMirror-measure"></div>
    <div style="position: relative; z-index: 1;"></div>
    <div class="CodeMirror-code" role="presentation" style="">
        <div class="CodeMirror-activeline" style="position: relative;">
            <div class="CodeMirror-activeline-background CodeMirror-linebackground"></div>
            <div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div>
            <pre class=" CodeMirror-line "
                role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span class="cm-variable-3">void</span> <span class="cm-def">scheduleDurationReachedLocked</span>(<span class="cm-variable">ToastRecord</span> <span class="cm-variable">r</span>, <span class="cm-variable-3">boolean</span> <span class="cm-variable">lastToastWasTextRecord</span>)</span></pre>
        </div>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mHandler</span>.<span class="cm-variable">removeCallbacksAndMessages</span>(<span class="cm-variable">r</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Message</span> <span class="cm-variable">m</span> <span class="cm-operator">=</span> <span class="cm-variable">Message</span>.<span class="cm-variable">obtain</span>(<span class="cm-variable">mHandler</span>, <span class="cm-variable">MESSAGE_DURATION_REACHED</span>, <span class="cm-variable">r</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">int</span> <span class="cm-variable">delay</span> <span class="cm-operator">=</span> <span class="cm-variable">r</span>.<span class="cm-variable">getDuration</span>() <span class="cm-operator">==</span> <span class="cm-variable">Toast</span>.<span class="cm-variable">LENGTH_LONG</span> <span class="cm-operator">?</span> <span class="cm-variable">LONG_DELAY</span> : <span class="cm-variable">SHORT_DELAY</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//根据延迟时间，通过handler延迟发送取消操作。</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">mHandler</span>.<span class="cm-variable">sendMessageDelayed</span>(<span class="cm-variable">m</span>, <span class="cm-variable">delay</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">case</span> <span class="cm-variable">MESSAGE_DURATION_REACHED</span>:</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">//进行取消调用</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">handleDurationReached</span>((<span class="cm-variable">ToastRecord</span>) <span class="cm-variable">msg</span>.<span class="cm-variable">obj</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">break</span>;</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span class="cm-variable-3">void</span> <span class="cm-def">handleDurationReached</span>(<span class="cm-variable">ToastRecord</span> <span class="cm-variable">record</span>)</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">synchronized</span> (<span class="cm-variable">mToastQueue</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">int</span> <span class="cm-variable">index</span> <span class="cm-operator">=</span> <span class="cm-variable">indexOfToastLocked</span>(<span class="cm-variable">record</span>.<span class="cm-variable">pkg</span>, <span class="cm-variable">record</span>.<span class="cm-variable">token</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">index</span> <span class="cm-operator">&gt;=</span> <span class="cm-number">0</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//真正的取消</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">cancelToastLocked</span>(<span class="cm-variable">index</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable-3">void</span> <span class="cm-def">cancelToastLocked</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">index</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">ToastRecord</span> <span class="cm-variable">record</span> <span class="cm-operator">=</span> <span class="cm-variable">mToastQueue</span>.<span class="cm-variable">get</span>(<span class="cm-variable">index</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//依旧是调用到了ToastUI，然后进行的hideToast，这里不再进行分析。</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">record</span>.<span class="cm-variable">hide</span>();</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//接下来会将当前的ToastRecord移除队列、删除分配的token。</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  ...</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  <span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">if</span> (<span class="cm-variable">mToastQueue</span>.<span class="cm-variable">size</span>() <span class="cm-operator">&gt;</span> <span class="cm-number">0</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 继续展示下一个</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">showNextToastLocked</span>(<span class="cm-variable">lastToast</span> <span class="cm-keyword">instanceof</span> <span class="cm-variable">TextToastRecord</span>);</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span></span></pre>
    </div>
    </div>
    </div>
    </div>
    </div>
    <div
        style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 814px;">
    </div>
    <div class="CodeMirror-gutters" style="display: none; height: 814px;"></div>
    </div>
    </div>
    </pre>
    <p><span>以上就是</span><code>SDK31</code><span>整个</span><code>toast</code><span>的调用流程了。</span></p>
    <p><span>接下来看一看，文章开头的问题：</span></p>
    <ol start=''>
        <li>
            <p><span>想在子线程调用</span><code>toast</code><span>应该怎么处理？</span></p>
            <p><span>需要在子线程创建Looper，然后调用Toast才可以展示。</span></p>
        </li>
        <li>
            <p><code>toast</code><span>的</span><code>window</code><span>是什么，为什么回到桌面依旧会显示呢？</span></p>
            <p><span>通过在</span><code>NotificationManagerService</code><span>分配的</span><code>token</code><span>，类型为系统级，故创建了系统级的窗口，用于展示。</span>
            </p>
        </li>
    </ol>
    <p>&nbsp;</p>
    <p><span>接下来封装一个可以在任何线程调用的</span><code>Toast</code><span>工具类吧！</span></p>
    <pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="kotlin"
        style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="kotlin"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre>
    </div>
    <div class="CodeMirror-measure"></div>
    <div style="position: relative; z-index: 1;"></div>
    <div class="CodeMirror-code" role="presentation" style="">
        <div class="CodeMirror-activeline" style="position: relative;">
            <div class="CodeMirror-activeline-background CodeMirror-linebackground"></div>
            <div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div>
            <pre class=" CodeMirror-line "
                role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">/**</span></span></pre>
        </div>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-comment">* pumpkin</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-comment">* 封装，可以在任何线程使用的toast</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-comment">*/</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">object</span> <span class="cm-def">ToastUtil</span> {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">/**</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* toastShort</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">*/</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">fun</span> <span class="cm-def">toastShort</span>(<span class="cm-variable">str</span>: <span class="cm-variable-3">String</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">toast</span>(<span class="cm-variable">str</span>, <span class="cm-variable">Toast</span>.<span class="cm-variable">LENGTH_SHORT</span>)</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">/**</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* toastLong</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">*/</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">fun</span> <span class="cm-def">toastLong</span>(<span class="cm-variable">str</span>: <span class="cm-variable-3">String</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">toast</span>(<span class="cm-variable">str</span>, <span class="cm-variable">Toast</span>.<span class="cm-variable">LENGTH_LONG</span>)</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">/**</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* 可以在任何线程toast</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">*/</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span class="cm-keyword">fun</span> <span class="cm-def">toast</span>(<span class="cm-variable">str</span>: <span class="cm-variable-3">String</span>, <span class="cm-variable">duration</span>: <span class="cm-variable">Int</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">var</span> <span class="cm-def">myLooper</span>: <span class="cm-variable">Looper</span><span class="cm-operator">?</span> <span class="cm-operator">=</span> <span class="cm-atom">null</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">Looper</span>.<span class="cm-variable">myLooper</span>() <span class="cm-operator">==</span> <span class="cm-atom">null</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Looper</span>.<span class="cm-variable">prepare</span>()</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">myLooper</span> <span class="cm-operator">=</span> <span class="cm-variable">Looper</span>.<span class="cm-variable">myLooper</span>()</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">//注意：这里的AppUtil.application，换成自己的application</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Toast</span>.<span class="cm-variable">makeText</span>(<span class="cm-variable">AppUtil</span>.<span class="cm-variable">application</span>, <span class="cm-variable">str</span>, <span class="cm-variable">duration</span>).<span class="cm-variable">show</span>()</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">myLooper</span> <span class="cm-operator">!=</span> <span class="cm-atom">null</span>) {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Looper</span>.<span class="cm-variable">loop</span>()</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//直接结束掉循环，防止内存泄漏</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">myLooper</span>.<span class="cm-variable">quit</span>()</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//使用</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">binding</span>.<span class="cm-variable">btToast</span>.<span class="cm-variable">setOnClickListener</span> {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">ToastUtil</span>.<span class="cm-variable">toastShort</span>(<span class="cm-string">"主线程toast！！！"</span>)</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable-3">Thread</span> {</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//异步toast</span></span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">ToastUtil</span>.<span class="cm-variable">toastShort</span>(<span class="cm-string">"异步线程toast！！！线程名字：${Thread.currentThread().name}"</span>)</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }.<span class="cm-variable">start</span>()</span></pre>
        <pre class=" CodeMirror-line "
            role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre>
    </div>
    </div>
    </div>
    </div>
    </div>
    <div
        style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 990px;">
    </div>
    <div class="CodeMirror-gutters" style="display: none; height: 990px;"></div>
    </div>
    </div>
    </pre>
    <p><strong><span>结束</span></strong></p>
    </div>
</body>

</html>